#### 上海复旦微电子股份有限公司设计文件上海复旦微电子股份有限公司设计文件上海复旦微电子股份有限公司设计文件上海复旦微电子股份有限公司设计文件

上海复旦微电子股份有限公司上海复旦微电子股份有限公司上海复旦微电子股份有限公司上海复旦微电子股份有限公司

中国中国中国中国 上海上海上海上海


## FMCOS 2.0 目录目录目录目录 .........................................................................................................

## FMCOS 2.0 目录目录目录目录







- FMCOS 2.0 目录目录目录目录 .........................................................................................................
- 1. FMCOS 简介简介简介简介 ..........................................................................................................
- 1.1. FMCOS 特点.................................................................................................................................
- 1.2. FMCOS V2.0 内部结构................................................................................................................
   - 1.2.1. CPU 及加密逻辑....................................................................................................................
   - 1.2.2. RAM........................................................................................................................................
   - 1.2.3. ROM........................................................................................................................................
   - 1.2.4. EEPROM.................................................................................................................................
- 1.3. 功能模块.....................................................................................................................................
- 1.4. 命令列表.....................................................................................................................................
- 2. 初始化和防冲突初始化和防冲突初始化和防冲突初始化和防冲突 ...................................................................................................
- 2.1. 轮询.............................................................................................................................................
- 2.2. 类型A-初始化和防冲突............................................................................................................
   - 2.2.1. 帧格式和时序.......................................................................................................................
   - 2.2.2. PICC 状态.............................................................................................................................
   - 2.2.3. 命令集...................................................................................................................................
   - 2.2.4. 选择序列...............................................................................................................................
- 3. 传输协议传输协议传输协议传输协议 ...............................................................................................................
- 3.1. 类型A PICC 的协议激活...........................................................................................................
   - 3.1.1. 选择应答请求.......................................................................................................................
   - 3.1.2. 选择应答...............................................................................................................................
   - 3.1.3. 协议和参数选择请求...........................................................................................................
   - 3.1.4. 协议和参数选择响应...........................................................................................................
   - 3.1.5. 差错检测和恢复...................................................................................................................
- 3.2. 半双工块传输协议.....................................................................................................................
   - 3.2.1. 块格式...................................................................................................................................
   - 3.2.2. 帧等待时间（FWT ）...........................................................................................................
   - 3.2.3. 帧等待时间扩展...................................................................................................................
   - 3.2.4. 功率水平指示.......................................................................................................................
   - 3.2.5. 协议操作...............................................................................................................................
- 3.3. 类型A PICC 的协议停活...........................................................................................................
   - 3.3.1. 停活帧等待时间...................................................................................................................
   - 3.3.2. 差错检测和恢复...................................................................................................................
- 4. FMCOS 文件结构文件结构文件结构文件结构 ...............................................................................................
- 4.1. 文件结构.....................................................................................................................................
   - 4.1.1. MF 文件................................................................................................................................
   - 4.1.2. DF 文件.................................................................................................................................
   - 4.1.3. EF 文件.................................................................................................................................
- 4.2. 文件空间结构.............................................................................................................................
- 4.3. 文件访问方式.............................................................................................................................
- 4.4. 文件类型及命令集.....................................................................................................................
- 4.5. 文件标识符与文件名称.............................................................................................................
- 5. FMCOS 独特的安全体系独特的安全体系独特的安全体系独特的安全体系 ...................................................................................
- 5.1. 安全状态.....................................................................................................................................
- 5.2. 安全属性.....................................................................................................................................
- 5.3. 安全机制.....................................................................................................................................
- 5.4. 密码算法.....................................................................................................................................
- 6. 命令与应答命令与应答命令与应答命令与应答 ...........................................................................................................
- 6.1. 命令与应答结构.........................................................................................................................
- 6.2. 状态字SW1、SW2 的意义.......................................................................................................
- 7. FMCOS 命令命令命令命令 ........................................................................................................
- 7.1. 外部认证EXTERNAL AUTHENTICATE
   - 7.1.1. 定义和范围...........................................................................................................................
   - 7.1.2. 命令报文...............................................................................................................................
   - 7.1.3. 命令报文数据域...................................................................................................................
   - 7.1.4. 响应报文数据域...................................................................................................................
   - 7.1.5. 响应报文状态码...................................................................................................................
- 7.2. 取随机数GET CHALLENGE
   - 7.2.1. 定义和范围...........................................................................................................................
   - 7.2.2. 命令报文...............................................................................................................................
   - 7.2.3. 命令报文数据域...................................................................................................................
   - 7.2.4. 响应报文数据域...................................................................................................................
   - 7.2.5. 响应报文状态码...................................................................................................................
- 7.3. 内部认证INTERNAL AUTHENTICATE
   - 7.3.1. 定义和范围...........................................................................................................................
   - 7.3.2. 命令报文...............................................................................................................................
   - 7.3.3. 命令报文数据域...................................................................................................................
   - 7.3.4. 响应报文数据域...................................................................................................................
   - 7.3.5. 响应报文状态码...................................................................................................................
- 7.4. 选择文件SELECT......................................................................................................................
   - 7.4.1. 定义和范围...........................................................................................................................
   - 7.4.2. 命令报文...............................................................................................................................
   - 7.4.3. 命令报文数据域...................................................................................................................
   - 7.4.4. 响应报文数据域...................................................................................................................
   - 7.4.5. 响应报文状态码...................................................................................................................
- 7.5. 读二进制文件READ BINARY..................................................................................................
   - 7.5.1. 定义和范围...........................................................................................................................
   - 7.5.2. 命令报文...............................................................................................................................
   - 7.5.3. 命令报文数据域...................................................................................................................
   - 7.5.4. 响应报文数据域...................................................................................................................
   - 7.5.5. 响应报文状态码...................................................................................................................
- 7.6. 读记录文件READ RECORD.....................................................................................................
   - 7.6.1. 定义和范围...........................................................................................................................
   - 7.6.2. 命令报文...............................................................................................................................
   - 7.6.3. 命令报文数据域...................................................................................................................
   - 7.6.4. 响应报文数据域...................................................................................................................
   - 7.6.5. 响应报文状态码...................................................................................................................
- 7.7. 写二进制文件UPDATE BINARY
   - 7.7.1. 定义和范围...........................................................................................................................
   - 7.7.2. 命令报文...............................................................................................................................
   - 7.7.3. 命令报文数据域...................................................................................................................
   - 7.7.4. 响应报文数据域...................................................................................................................
   - 7.7.5. 响应报文状态码...................................................................................................................
- 7.8. 写记录文件 UPDATE RECORD................................................................................................
   - 7.8.1. 定义和范围...........................................................................................................................
   - 7.8.2. 命令报文...............................................................................................................................
   - 7.8.3. 命令报文数据域...................................................................................................................
   - 7.8.4. 响应报文数据域...................................................................................................................
   - 7.8.5. 响应报文状态码...................................................................................................................
- 7.9. 添加记录文件 APPEND RECORD
   - 7.9.1. 定义和范围...........................................................................................................................
   - 7.9.2. 命令报文...............................................................................................................................
   - 7.9.3. 命令报文数据域...................................................................................................................
   - 7.9.4. 响应报文数据域...................................................................................................................
   - 7.9.5. 响应报文状态码...................................................................................................................
- 7.10. 验证口令VERIFY PIN
   - 7.10.1. 定义和范围.........................................................................................................................
   - 7.10.2. 命令报文.............................................................................................................................
   - 7.10.3. 命令报文数据域.................................................................................................................
   - 7.10.4. 响应报文数据域.................................................................................................................
   - 7.10.5. 响应报文状态码.................................................................................................................
- 7.11. 擦除目录文件 ERASE DF
   - 7.11.1. 定义和范围.........................................................................................................................
   - 7.11.2. 命令报文.............................................................................................................................
   - 7.11.3. 命令报文数据域.................................................................................................................
   - 7.11.4. 响应报文数据域.................................................................................................................
   - 7.11.5. 响应报文状态码.................................................................................................................
- 7.12. 增加或修改密钥 WRITE KEY
   - 7.12.1. 定义和范围.........................................................................................................................
   - 7.12.2. 命令报文.............................................................................................................................
   - 7.12.3. 命令报文数据域.................................................................................................................
   - 7.12.4. 响应报文数据域.................................................................................................................
   - 7.12.5. 响应报文状态码.................................................................................................................
- 7.13. 建立文件 CREATE FILE
   - 7.13.1. 定义和范围.........................................................................................................................
   - 7.13.2. 命令报文.............................................................................................................................
   - 7.13.3. 命令报文数据域.................................................................................................................
   - 7.13.4. 响应报文数据域.................................................................................................................
   - 7.13.5. 响应报文状态码.................................................................................................................
- 8. 中国金融中国金融中国金融中国金融 IC 卡专用卡专用卡专用卡专用命令命令命令命令 ....................................................................................
- 8.1. 卡片锁定CARD BLOCK
   - 8.1.1. 定义和范围...........................................................................................................................
   - 8.1.2. 命令报文...............................................................................................................................
   - 8.1.3. 命令报文数据域...................................................................................................................
   - 8.1.4. 响应报文数据域...................................................................................................................
   - 8.1.5. 响应报文状态码...................................................................................................................
- 8.2. 应用解锁 APPLICATION UNBLOCK
   - 8.2.1. 定义和范围...........................................................................................................................
   - 8.2.2. 命令报文...............................................................................................................................
   - 8.2.3. 命令报文数据域...................................................................................................................
   - 8.2.4. 响应报文数据域...................................................................................................................
   - 8.2.5. 响应报文状态码...................................................................................................................
- 8.3. 应用锁定 APPLICATION BLOCK
   - 8.3.1. 定义和范围...........................................................................................................................
   - 8.3.2. 命令报文...............................................................................................................................
   - 8.3.3. 命令报文数据域...................................................................................................................
   - 8.3.4. 响应报文数据域...................................................................................................................
   - 8.3.5. 响应报文状态码...................................................................................................................
- 8.4. 口令密钥解锁 PIN UNBLOCK
   - 8.4.1. 定义和范围...........................................................................................................................
   - 8.4.2. 命令报文...............................................................................................................................
   - 8.4.3. 命令报文数据域...................................................................................................................
   - 8.4.4. 响应报文数据域...................................................................................................................
   - 8.4.5. 响应报文状态码...................................................................................................................
- 8.5. 重装/修改口令密钥 RELOAD/CHANGE PIN..........................................................................
   - 8.5.1. 定义和范围...........................................................................................................................
   - 8.5.2. 命令报文...............................................................................................................................
   - 8.5.3. 命令报文数据域...................................................................................................................
   - 8.5.4. 响应报文数据域...................................................................................................................
   - 8.5.5. 响应报文状态码...................................................................................................................
- 8.6. 修改口令密钥命令 CHANGE PIN
   - 8.6.1. 修改口令密钥命令定义和范围...........................................................................................
   - 8.6.2. 命令报文...............................................................................................................................
   - 8.6.3. 命令报文数据域...................................................................................................................
   - 8.6.4. 响应报文数据域...................................................................................................................
   - 8.6.5. 响应报文状态码...................................................................................................................
- 8.7. 圈存命令.....................................................................................................................................
   - 8.7.1. 圈存初始化INITIALIZE FOR LOAD
   - 8.7.2. 圈存命令CREDIT FOR LOAD
   - 8.7.3. 圈存交易流程图...................................................................................................................
- 8.8. 消费交易（存折或钱包）.........................................................................................................
   - 8.8.1. 消费初始化INITIALIZE FOR PURCHASE
   - 8.8.2. 消费命令DEBIT FOR CAPP PURCHASE..........................................................................
   - 8.8.3. 消费交易流程图...................................................................................................................
- 8.9. 复合应用消费交易（钱包）.....................................................................................................
   - 8.9.1. 消费初始化INITIALIZE FOR CAPP PURCHASE.............................................................
   - 8.9.2. 更新复合应用数据缓存 UPDATE CAPP DATA CACHE.................................................
   - 8.9.3. 复合应用消费命令DEBIT FOR CAPP PURCHASE
   - 8.9.4. 复合应用消费交易流程图.................................................................................................
- 8.10. 圈提交易（存折）...................................................................................................................
   - 8.10.1. 圈提初始化INITIALIZE FOR UNLOAD
   - 8.10.2. 圈提命令CREDIT FOR UNLOAD..................................................................................
   - 8.10.3. 圈提交易流程图...............................................................................................................
- 8.11. 取现交易（存折）...................................................................................................................
   - 8.11.1. 取现初始化INITIALIZE FOR CASH WITHDRAW.......................................................
   - 8.11.2. 取现命令DEBIT FOR CASH WITHDRAW....................................................................
   - 8.11.3. 取现交易流程图...............................................................................................................
- 8.12. 修改透支限额交易（存折）...................................................................................................
   - 8.12.1. 初始化修改透支限额命令INITIALIZE FOR UPDATE
   - 8.12.2. 修改透支限额命令UPDATE OVERDRAW LIMIT........................................................
   - 8.12.3. 修改透支限额交易流程图...............................................................................................
- 8.13. 取交易认证 GET TRANSACTION PROVE
   - 8.13.1. 定义和范围.......................................................................................................................
   - 8.13.2. 命令报文...........................................................................................................................
   - 8.13.3. 响应报文数据域...............................................................................................................
   - 8.13.4. 响应报文状态码...............................................................................................................
   - 8.13.5. 防拔功能...........................................................................................................................
- 8.14. 读余额 GET BALANCE
   - 8.14.1. 定义和范围.......................................................................................................................
   - 8.14.2. 命令报文...........................................................................................................................
   - 8.14.3. 响应报文数据域...............................................................................................................
   - 8.14.4. 响应报文状态码...............................................................................................................
- 9. 加油卡交易命令加油卡交易命令加油卡交易命令加油卡交易命令 .................................................................................................
- 9.1. 灰锁初始化 INITIALIZE FOR GREY LOCK
   - 9.1.1. 灰锁初始化命令定义和范围.............................................................................................
   - 9.1.2. 命令报文.............................................................................................................................
   - 9.1.3. 命令报文数据域.................................................................................................................
   - 9.1.4. 响应报文数据域.................................................................................................................
- 9.2. 灰锁命令 GREY LOCK
   - 9.2.1. 灰锁命令定义和范围.........................................................................................................
   - 9.2.2. 命令报文.............................................................................................................................
   - 9.2.3. 命令报文数据域.................................................................................................................
   - 9.2.4. 响应报文数据域.................................................................................................................
- 9.3. 解扣命令 DEBIT FOR UNLOCK
   - 9.3.1. 灰锁命令定义和范围.........................................................................................................
   - 9.3.2. 命令报文.............................................................................................................................
   - 9.3.3. 命令报文数据域.................................................................................................................
   - 9.3.4. 响应报文数据域.................................................................................................................
- 9.4. 灰锁初始化 INITIALIZE FOR GREY UNLOCK....................................................................
   - 9.4.1. 灰锁初始化命令定义和范围.............................................................................................
   - 9.4.2. 命令报文.............................................................................................................................
   - 9.4.3. 命令报文数据域.................................................................................................................
   - 9.4.4. 响应报文数据域.................................................................................................................
- 9.5. 灰锁命令 GREY UNLOCK......................................................................................................
   - 9.5.1. 灰锁命令定义和范围.........................................................................................................
   - 9.5.2. 命令报文.............................................................................................................................
   - 9.5.3. 命令报文数据域.................................................................................................................
   - 9.5.4. 响应报文数据域.................................................................................................................
- 10. FMCOS 内部测试命令内部测试命令内部测试命令内部测试命令 ...................................................................................
- 10.1. 计算程序ROM CRC 命令CALCULATE ROM CRC
   - 10.1.1. 定义和范围.......................................................................................................................
   - 10.1.2. 命令报文...........................................................................................................................
   - 10.1.3. 命令报文数据域...............................................................................................................
   - 10.1.4. 响应报文数据域...............................................................................................................
   - 10.1.5. 响应报文状态码...............................................................................................................
- 11. 安全报文传送安全报文传送安全报文传送安全报文传送 ...................................................................................................
- 11.1. 安全报文传送...........................................................................................................................
- 11.2. 如何实现安全报文传送...........................................................................................................
- 11.3. MAC 的计算.............................................................................................................................
- 11.4. 数据加密/解密的计算..............................................................................................................
   - 11.4.1. 数据加密计算...................................................................................................................
   - 11.4.2. 数据解密计算...................................................................................................................
- 11.5. 安全报文传送的命令情况.......................................................................................................
- 附录附录附录附录 A. 电子存折电子存折电子存折电子存折 / 电子钱包应用的基本数据文件电子钱包应用的基本数据文件电子钱包应用的基本数据文件电子钱包应用的基本数据文件 ..............................................
- 附录附录附录附录 B. 术语和定义术语和定义术语和定义术语和定义 ...............................................................................................
- 附录附录附录附录 C. 协议说明书协议说明书协议说明书协议说明书 ...............................................................................................
- C.1. 记法...........................................................................................................................................
- C.2. 无差错操作...............................................................................................................................
   - C.2.1. 块的交换............................................................................................................................
   - C.2.2. 等待时间扩展请求............................................................................................................
   - C.2.3. DESELECT
   - C.2.4. 链接....................................................................................................................................
- C.3. 差错处理...................................................................................................................................
   - C.3.1. 块的交换............................................................................................................................
   - C.3.2. 等待时间扩展请求............................................................................................................
   - C.3.3. DESELECT
   - C.3.4. 链接....................................................................................................................................


## 1. FMCOS 简介简介简介简介 ..........................................................................................................

#### 由于CPU 卡具有很高的安全性及一张卡支持多种应用的特点，所以IC 卡家族中的

#### CPU 卡的使用范围正日益扩大。类似一台计算机，CPU 卡内也有CPU 、存储器和输入、

#### 输出接口，所以在应用中CPU 卡也必然需要操作系统。上海复旦微电子股份有限公司成功

地开发了自主版权的CPU 卡操作系统--FMCOS（FMSH Card Operating System ），该操作系
统符合ISO 7816 系列标准及《中国金融集成电路（IC ）卡规范》，适用于保险、医疗保健、
社会保障、公共事业收费、安全控制、证件、交通运输等诸多应用领域,特别是在金融领域。
FMCOS 详细规定了电子钱包、电子存折和磁条卡功能（Easy Entry）三种基本应用。

**1.1. FMCOS** 特点特点特点特点

 支持Single DES 、Triple DES 算法：可自动根据密钥的长度选择Single DES 、Triple DES
算法
 支持线路加密、线路保护功能：防止通信数据被非法窃取或篡改
 支持在一张卡上实现多个不同的应用：可建立三级目录
 支持电子钱包功能：钱包大小可由用户自行设定
 支持多种文件类型：包括二进制文件、定长记录文件、变长记录文件、循环文件、钱
包文件
 支持ISO14443-4：T=CL 通讯协议
 满足银行标准：符合《中国金融集成电路（IC ）卡规范》电子钱包/存折规范。
 防插拔功能：交易处理过程中非正常拔出的卡片自动恢复

**1.2. FMCOS V2.0** 内部结构内部结构内部结构内部结构

```
CPU RAM
加密逻辑加密逻辑加密逻辑加密逻辑 ROM
RF 接口接口接口接口 EEPROM
```
### 1.2.1. CPU 及加密逻辑....................................................................................................................

#### 保证EEPROM 中数据安全，使外界不能用任何非法手段获取EEPROM 中的数据。

### 1.2.2. RAM........................................................................................................................................

#### FMCOS 工作时存放命令参数、返回结果、安全状态及临时工作密钥的区域。

### 1.2.3. ROM........................................................................................................................................

#### 存放FMCOS 程序的区域。

### 1.2.4. EEPROM.................................................................................................................................

#### 存放用户应用数据区域，FMCOS 将用户数据以文件形式保存在EEPROM 中，在满足

#### 用互规定的安全条件时，可进行读或写。


**1.3.** 功能模块功能模块功能模块功能模块

```
FMCOS 由传输管理、文件管理、安全体系、命令解释四个功能模块组成。
```
 传输管理：按ISO7816-3、ISO14443-4标准监督卡与终端之间的通信，保证数据正确
地传输，防止卡与终端之间通讯数据被非法窃取和篡改。
 文件管理：将用户数据以文件形式存储在EEPROM 中，保证访问文件时快速性和数
据安全性。
 安全体系：安全体系是FMCOS 的核心部分，它涉及到卡的鉴别与核实，对文件访问
时的权限控制机制。
 命令解释：根据接收到的命令检查各项参数是否正确，执行相应的操作。


**1.4.** 命令列表命令列表命令列表命令列表

```
表表表表 1.1 FMCOS 2.0 命令表命令表命令表命令表
编号编号编号编号 指令指令指令指令 指令类别指令类别指令类别指令类别 指令码指令码指令码指令码 功能描述功能描述功能描述功能描述 兼容性兼容性兼容性兼容性
VERIFY 00 20 验证口令 ISO&PBOC
EXTERNAL
AUTHENTICATE
```
(^00 82) 外部认证 ISO&PBOC
(^) GET CHALLENGE 00 84 取随机数 ISO&PBOC
(^) INTERNAL AUTHENTICATE 00 88 内部认证 ISO&PBOC
SELECT 00 A4 选择文件 ISO&PBOC
(^) READ BINARY 00 B0 读二进制文件 ISO&PBOC
READ RECORD 00 B2 读记录文件 ISO&PBOC
GET RESPONSE 00 C0 取响应数据 ISO&PBOC
(^) UPDATE BINARY 00/04 D6/D0 写二进制文件 ISO&PBOC
(^) UPDATE RECORD 00/04 DC/D2 写记录文件 ISO&PBOC
(^) CARD BLOCK 84 16 卡片锁定 PBOC
(^) APPLICATION UNBLOCK 84 18 应用解锁 PBOC
APPLICATION BLOCK 84 1E 应用锁定 PBOC
PIN UNBLOCK 80/84 (^24) 个人密码解锁 PBOC
(^) UNBLOCK 80 2C 解锁被锁住的口令 PBOC
INITIALIZE 80 50 初始化交易 PBOC/建设部
(^) CREDIT FOR LOAD 80 52 圈存 PBOC
DEBIT FOR
PURCHASE/CASE
WITHDRAW/UNLOAD
(^80 54) 消费/取现/圈提 PBOC

#### UPDATE OVERDRAW

#### LIMIT

#### 80 58 修改透支限额 PBOC

#### GET TRANSCATION PROVE 80 5A 取交易认证 PBOC/建设部

(^) GET BALANCE 80 5C 读余额 PBOC
(^) RELOAD/CHANGE PIN 80 5E 重装/修改个人密码 PBOC
(^) ERASE DF 80 0E 擦除 DF 专有
(^) PULL 80 30 专用消费 建设部
CHARGE 80 32 专用充值 建设部
WRITE KEY 80/84 D4 增加或修改密钥 专有
(^) CREATE 80 E0 建立文件 专有
(^) WRITE EEPROM 00 00 写数据EEPROM 生产测试
(^) READ EEPROM 00 04 读数据EEPROM 生产测试
INITIAL EEPROM 00 02 初始化EEPROM 生产测试
(^) READ ROM 00 0C 读程序ROM 生产测试


## 2. 初始化和防冲突初始化和防冲突初始化和防冲突初始化和防冲突 ...................................................................................................

**2.1.** 轮询轮询轮询轮询

为了检测到工作场内PICC ，PCD 发送重复的请求命令。PCD 应以任何序列发送在此
描述的REQA 和REQB ，另外，也可以发送附录C中描述的其他命令。

当PICC 暴露于未调制的工作场内（见ISO/IEO 14443-2），它应能在5ms 内接收一个
请求。

举例一：当类型A PICC 接收到任何类型B命令时，它应能在5ms 内接受一个未调制
工作场的REQA 。

举例二：当类型B PICC 接收到任何类型A命令时，它应能在5ms 内接受一个未调制
工作场的REQB 。

**2.2.** 类型类型类型类型 **A-** 初始化和防冲突初始化和防冲突初始化和防冲突初始化和防冲突

本章描述了适用于类型A PICC 的初始化和比特冲突检测协议。
当至少两个PICC 同时传输带有一个或多个比特位置（该位置内至少又两个PICC 在传
输补充值）的比特模式时，PCD 会检测到冲突。在这种情况下，比特模式合并，并且在整
个（100% ）位持续时间内载波以负载波进行调制（见ISO/IEC 14443-2）.

帧格式和时序
本节定义了通信初始化和防冲突器件使用的帧格式和定时。关于比特表示和编码，参
考ISO/IEC 14443-2。

### 2.2.1. 帧格式和时序.......................................................................................................................

#### 本节定义了通信初始化和防冲突期间使用的帧格式和定时。关于比特表示和编码，参

#### 考ISO/IEC 14443-2。

#### 帧应成对传送，PCD 到PICC 后随PICC 到PCD ，使用下列的序列：

#### ——PCD 帧

#### ——PCD 通信开始

#### ——信息和根据需要PCD 传送的差错检测位

#### ——PCD 通信结束

#### ——PCD 到PICC 的帧延迟时间

#### ——PICC 帧

#### ——PICC 通信开始

#### ——信息和根据需要PICC 传送的差错检测位

#### ——PICC 通信结束

#### ——PICC 到PCD 的帧延迟时间

#### PCD 到PICC 的帧延迟时间（FDT ）与PCD 通信结束重迭。


#### 2.2.1.1. 帧延迟时间帧延迟时间帧延迟时间帧延迟时间

#### 帧延迟时间（TDT ）定义为在相反方向上所发送的两个帧之间的时间。

#### 2.2.1.2. PCD 到到到到 PICC 的帧延迟时间的帧延迟时间的帧延迟时间的帧延迟时间

#### PCD 所发送的最后一个暂停的结束与PICC 所发送的起始位范围内的第一个调制边沿

之间的时间，它应遵守图2-1中定义的定时，此处n为一整数值

```
128/fc 256/fc 128/fc
```
```
128/fc 256/fc 128/fc
```
```
( *128+84)/fc n
```
```
PCD 传输的最后数据位 PICC 初调制
```
```
逻辑“1”通信结束(E)通信开始(S)
```
```
逻辑“0”通信结束(E)通信开始(S)
```
```
( *128+84)/fc n
```
#### 图图图图 2-1 ：：：： PICC 到到到到 PCD 的帧延迟时间的帧延迟时间的帧延迟时间的帧延迟时间

表2.1 定义了n和依赖于命令类型的FDT 的值以及这一命令中最后发送的数据位的逻辑状
态。

注：值=8 意味着场中所有的PICC 应以防冲突所需的同步方式进行响应。
对于所有的其他命令，PICC 应确保其视为范围内的第一个调制边沿与图2-1中定义的
位格对齐。

**2.2.1.3. PICC** 到到到到 **PCD** 的帧延迟时间的帧延迟时间的帧延迟时间的帧延迟时间

PICC 所发送的最后一个调制与 PCD 所发送的第一个暂停之间的时间，它应至少为
1172/fc。

#### 表表表表 2.1 PICC 到到到到 PCD 的帧延迟时间的帧延迟时间的帧延迟时间的帧延迟时间

#### 命令类型命令类型命令类型命令类型 N （（（整数值（整数值整数值整数值）））） FDT

```
最后一位=(1)b 最后一位=(0)b
REQA 命令
WAKE-UP 命令
ANTICOLLISION 命令
SELECT 命令
```
```
9 1236/fc 1172/fc
```
```
所有其他命令 ≥ 9 (n*128+84)/fc (n*128+20)/fc
```

#### 2.2.1.4. 请求保护时间请求保护时间请求保护时间请求保护时间

```
请求保护时间定义为两个连续请求命令的起始位间的最小时间。它的值为7000/fc。
```
**2.2.1.5.** 帧格式帧格式帧格式帧格式

```
定义了下列帧类型：
——用于表2.2 种定义命令的短帧
——用于普通命令的标准帧
——面向比特防冲突命令的防冲突帧
```
**2.2.1.6.** 短帧短帧短帧短帧

```
短帧用于初始化通信，并按以下次序组成：
——通信开始；
——LSB 先传输的 7 个数据位（编码见表2.2 ）；
——通信结束。
不加奇偶校验位。
```
```
S 0 1 1 0 0 1 0 E
```
```
LSB MSB
```
```
‘26’
传输的首位传输的首位传输的首位传输的首位
```
```
↑↑↑↑
```
#### 图图图图 2-

#### 2.2.1.7. 标准帧标准帧标准帧标准帧

#### 标准帧用于数据交换，并按以下次序组成：

#### ——通信开始；

——n*（ 8 个数据位+奇数奇偶校验位），n≥ 1 。每个字节的LSB 首先被发送。每个字
节后面跟一个奇数奇偶校验位。奇偶校验位P被设置，使在（b1 到b8 。P）中1s 的数目为
奇数；

```
——通信结束。
```
```
S b1 b2 b3 b4 b5 b6 b7 b8 P b1 b2 b3 b6 b7 b8 P b1 b8 P E
↑↑↑↑↑↑↑↑ ↑↑↑↑
```
```
n*(8 data bits + odd parity bit)
LSB
```
```
最先传输位最先传输位最先传输位最先传输位
```
```
第第第第 n 字节字节字节字节
奇偶位奇偶位奇偶位奇偶位 传输结束传输结束传输结束传输结束
```
```
第一字节第一字节第一字节第一字节 第二字节第二字节第二字节第二字节
```
```
图图图图 2-
```
**2.2.1.8.** 面向比特的防冲突帧面向比特的防冲突帧面向比特的防冲突帧面向比特的防冲突帧

当至少两个PICC 发送不同比特模式到PCD 时可检测到冲突。这种情况下，至少一个
比特的整个位持续时间内，载波以副载波进行调制。

面向比特的防冲突帧仅在比特帧防冲突环期间使用，并且事实上该帧是带有 7 个数据
字节的标准帧，他被分离成两部分：第 1 部分用于从PCD 到PICC 的传输，第 2 部分用于
从PICC 到PCD 的传输。

```
下列规则应适用于第 1 部分和第 2 部分的长度：
```

#### 第 1 部分的最后数据位之后不加奇偶校验位。

#### 下面全字节情况和分离字节情况的例子定义了位的组织结构和位传输的次序。

```
S 1 0 0 0 0 0 1 E
```
```
S 1 0 0 0 E
↑↑↑↑
S 0 0 1 E
↑↑↑↑
最先传输位最先传输位最先传输位最先传输位
```
```
11010101 10110011 00100010
```
```
最先传输位最先传输位最先传输位最先传输位
```
```
防冲突帧防冲突帧防冲突帧防冲突帧，，，，第一部分第一部分第一部分第一部分：：：： PCD 到到到到 PICC
```
```
防冲突帧防冲突帧防冲突帧防冲突帧，，，第二部分，第二部分第二部分第二部分：：：： PICC 到到到到 PCD
```
```
"AB" "CD" "44"
```
```
11001001 00000010 01001100 00001000
```
```
↓↓↓↓
```
```
"93" "40" "32" "10"
```
```
SEL NVB UID0 UID1 UID2 UID3 BCC
00001000 11010101 10110011 00100010
```
```
标准帧标准帧标准帧标准帧，，，第四个完整字节后分开，第四个完整字节后分开第四个完整字节后分开第四个完整字节后分开
```
```
11001001 00000010 01001100
```
#### 图图图图 2-4 面向比特的防冲突帧的比特组织结构和传输面向比特的防冲突帧的比特组织结构和传输面向比特的防冲突帧的比特组织结构和传输面向比特的防冲突帧的比特组织结构和传输，，，，完整字节完整字节完整字节完整字节

```
S 1 0 0 0 0 0 1 E
```
```
S 1 0 E
↑↑↑↑
S x 0 0 0 1 E
↑↑↑↑
```
```
"CD" "44"
```
```
11010101 10110011 00100010
```
```
"93" "25" "10"
```
```
SEL NVB UID1 UID
"AB"
```
```
UID3 BCC
00001000 11010101 10110011 00100010
```
```
标准帧标准帧标准帧标准帧，，，，第四个完整字节后分开第四个完整字节后分开第四个完整字节后分开第四个完整字节后分开
```
```
11001001 10100100 01001 110
```
```
UID
"32"
```
```
↓↓↓↓
```
```
01001
```
```
最先传输位最先传输位最先传输位最先传输位
```
```
100
```
```
防冲突帧防冲突帧防冲突帧防冲突帧，，，，第二部分第二部分第二部分第二部分：：：： PICC 到到到到 PCD
```
```
防冲突帧防冲突帧防冲突帧防冲突帧，，，，第一部分第一部分第一部分第一部分：：：： PCD 到到到到 PICC
```
```
最先传输位最先传输位最先传输位最先传输位
```
```
11001001 00000010
```
```
00001000
```
#### 图图图图 2-5 面向比特的防冲突帧的比特组织结构和传输面向比特的防冲突帧的比特组织结构和传输面向比特的防冲突帧的比特组织结构和传输面向比特的防冲突帧的比特组织结构和传输，，，，分离字节分离字节分离字节分离字节

#### 对于SPLIT BYTE ，PCD 应忽略第二部分的第一个奇偶校验位。

#### 2.2.1.9. CRC_A

CRC_A 帧是k数据位的一个功能，由帧内除奇偶校验位外的所有数据位、S和E以及
CRC_A 本身组成。由于数据以字节编码，因此位数k是 8 的倍数。对于差错检测，在标准
帧中发送两个CRC_A 字节，它在字节之后，E之前。CRC_A 如ISO/IEC 13239 中定义，
但初始寄存器内容应为‘ 6363 ’

```
举例参见附录D
```
### 2.2.2. PICC 状态.............................................................................................................................

#### 下列各部分提供了专门针对比特冲突检测协议的类型A的PICC 状态的描述。

#### 下列状态图考虑了ISO/IEC 14443 本部分命令引起的所有可能的状态转换。

#### PICC 重复使接受帧有效。当检测到传输差错时不发送相应。

#### 下列符号用于图2-6示出的状态图


```
READY
State
```
```
ACTIVE
State
```
```
IDLE
State
```
```
Power OFF
```
```
ACTIVE*
State
```
```
READY*
State
```
```
HALT
State
```
```
ISO/IEC 14443-
```
```
Reset
```
```
REQA, WUPA
```
```
SELECT SELECT
```
```
WUPA
```
```
REQA,
WUPA,
AC,
nAC,
SELECT,
nSELECT,
Error
```
```
REQA,
WUPA,
nAC,
nSELECT,
HLTA
Error
REQA,
WUPA,
AC,
nAC,
SELECT,
nSELECT,
Error
```
```
REQA,
WUPA,
nAC,
nSELECT,
HLTA,
Error
```
```
HLTA DESELECT HLTA
```
```
REQA,
AC,
nAC,
SELECT,
nSELECT,
HLTA,
Error
```
```
AC AC
```
```
AC,
nAC,
SELECT,
nSELECT,
HLTA,
Error
```
```
Enter
ISO/IEC 14443-
```
#### 图图图图 2-6 类型类型类型类型 A PICC 状态图状态图状态图状态图

#### 与ISO/IEC 14443-3兼容但不使用ISO/IEC 14443-4的PICC 可以通过专有命令来设置

#### ACTIVE 或ACTIVE*状态。

#### 在IDLE 状态中，PICC 被加电。它听从命令并能识别REQA 和WUPA 命令

#### 状态跳出条件和转换：

#### 在接受到有效的REQA 或WUPA 命令后，PICC 进入READY 状态并发送其ATQA 。

#### 2.2.2.1. READY 状态状态状态状态

#### 描述：在READY 状态，比特帧防冲突和专有的防冲突方法都可以应用。串联级别在

#### 这一状态内被处理以获取完整的UID 。

#### 2.2.2.2. ACTIVE 状态状态状态状态

#### 描述：在ACTIVE 状态，PICC 听从任何更高层报文。

#### 状态跳出条件和转换：

#### 当接收到有效HALT 命令时，PICC 进入HALT 状态。

```
AC ANTICOLLISION Command （matched UID ）
nAC ANTICOLLISION Command （not matched UID ）
SELECT SELECT Command （matched UID ）
nSELECT SELECT Command （not matched UID ）
DESELECT DESELECT Command，在ISO/IEC 14443-4种定义
Error transmission error detected
```

#### 注：在更高层协议中，可以定义特定命令以使PICC 返回到HALT 状态。

#### 2.2.2.3. HALT 状态状态状态状态

#### 描述：在HALT 状态，PICC 仅相应WUPA 命令。

#### 状态跳出条件和转换：

#### 在接收到有效的WUPA 命令后，PICC 进入READY* 状态并发送其ATQA

#### 2.2.2.4. READY* 状态状态状态状态

#### 描述：READY* 状态类似于READY 状态，比特帧防冲突和专有的防冲突方法都可以

#### 应用。串联级别在这一状态内被处理以获取完整的UID 。

#### 状态跳出条件和转换：

#### 当根据其完整UID 选中它时，PICC 进入ACTIVE*状态。

#### 2.2.2.5. ACTIVE* 状态状态状态状态

#### 描述：ACTIVE*状态类似于ACTIVE 状态，PICC 被选中并听从任何更高层报文。

#### 状态跳出条件和转换：

#### 当接收到有效HALT 命令时，PICC 被选中进入HALT 状态。

### 2.2.3. 命令集...................................................................................................................................

#### PCD 用来管理与几个PICC 的通信命令是：

#### ——REQA ；

#### ——WUPA ；

#### ——ANTICOLLISION ；

#### ——SELECT ；

#### ——HALT ；

#### 这些命令使用上面描述的字节和帧格式。

#### 2.2.3.1. REQA 和和和和 WUPA 命令命令命令命令

#### REQA 和WUPA 命令由PCD 发出，以探测用于类型A PICC 的工作场。它们在一个短

#### 帧内传输。

#### 从图2-6可以看出在这些情况下PICC 实际上必须应答这些相关命令。

#### 在特殊情况下，WUPA 命令由PCD 发出，使已经进入HALT 状态的PICC 回到READY*

#### 状态。它们应当参与进一步的防冲突和选择规程。

#### 表2.2 示出了使用短帧格式的REQA 和WUPA 命令的编码。


#### 2.2.3.2. ANTICOLLISION 命令和命令和命令和命令和 SELECT 命令命令命令命令

#### 这些命令在防冲突环（见图2-4和图2-5）期间使用。ANTICOLLISION 和SELECT

#### 命令由下列内容组成：

#### ——选择代码SEL （ 1 个字节）；

#### ——有效位的数目NVB （ 1 个字节，编码见表2.7）；

——根据NVB 的值，UID CLn 的 0 到 40 个数据位。
SEL 规定了串联级别CLn 。
ANTICOLLSION 命令在面向比特的防冲突帧中传输。
SELECT 命令在标准帧中传输。
由于NVB 没有规定 40 个有效位，因此若PICC 保持在READY 状态或READY*状态
中，命令就被称为ANTICOLLISION 命令。

如果NVB 规定了UID CLn 的 40 个数据位（NVB= “ 70 ”），则应添加CRC_A 。该命
令被称为SELECT 命令。

如果PICC 已发送了完整的UID ，则它从READY 状态转化到ACTIVE 状态或从
READY*状态转换到ACTIVE*状态并在其SAK 响应中指出UID 完整。

否则，PICC 保持在READY 状态或READY*状态中并且该PCD 应以递增串联级别其
同一个新的防冲突环。

**2.2.3.3. HALT** 命令命令命令命令

```
HALT 命令有四个字节组成并应使用标准帧来发送
```
```
↓↓↓↓
S E
```
```
发送第一个位发送第一个位发送第一个位发送第一个位
```
**"50" "00" CRC_A**
图图图图 **2-7 HALT** 命令帧命令帧命令帧命令帧
如果PICC 在HALT帧结束后1ms 周期期间以任何调制表示响应，则该响应应解释为
“不确定”。

### 2.2.4. 选择序列...............................................................................................................................

#### 选择序列的目的是获得来自PICC 的UID 以及选择该PICC 以便进一步通信。

#### 表表表表 2.2 请求帧的编码请求帧的编码请求帧的编码请求帧的编码

```
b7 b6 b5 b4 b3 b2 b1 含义
0 1 0 0 1 1 0 “26”=REQA
1 0 1 0 0 1 0 “52”=WAKE-UP
```
(^0 1 1 0 1 0 1) “35”=任选时间槽方法
1 0 0 X X X X “40” to “4F”=专有的
1 1 1 1 X X X “78” to ”7F”=专有的
所有其他 RFU


#### 2.2.4.1. 选择序列流程表选择序列流程表选择序列流程表选择序列流程表

```
开始
```
```
发送REQA
```
```
接受ATQA
```
```
检查ATQA
选择级别 1
```
```
递增串联级别 执行位帧防冲突环
```
```
检查SAK
```
```
执行ISO/IEC 14443-
指令和协议 特殊指令和协议
```
```
特殊帧和协议
```
```
ISO/IEC 14443-
```
```
特殊防冲突环
```
```
UID符合,
PICC不符合
ISO/IEC 14443-
```
```
ISO/IEC 14443-
```
#### 图图图图 2-8 PCD 的初始化和防冲突的流程图的初始化和防冲突的流程图的初始化和防冲突的流程图的初始化和防冲突的流程图

#### 2.2.4.2. ATQA- 请求应答请求应答请求应答请求应答

#### 在PCD 发送请求命令（REQA ）之后，所有PICC 以其在两个数据字节中编码了可用

#### 防冲突类型的请求应答（ATQA ）表示同步地进行响应。

如果有多个卡应答，冲突可能出现。PCD 应把ATQA 内的冲突解码为一个（ 1 ）b，其
结果是所有ATQA 的逻辑“或”。

```
有关例子在附录C中给出。
```
**2.2.4.2.1. ATQA** 的编码的编码的编码的编码

#### 2.2.4.2.2. 比特帧防冲突的编码规则比特帧防冲突的编码规则比特帧防冲突的编码规则比特帧防冲突的编码规则

```
——规则 1 ：位b7 和b8 编码了UID 长度（单个、两个或三个，见表2.4）；
```
#### 表表表表 2.3 ATQA 的编码的编码的编码的编码

#### MSB LSB

```
b16 b15 b14 b13 b12 b11 b10 b9 b8 b7 b6 b5 b4 b3 b2 b
RFU
```
#### UID 长度

#### 比特帧

#### RFU 比特帧防冲突


——规则 2 ：b1、b2、b3、b4 或b5 中的一个应置为（ 1 ）b以指出比特帧防冲突（见
表2.4）；

```
注：位 9 到 12 指出了附加的和专有的方法。
```
#### 2.2.4.3. 防冲突和选择防冲突和选择防冲突和选择防冲突和选择

#### 2.2.4.3.1. 每个串联级别范围内地防冲突环每个串联级别范围内地防冲突环每个串联级别范围内地防冲突环每个串联级别范围内地防冲突环

#### 下面算法应适用于防冲突环：

#### 步骤 1 ：PCD 为选择的防冲突类型和串联级别分配了带有编码的SEL 。

#### 步骤 2 ：PCD 分配了带有值为‘ 20 ’的NVB 。

注：该值定义了该PCD 将不发送UID CLn 的任何部分。因此该命令迫使工作场内的所有
PICC 以其完整的UID CLn 表示响应。
步骤 3 ：PCD 发送SEL 和NVB
步骤 4 ：工作场内的所有PICC 拥有唯一序列号，那么，如果一个以上的PICC 响应，则冲
突发生。如果没有冲突发生，则步骤 6 到步骤 10 可被跳过。
步骤 6 ：PCD 应识别除第一个冲突的位置。
步骤 7 ：PCD 分配了带有值的NVB ，该值规定了UID CLn 有效比特数。这些有效位应是
PCD 所决定的冲突发生之前的被接受到的UID CLn 的一部分再加上（ 0 ）b或（ 1 ）b。典
型的是实现是增加（ 1 ）b。
步骤 8 ：PCD 发送SEL 和NVB ，后随有效位本身。
步骤 9 ：只有PICC 的UID CLn 中的一部分等于PCD 所发送的有效位时，PICC 才应发送
其UID CLn 的其余部分。
步骤 10 ：如果出现进一步冲突，则重复步骤6~9。最大环数是 32 。
步骤 11 ：如果不出现进一步冲突，则PCD 分配带有值为“ 70 ”的NVB 。
步骤 12 ：PCD 发送SEL 和NVB ，后随UID CLn 的所有 40 个位，后面有紧跟CRC_A 校
验和。

#### 表表表表 2.4 比特帧防冲突用的比特帧防冲突用的比特帧防冲突用的比特帧防冲突用的 B7 和和和和 B8 的编码的编码的编码的编码

```
b8 b7 含义
0 0 UID 长度：单个
0 1 UID 长度：两个
1 0 UID 长度：三个
1 1 RFU
```
#### 表表表表 2.5 比特帧防冲突用的比特帧防冲突用的比特帧防冲突用的比特帧防冲突用的 B1-B5 的编码的编码的编码的编码

```
b5 b4 b3 b2 b1 含义
1 0 0 0 0 比特帧防冲突
0 1 0 0 0 比特帧防冲突
0 0 1 0 0 比特帧防冲突
0 0 0 1 0 比特帧防冲突
0 0 0 0 1 比特帧防冲突
所有其他 RFU
```

步骤 13 ：它的UID CLn 与 40 个比特匹配，则该PICC 以其SAK 表示响应。
步骤 14 ：如果UID 完整，则PICC 应发送带有清空的串联级别位的SAK ，并从READY 状
态转换到ACTIVE 状态。
步骤 15 ：PCD 应校验SAK 的串联比特是否被设置，以决定带有递增串联级别的进一步防
冲突环时候应继续进行。

如果PICC 的UID 是已知的，则PCD 可以跳过步骤2~10 来选择该PICC ，而无需执行
防冲突环。

```
防冲突环开始
```
```
SEL=代码(串联级别)
```
```
NVB="20"
```
```
传输防冲突指令
```
```
接收UID CLn
```
```
冲突？
```
```
NVB="70"
```
```
传输SELECT 指令
```
```
接收SAK
```
```
coll=第一个冲突
的位置
```
```
传输防冲突指令
```
```
NVB="20"+coll
```
```
NO
```
```
YES
```
```
结束防冲突环
```
```
1
```
```
2
```
```
3
```
```
4
5
```
```
12
```
```
13
```
```
11
```
```
10 6
```
```
9
```
```
8
```
```
7
```
```
SEL NVB
```
```
SEL NVB UID CLn CRC_A
```
```
SEL NVB UID CLn
```
#### 图图图图 2-9 PCD 防冲突环流程图防冲突环流程图防冲突环流程图防冲突环流程图

#### 2.2.4.3.2. SEL 的编码的编码的编码的编码

#### 长度： 1 字节

#### 可能值：‘ 93 ’，‘ 95 ’，‘ 97 ’


#### 2.2.4.3.3. NVB 的编码的编码的编码的编码

#### 长度： 1 字节

#### 较高 4 位称为字节计数，规定所有被 8 分开的有效数据位的数，包括被PCD 发送的

#### NVB 和SEL 。这样，字节奇数的最小值是 2 而最大值是 7 。

#### 较低 4 位称为比特计数，规定由PCD 发送的模 8 所有有效数据位的数。

#### 2.2.4.3.4. SAK 的编码的编码的编码的编码（（（选择确认（选择确认选择确认选择确认））））

当NVB 规定 40 个有效位并且当所有这么数据位与UID CLn 相配时，SAK 由PICC 来
发送。

```
第一字节 第二、第三字节
SAK CRC_A
（ 1 字节）（两字节）
图图图图 2-10 选择确认选择确认选择确认选择确认（（（（ SAK ））））
位b3 （串联位）和b6 的编码在表2.8 中给出。
```
#### 表表表表 2.7 NVB 的编码的编码的编码的编码

```
b8 b7 b6 b5 b4 b3 b2 b1 含义
0 0 1 0 - - - - 字节计数=2
0 0 1 1 - - - - 字节计数=3
0 1 0 0 - - - - 字节计数=4
0 1 0 1 - - - - 字节计数=5
0 1 1 0 - - - - 字节计数=6
0 1 1 1 - - - - 字节计数=7
```
- - - - 0 0 0 0 比特计数=0
- - - - 0 0 0 1 比特计数=1
- - - - 0 0 1 0 比特计数=2
- - - - 0 0 1 1 比特计数=3
- - - - 0 1 0 0 比特计数=4
- - - - 0 1 0 1 比特计数=5
- - - - 0 1 1 0 比特计数=6

- - - - (^0 1 1 1) 比特计数=7

#### 表表表表 2.6 SEL 的编码的编码的编码的编码

```
b8 b7 b6 b5 b4 b3 b2 b1 含义
1 0 0 1 0 0 1 1 “93” ：选择串联级别 1
1 0 0 1 0 1 0 1 “95” ：选择串联级别 2
1 0 0 1 0 1 1 1 “97” ：选择串联级别 3
1 0 0 1 所有其他 RFU
```

#### 2.2.4.4. UID 内容和串联级别内容和串联级别内容和串联级别内容和串联级别

#### UID 由 4 、 7 或 10 个UID 字母组成。因此，PICC 最多处理 3 个串联级别，以得到所

#### 有UID 字节。在每个串联级别内，由 5 个数据字节组成的UID 的一部分应被发送到PCD 。

#### 根据最大串联级别，定义了UID 长度的三个类型。该UID 长度应与表2.9 一致

UID 是一个固定的唯一数或由PICC 动态生成的随机数。UID 的第一个字节（uid0 ）
分配后随UID 字节的内容。

串联标记CT 的值“ 88 ”因不用于单个长度UID 中的uid0。
表2.10 两个和三个长度的UID
在ISO/IEC 7816-6/AM1 中为“私用”标出的值“ 81 ”到“FE ”在本上下文中应不予
允许。

```
PCD "93"
PICC uid0 uid1 uid2 uid3 BCC
PCD "93" PCD "95"
PICC CT uid0 uid1 uid2 BCC PICC uid3 uid4 uid5 uid6 BCC
PCD "93" PCD "95" PCD "97"
PICC CT uid0 uid1 uid2 BCC PICC CT uid3 uid4 uid5 BCC PICC uid6 uid7 uid8 uid9 BCC
级别级别级别级别 2 级别级别级别级别 3
```
```
UID 尺寸尺寸尺寸尺寸
单个单个单个单个
UID 尺寸尺寸尺寸尺寸
两个两个两个两个
UID 尺寸尺寸尺寸尺寸
三个三个三个三个
级别级别级别级别 1
```
```
uidx=Byte number x
CT=Cascade Tag
BCC=UID check byte
```
#### 图图图图 2-11 串联级别的使用串联级别的使用串联级别的使用串联级别的使用

#### 注：串联标记的途是迫使造成与具育较小UID 长度的PICC 冲究．

#### 表表表表 2.10 单个长度的单个长度的单个长度的单个长度的 UID

#### UID0 描述

#### 制造商ID 根据ISO/IEC

#### 7816-6/AM1*

#### 每个制造商对唯一编号的其他字节的值得唯一

#### 性负责。

#### 值”81”到”FE”在ISO/IEC 7816-6/AM1 中定义为“私用”，在这里不允许出现

#### 表表表表 2.9 UID 长度长度长度长度

#### UID0 描述

#### “08” UID1 到UID3 为动态生成的随机数

```
“x0”-“x7” 专有固定数
“x9”-“xE”
“18”-“F8” RFU
“xF”
```
#### 表表表表 2.8 SAK 的编码的编码的编码的编码

```
b8 b7 b6 b5 b4 b3 b2 b1 含义
X X X X X 1 X X 串联比特设置，UID 不完整
X X 1 X X 0 X X UID 完整，PICC 遵循ISO/IEC 14443-4
X X 0 X X 0 X X UID 完整，PICC不遵循ISO/IEC 14443-4
```

#### 下列算法应适用于PCD 以获得完整UID ；

步骤l：PCD 选择串联级别 1

步骤 2 ：应执行防冲突环

步骤 3 ：PCD 应检验SAK 的串联比特

步骤 4 ：如果设置了串联比特，PCD 应增加串联缀别并初始化一个新的防冲突环


## 3. 传输协议传输协议传输协议传输协议 ...............................................................................................................

**3.1.** 类型类型类型类型 **A PICC** 的协议激活的协议激活的协议激活的协议激活

应使用下列激活序列：
——如第 2 章中所定义的PICC 激活序列（请求、防冲突环和选择）。
——为获得ATS ，在开始应校验到SAK 字节。SAK 在第 2 章中定义。
——如果没有获得ATS ，使用第 2 章中定义的HALT 命令，PICC 可被置为HALT 状
态。

——如果获得了ATS ，在接收到SAK 后，PCD 可发送RATS 作为下一条命令。
——PICC 应发送其ATS 作为对RATS 的应答。如果在选择后直接接收到RATS ．则
PICC 应仅应答RATS。

——如果PICC 在ATS 中支持任何变化的参数，PCD 可使用PPS 请求作为接收到ATS
后的下一条命令，并用其来改变参数。

```
——PICC 应发送PPS 响应作为对PPS 请求的应答。
如果PICC 在ATS 中不支持任何变化的参数，则它无需执行PPS。
下图示出了从PCD 角度来看的类型A PICC 激活序列。
```

```
开始
```
```
发送REQA
```
```
接受ATQA
```
```
防冲突环
```
```
ATS 可用
```
```
使用ISO/IEC
14443 协议
```
```
发送RATS
```
```
接收ATS
```
```
PPS 支持
```
```
交换透明数据
```
```
改变参数
```
```
发送PPS 请求
```
```
接收PPS 响应
```
```
YES
```
```
NO
```
```
YES
```
```
NO
```
```
发送DESELECT请求
```
```
接收DESELECT响应
```
```
发送WUPA
```
```
YES
```
```
YES
```
```
发送HLTA
```
```
非ISO/IEC
NO 14443-4议送
```
```
NO
```
#### 图图图图 3-1 从从从从 PCD 角度来看的类型角度来看的类型角度来看的类型角度来看的类型 A PICC 激活激活激活激活

### 3.1.1. 选择应答请求.......................................................................................................................

#### 本节定义了带有所有字段的RATS（见下图）。


```
“E0 ”
```
```
参数
```
```
CRC1
```
```
CRC2
```
```
开始字节
```
```
参数编码
编码FDSI和CID
```
#### 图图图图 3-2 选择应答请求选择应答请求选择应答请求选择应答请求

#### 参数字节由两部分组成（见下图）：

——最高有效半字节b8到b5 称为FSDI．它用于编码FSD 。FSD 定义了PCD 能收到
的帧的最大长度。FSD 的编码在 25 中给出。

——最低有效半字节b4 到bl 命名为CID 。它定义编址了的PICC 的逻辑号在 0 到 14
范围内。值 15 为RFU 。CID 由PCD 规定，并且对同一时刻处在ACTIVE 状态中的所有
PICC ，它应是唯一的。CID 在PICC 被激活期间是固定的．并且PICC 应使用CID 作为其
逻辑标识符，它包含在接收到的第一个无差错的RATS 。

```
b8 b7 b6 b5 b4 b3 b2 b1
```
```
FDSI
```
```
CID
```
```
图图图图 3-3 RATS 参数字节的编码参数字节的编码参数字节的编码参数字节的编码
表表表表 3.1 FSD 到到到到 FSDI 的转换的转换的转换的转换
FDSI ‘0’ ‘1’ ‘2’ ‘3’ ‘4’ ‘5’ ‘6’ ‘7’ ‘8’ ‘9’-‘F’
FSD 16 24 32 40 48 64 96 128 256 RFU>256
```
### 3.1.2. 选择应答...............................................................................................................................

#### 本章定义了带有其所有可用字段的ATS （见下图）。

#### 在已定义字段中的一个没有在PICC 发送的ATS 中出现的情况下，应应用该字段的缺

#### 省值。


```
T0
TA(1)
TB(1)
TC(1)
T1
```
```
接口字节 ......编码DS 和DR
```
```
......编码协议选项
```
```
长度字节 TL
```
```
Tk
CRC1
CRC2
```
```
......编码FWI和SFGI
```
```
历史字节
```
```
格式字节
```
#### 图图图图 3-4 ATS 的结构的结构的结构的结构

#### 3.1.2.1. 字字字字节结构节结构节结构节结构

#### 长度字节TL 以下面的顺序跟随着可选后续字节的可变号码：

#### ——格式字节T0，

#### ——接口字节TA （ 1 ），TB （ 1 ），TC （ 1 ）和

#### ——应用信息字节T1 到TK 。

#### 3.1.2.2. 长度字节长度字节长度字节长度字节

#### 长度字节TL 是强制的，它规定了传送的ATS（包括其本身）的长度。两个CRC 字

#### 节并不包括在TL 中。ATS 的最大长度应不超出指示的FSD 。因此TL 的最大值应不超过

#### FSD-2。

#### 3.1.2.3. 格式字节格式字节格式字节格式字节

格式字节T是强制的，并且当长度大于l，它便出现。当该格式字节出现时，ATS
能仅包含下列可选字节。

T0 由三部分组成（见图 42 ）：
——最高有效位b8 应置为．其他值为RFU 。
——包含Y（ 1 ）的位b7 到b5 指示接口字节TC （ 1 ），TB （ 1 ）和TA （ 1 ）的出现。
——最低有效半字节b4 到bl称为FSCI，它用于编码FSC 。FSC 定义了PICC 能接收
的帧的最大长度。FSCI 的缺省值为 2 ，这导致了一 32 字节的FSC 。FSC 的编码等于FSD
的编码（见表3.1）


```
b8 b7 b6 b5 b4 b3 b2 b1
0
```
```
FSCI
若该位置为 1 ，TA(1)被传输
若该位置为 1 ，TB(1)被传输
若该位置为 1 ，TC(1)被传输
应置为 0 ， 1 为RFU
图图图图 3-5 格式字节的编码格式字节的编码格式字节的编码格式字节的编码
```
**3.1.2.4.** 接口字节接口字节接口字节接口字节 **TA** （（（（ **1** ））））

接口字节TA （ 1 ）由四部分组成（见下图）：
——最高有效位b8 编码了为每个方向处理不同除数的可能性。当该位被置为l时．PICC
不能为每个方向处理不同除数。

——位b7 到b5 为PICC 到PCD 方向编码了PICC 的位速率能力，称为DS。其缺省值
应为（ 000 ）b。

——位b4 被置为（ 0 ）b，其他值为RFU 。
——位b3 到b1 为PCD 到PICC 方向编码了PICC 的位速率能力,称为DR 。其缺省值
应为（ 000 ）b。

```
b8 b7 b6 b5 b4 b3 b2 b1
0
若该位置为 1 ，支持DR=2
若该位置为 1 ，支持DR=4
若该位置为 1 ，支持DR=8
应置为 0 ， 1 为RFU
若该位置为 1 ，支持DS=2
若该位置为 1 ，支持DS=4
若该位置为 1 ，支持DS=8
若该位置为 1 ，仅为两个方向支持相同的D
若该位置为0，为每个方向支持不同的D
图图图图 3-6 接口字节接口字节接口字节接口字节 TA （（（（ 1 ））））的编码的编码的编码的编码
为每个方向选择特定除数可以使用PPS 由PCD 来完成
```
**3.1.2.5.** 接口字节接口字节接口字节接口字节 **TB** （（（（ **1** ））））

接口字节TB （ 1 ）运送信息以定义帧等待时间和启动帧保护时间。
接口字节TB （ 1 ）由两部分组成：
——最高有效半字节b8 到b5 称为FWI，它编码FWT （见8.3.2）。
——最低有效半字节b4 到bl 称为SFGI，它编码了一乘数值用于定义SFGT 。SFGT
定义了在发送了ATS 之后，准备接收下一个帧之前PICC 所需的特定保护时间。SFGI 在 0
到 14 范围内编码。值 15 为RFU 。值 0 指示无需SFGT ，在 1 到 14 范围内的值用于用下面
给出的公式计算SFGT 。SFGI 的缺省值为 0 。


```
b8 b7 b6 b5 b4 b3 b2 b1
```
```
SFGI
FWI
图图图图 3-7 接口字节接口字节接口字节接口字节 TB （（（（ 1 ））））的编码的编码的编码的编码
SFGT 用下面的公式计算：
```
## ( )

### SFGT ~4949ms

### SFGT

### SFGT

### SFGT 256 16/fc 2

```
MAX
```
```
DEFAULT
```
```
MIN
```
```
SFGI
```
### =

### =

### =

### = × ×

### 第二章中定义的最小值

### 第二章中定义的最小值

#### 3.1.2.6. 接口宇节接口宇节接口宇节接口宇节 TC （（（（ 1 ））））

#### 接口字节TC （ 1 ）规定了协议的参数。

#### 特定接口字节TC （ 1 ）由两部分组成（见下图）：

——最高有效位b8 到b3 为000000b，所有其他值为RFU 。
——位b2 和b1 定义了在PICC 支持的开端字段中的可选字段。允许PCD 跳过已被指
出被PICC 支持的字段，但PICC 不支持的字段应不被PCD 传输。缺省值应为（ 10 ）b．它
指出支持CID 和不支持NAD 。

```
应置为 0 ，不支持NAD
```
```
应置为(000000)b，所有其他为RFU
```
```
若该位置为 1 ，支持CID
```
```
b8 b7 b6 b5 b4 b3 b2 b1
0 0 0 0 0 0 0
```
#### 图图图图 3-8 接口字节接口字节接口字节接口字节 TC （（（（ 1 ））））的编码的编码的编码的编码

#### 3.1.2.7. 历史字节历史字节历史字节历史字节

历史字节T1 到Tk 是可选的并包含了通用信息。ATS 的最大长度给出了历史字节的最
大可能数目。ISO/IEC 7816-4 规定了历史字节的内容。

**3.1.2.8. FMCOS 2.0** 选择应答选择应答选择应答选择应答 **(ATS)**

```
选择应答信息如下表：
```
#### 符号符号符号符号 字节内容字节内容字节内容字节内容 内容解释内容解释内容解释内容解释

```
TL 0x10 长度字节
T0 0x78
```
#### TA1 、TB1 和TC1 存在，FSCI=8（FSC=256

#### 字节）

```
TA1 0x80
```
#### 两个方向可以支持相同的D,支持

#### DR=1,DS=1


#### 符号符号符号符号 字节内容字节内容字节内容字节内容 内容解释内容解释内容解释内容解释

```
TB1 0x90
FWI=0x9（FWT=155ms）
SFGI=0（SFGT=302us）
TC1 0x02 不支持NAD,支持CID
T1 0x20 COS 版本号2.0
T2 0x90 COS 厂商代码（复旦微电子）
T3 0x00 保留字节
T4-T11 XX 卡序列号
```
### 3.1.3. 协议和参数选择请求...........................................................................................................

#### PPS 请求包含着被格式字节和一参数字节跟随的开始字节（见下图）。

```
PPSS
PPS0
PPS1
CRC1
CRC2
```
```
......编码PRS和D1现
```
```
参数字节 ......编码PPS1的出现
```
```
开始字节
```
#### 图图图图 3-9 协议和参数选择请求协议和参数选择请求协议和参数选择请求协议和参数选择请求

#### 3.1.3.1. 开始字节开始字节开始字节开始字节

#### PPSS 包含两部分（见下图）：

```
——最高有效半字节b8 到b5 应置为‘D’并标识了PPS 。
——最低有效半字节b4 到b1 称为CID ，它定义了已编址的PICC 的逻辑号。
```
```
b8 b7 b6 b5 b4 b3 b2 b1
1 1 0 1
```
```
CID
应置为 1 ， 0 为RFU
应置为 0 ， 1 为RFU
应置为(11)b ，所有其他值为RFU
图图图图 3-10 PPSS 的编码的编码的编码的编码
```
**3.1.3.2.** 参数字节参数字节参数字节参数字节 **0**

```
PPS0 致使可选字节PPS1 的出现（如下图）。
```

```
b8 b7 b6 b5 b4 b3 b2 b1
0 0 0 0 0 0 1
```
```
应置为 1 ， 0 为RFU
应置为(000)b ，所有其他值为RFU
若该位置为 1 ，则PPS1 被传输
应置为(000)b ，所有其他值为RFU
图图图图 3-11 PPS0 的编码的编码的编码的编码^
```
**3.1.3.3.** 参数字节参数字节参数字节参数字节 **1**

```
PPS1 由三部分组成（见下图）：
——最高有效半字节b8 到b5 为（ 0000 ）b，所有其他值为RFU 。
——位b4 ．b3 称为DSI，它编码了已选择的从PICC 到PCD 的除数整数。
——位b2 ，b1 称为DRI，它编码了已选择的从PCD 到PICC 的除数整数。
```
```
1 1 0 1
```
```
DRI
DSI
应置为(0000)b，所有其他值为RFU
```
```
b8 b7 b6 b5 b4 b3 b2 b1
```
#### 图图图图 3-12 PPS1 的编码的编码的编码的编码

#### 对于可能的DS 和DR 的定义，见3.1.2.4。

#### D的编码在下表中给出。

### 3.1.4. 协议和参数选择响应...........................................................................................................

#### PPS 响应确认接收到的PPS 请求（见下图）．并仅包开始字节（见3.1.3.1）

```
PPSS
CRC1
CRC2
```
```
开始字节
```
#### 图图图图 3-13 协议和参数选择响应协议和参数选择响应协议和参数选择响应协议和参数选择响应

#### 3.1.4.1. 激活帧等待时间激活帧等待时间激活帧等待时间激活帧等待时间

#### 激活帧等待时间为PICC 在接收到的来自PCD 的帧的结尾之后开始发送其响应帧定义

了最大时间，其值为 65536 ／fc（~4833us）。

#### 表表表表 3.2 DRI ，，，， DSI 到到到到 D 的转换的转换的转换的转换^

```
DRI, DSI (00)b (01)b (10)b (11)b
D 1 2 4 8
```

#### 注：在任何方向上两个帧之间的最小时间在第 2 章中定义

### 3.1.5. 差错检测和恢复...................................................................................................................

#### 3.1.5.1. `RATS 和和和和 ATS 的处理的处理的处理的处理

#### 3.1.5.1.1. PCD 规规规规 则则则则

#### 当PCD 发送了RATS 并接收到有效ATS，PCD 应继续工作。存任何其它情况下．在

#### 它应使用如3.3 中定义的停活序列前，PCD 可以重新传输RATS 。在停活序列失败的情况

#### 下，它可以使用第 2 章中定义的HLTA 命令。

#### 3.1.5.1.2. PICC 规则规则规则规则

#### 当PICC 被最后一条命令选择，并且收到有效RATS，PICC 应

#### ——发送回其ATS，并且

#### ——使RATS 失效（停止响应接受到的RATS ）。

#### 收到除了HLTA 命令的任何块（有效或无效），PICC 应

#### ——忽略该块，并且

#### ——保持在接收模式。

#### 3.1.5.2. PPS 请求和请求和请求和请求和 PPS 响应的处理响应的处理响应的处理响应的处理

#### 3.1.5.2.1. PCD 规则规则规则规则

#### 当PCD发送了PPS 并接收到有效PPS 响应，PCD 应激活选择的参数并继续工作。

#### 在任何其他情况下，PCD 可以重新传输PPS 请求并继续工作。

#### 3.1.5.2.2. PICC 规则规则规则规则

#### 当PICC 接收到RATS ，发送了其ATS ，并且

```
a）接收到有效PPS 请求，PICC 应
——发送PPS 响应，
——使PPS 请求失效（停止响应接收到的PPS 请求）并
——激活接收到的参数。
b）接收到无效块，PICC 应
——使PPS 请求失效（停止响应接收到的PPS 请求）并
——保持在接收模式。
c）接收到除了PPS 请求的有效块，PICC 应
——使PPS 请求失效（停止响应接收到的PPS 请求）并
——继续工作。
```
**3.1.5.3.** 激活期间激活期间激活期间激活期间 **ClD** 的处理的处理的处理的处理

```
当PCD 发送了包含CID=n 不等于 0 的RATS ，并且
a）接收到指示CID 被支持的ATS，PCD 应
——发送包含CID=n 的块给该PICC ，并
```

```
——当该PICC 处于ACTIVE 状态时．对于进一步的RATS ，不使用CID=n。
b）接收到指示CID 不被支持的ATS，PCD 应
——发送不包含CID 的块给该PICC ，并
——当该PICC 处于ACTIVE 状态时，不激活任何其他PICC 。
当PCD 发送了包含CID 等于 0 的RATS，并且
c）接收到指示CID 被支持的ATS，PCD 应
——发送包含CID 等于O的块给该PICC ，并
——当该PICC 处于ACTIVE 状态时，不激活任何其他PICC 。
d）接收到指示CID 不被支持的ATS。PCD 应
——发送不包含CID 的块给该PICC ，并
——当该PICC 处于ACTIVE 状态时，不激活任何其他PICC 。
```
**3.2.** 半双工块传输协议半双工块传输协议半双工块传输协议半双工块传输协议

半双工块传输协议符合无触点卡环境的特殊需要，并使用第 2 章中定义的帧格式。
帧格式的其他相关元素有：
——块格式：
——最大帧等待时间：
——功率指示，和
——协议操作。
本协议根据OSI 参考模型的原理压条法设计，需特别注意穿越边界的交互作用的最小
限度。四层定义如下：

——根据第 2 章交换字节的物理层。
——按本章中定义进行交换块的数据链路层。
——为使系统开销最小而与数据链路层结合的会话层。
——处理命令的应用层，它涉及在两个方向上至少一个块或块链的交换。
注：应用选择的使用如IS0／IEC 7816-5中所定义。不推荐在多应用的PICC 中使用隐
含的应用选择。

### 3.2.1. 块格式...................................................................................................................................

#### 块格式（见下图）有一个开端域（强制）、一个信息域（可选）和一个结束域（强制）

#### 组成。

```
开始域
PCB [CID]
1 字节
```
```
[NAD]
1 字节 1 字节
```
```
信息域
[INF]
```
```
结束域
EDC
2 字节
```
```
差错检测代码
FSD/FSC
注：方括号中的数据为可选数据
图图图图 3-14 块格式块格式块格式块格式
```

#### 3.2.1.1. 开端域开端域开端域开端域

#### 开端域是强制的，最多由三个字节构成：

#### ——协议控制字节（强制），

#### ——卡标识符（可选），

#### ——结点地址（可选）。

#### 3.2.1.1.1. 协议控制字节域协议控制字节域协议控制字节域协议控制字节域

#### PCB 用于传送控制数据传输所需要的信息。

#### 协议定义了块的三种基本类型：

#### ——用于为应用层的使用传送信息的I-块。

#### ——用于传送确认或不确认的R-块。R-块不包含INF 域。确认涉及最后接收到的块。

#### ——用于在PCD 和PICC 间交换控制信息的S-块。两种不同类型的S-块定义如下：

1 ）包含l字节长INF 域的等待时间延迟，和
2 ）不包含INF 域的DESELECT 。
PCB 的编码依赖于它的类型，如下图所定义。此处没有定义的PCB 编码在其他章节
使用或为RFU 。I-块、R-块和S一块的编码在图3-15、图3-16、图3-17 中给出。

```
块号
```
```
I-块
```
```
应置为 1
```
```
b8 b7 b6 b5 b4 b3 b2 b1
0 0 0 0 1
```
```
应置为 0 ， 1 为RFU
```
```
应置为 0 ，不支持NAD
若该位置为 1 ，则CID 跟随
若该位置为 1 ，则链接
```
#### 图图图图 3-15 I- 块块块块 PCB 的编码的编码的编码的编码

```
应置为 1 ， 0 为RFU
```
```
R-块
```
```
若该位置为 1 ，则CID 跟随
```
```
b8 b7 b6 b5 b4 b3 b2 b1
1 0 1 0 1 0
块号
```
```
应置为 0
```
```
若该位置为 0 ，则ACK
若该位置为 1 ，则NAK
```
#### 图图图图 3-16 R- 块块块块 PCB 的编码的编码的编码的编码


```
应置为 1 ， 0 为RFU
```
```
S-块
```
```
若该位置为 1 ，则CID 跟随
```
```
b8 b7 b6 b5 b4 b3 b2 b1
1 1 0 1 0
```
```
应置为 0
```
```
(00)b DESELECT或
(11)b WTX
```
```
应置为 0 ， 1 为RFU
```
#### 图图图图 3-17 S- 块块块块 PCB 的编码的编码的编码的编码

#### 3.2.1.1.2. 卡标识符域卡标识符域卡标识符域卡标识符域

#### CID 域用于识别特定的PICC ，它由三部分组成（见下图）：

——最高有效位b8 ，b7 用于从PICC 到PCD 的功率水平指示。对于PCD 到PICC 的
通信，这两位应被置为 0 。功率水平指示的定义见3.2.4。

——位b6 和b5 用于传送附加信息．它没有被定义并应置为（ 00 ）b，所有其他值为
RFU 。

```
——位b4 到b1 编码CID 。
```
```
应置为(00)b ，所有其他值为RFU
功率水平指示
```
```
b8 b7 b6 b5 b4 b3 b2 b1
0 0
```
```
CID
```
#### 图图图图 3-18 卡标识符的编码卡标识符的编码卡标识符的编码卡标识符的编码

#### 类型A CID 的编码在3.1.1 中给出。

#### PICC 对CID 的处理描述如下：

#### 不支持CID 的PICC 应

#### ——忽略任何包含CID 的块。

#### 支持CID 的PICC 应

#### ——通过使用其CID 响应包含其CID 的块。

#### ——忽略包含其他CID 的块。

#### ——假若其CID 为 0 ，亦通过不使用CID 响应不包含CID 的块。

#### 信息域（INF ）

#### INF 域是可选的。当它存在时，INF 域传送I-块中的应用数据或非应用数据和S-块中

#### 的状态信息。信息域的长度通过计算整个块的字节数减去开端域和结束域得出。

#### 3.2.1.2. 结束域结束域结束域结束域

#### 该域包含传输块的EDC 。EDC 为如第 2 章中定义的CRC 。


### 3.2.2. 帧等待时间帧等待时间帧等待时间帧等待时间（（（（ FWT ））））

#### FWT 给PICC 定义了在PCD 帧结束后开始其响应帧的最大时间（见下图）。

```
由PCD 发送
```
```
t<FWT
```
```
由PICC 发送
```
#### 图图图图 3-19 帧等待时间帧等待时间帧等待时间帧等待时间^

#### 注：在任伺方向上两个帧之间的最小时间在第 2 章中定义。

#### FWT 通过下面的公式计算：

### FWT =( 256 × 16 / fc )× 2 FWI

#### 其中FWI的值在 0 到 14 之间， 15 为RFU 。对于类型A，若TB （ 0 ）被省略，则FWI

的缺省值为 4 ，给出的FWT 值约为4.8ms。

### 对于FWI=0，FWT =FWT MIN (~302us）

### 对于FWI=14，FWT =FWT MAX (~4949us)

#### FWT 应用于检测传输差错或无响应的PICC 。如果来自PICC 的响应的开始没有在FWT

#### 内被接收到。则PCD 收回发送的权利。

### 3.2.3. 帧等待时间扩展...................................................................................................................

#### 当PICC 需要比定义的FWT 更多的时间用于处理接收到的块时，应使用S（WTX ）请

#### 求等待时间扩展。S（WTX ）请求包含 1 字节长INF 域，它由两部分组成（见下图）：

——最高有效位b8 ，b7 编码功率水平指示（见3.2.4）。
——最低有效位b6 到bl 编码WTXM 。WTXM 在l到 59 范围内编码。值 0 和 60 到
63 为RFU 。

```
WTXM
功率水平指示
```
```
b8 b7 b6 b5 b4 b3 b2 b1
0 0 0 0 0 0 0
```
#### 图图图图 3-20 S(WTX) 请求的请求的请求的请求的 INF 域编码域编码域编码域编码

#### PCD 应通过发送包含 1 字节长INF 域的S（WTX ）来确认。该INF 域由两部分组成（见

#### 下图）并包含了与在请求中接收到的相同的WTXM ；

```
——最高有效位b8 ，b7 为（ 00 ）b，所有其它值为RFU 。
——最低有效位b6 到b1编码了用于定义临时FWT 的确认的WTXM 值。
```

```
WTXM
应置为(00)b ，所有其他值为RFU
```
```
b8 b7 b6 b5 b4 b3 b2 b1
0 0 0 0 0 0 0
```
#### 图图图图 3-21 S(WTX) 响应得响应得响应得响应得 INF 域编码域编码域编码域编码

#### FWT 的响应的临时值通过下面的公式计算：

### FWT TEMP =FWT ×WTXM

#### PICC 需要的时间FWT TEMP 在PCD 发送了S（WTX ）响应之后开始。

#### 当公式得出的结果大于FWT MAX 时，应该使用FWT MAX。

#### 临时FWT 仅在下一个块被PCD 接收到的时才应用。

### 3.2.4. 功率水平指示.......................................................................................................................

#### 功率水平指示通过使用插入在CID （当存在时）中的两位来编码，并在S-块中被PICC

#### 发现（见3.2.1.1.2 和3.2.3）

#### 表表表表 3.2 功率水平指示的编码功率水平指示的编码功率水平指示的编码功率水平指示的编码

```
(00)b PICC 不支持功率水平指示
(01)b 对于完整功能性，功率不充分
(10)b 对完整功能性。功率充分
(11)b 对于完整功能性，功率超出
```
注：由PCD 进行的功率水平指示的解释时可选的。

### 3.2.5. 协议操作...............................................................................................................................

#### 在激活序列后，PICC 应等待一仅PCD 才有权利发送的命令。在发送了块之后，PCD

#### 应转换到接受模式并在转换回到传输模式之前等待块。PICC 可以传输块仅响应接收到的块

#### （对时间延迟是察觉不到的）。在响应后，PICC 应返回到接受模式。

#### 在当前命令/响应对没有完成或帧等待时间超出而没有响应时，PCD 不应初始化一新的

#### 命令/响应对。

#### 3.2.5.1. 链接链接链接链接

#### 链接过程允许PCD 或PICC 通过把信息化分成若干块来传输不符合分别由FSC 或FSD

#### 定义的单块信息。每一块的长度应分别小于或等于FSC 或FSD 。

#### 块的链接通过I-块PCB 中的链接位来控制。每一个带链接位集的I-块应被R-块确认。

#### 链接的特新在图3-22 种给出， 16 字节长字串分成三块来传输。

#### 记号：

```
I(1)X 带有块号x且设置了链接位的I-块
I(0)X 带有块号x但未设置链接位（一链接中的末块）的I-块
R(ACK)X
```

```
012345 789ABCD EF
```
```
"12" 012345 "xx" "xx"
PCB INF EDC
"13" 789ABCD "xx" "xx"
PCB INF EDC
"02" EF "xx" "xx"
PCB INF EDC
I(1) 0 I(1) 1 I(0) 10
```
```
Assertion: FSC=FSD=10 Answer
```
```
"02" Answer "xx" "xx"
```
```
PCB INF EDC
"A2" "xx" "xx"
```
```
PCB EDC
"A3" "xx" "xx"
```
```
PCB EDC
R(ACK) 0 R(ACK) 0 I(0) 0
```
```
发送（......） 接受（......）
```
```
012345 789ABCD EF
```
```
接受（......） 发送（......）
```
```
Answer
```
```
应 用 层 数 据 链 路 层 数 据 链 路 层 应 用 层
```
```
物理层
```
#### 注：本例中没有使用可选字段NAD 和CID 。

#### 图图图图 3-22 链接链接链接链接

#### 3.2.5.2. 块编号规则块编号规则块编号规则块编号规则

#### 3.2.5.2.1. PCD 规则规则规则规则

#### 规则A：对每一张激活的PICC ，PCD 块号应被初始化为 0 。

#### 规则B：当带有块号等于当前块好的I-块或R(ACK)块被接收到时，PCD 在可选的发

#### 送块前为该PICC 切换当前块号。

#### 3.2.5.2.2. PICC 规则规则规则规则

#### 规则C：在激活时，PICC 块号应被初始化为 1 。

#### 规则D：当I-块被接收到（独立与其块号），PICC 在发送块前切换块号。

#### 规则E：当带有块号不等于当前块号的R(ACK)块被接收到时，PICC 在发送块前切换

#### 气块号。

#### 3.2.5.3. 块处理规则块处理规则块处理规则块处理规则

**3.2.5.3.1.** (^) 一般规则一般规则一般规则一般规则
规则 1 ：首块应由PCD 来发送。
规则 2 ：当I-块指示链接已被接收到时，块应由R(ACK)块来确认。
规则 3 ：S-块仅成对使用。s(...)请求块总是跟随着s(...)响应块（见3.2.3 和3.3）。
**3.2.5.3.2. PCD** 规则规则规则规则
规则 4 ：当接收到无效块或FWT 超时，则R(NAK)块被发送（PCD 链接或S(DESELECT)
情况除外）


#### 规则 5 ：在PICC 链接的情况下，当接收到无效块或FWT 超时，R(ACK)块被发送。

#### 规则 6 ：当接收到R(ACK)块，如果其块号不等于PICC 的当前块号，则最后的I-块被

#### 重新传送。

#### 规则 7 ：当接收到R(ACK)块，如果其块号等于PCD 的当前块号，则继续链接。

#### 规则 8 ：如果S(DESELECT)请 求 没有 被无 差 错 S(DESELECT)响应 进 行 回答。则

#### S(DESELECT) 请求可以被重新传送或PICC 可以被忽视。

#### 3.2.5.3.3. PICC 规则规则规则规则

#### 规则 9 ：允许PICC 发送S(WTX)块而不发送I-块或R(ACK)块。

#### 规则 10 ：当I一块没有指示链接已被接收到时，块应由I-块来确认。

#### 规则 11 ：当接收到R(ACK)块或R(NAK)块，如果其块号等于PICC 的当前块号，则最

#### 后的块被重新传送。

#### 规则 12 ：当接收到R(NAK)块，如果其块号不等于PICC 的当前块号，则R(ACK)块被

#### 发送。

#### 规则 13 ：当接收到R(ACK)块，如果其块号不等于PICC 的当前块号，则继续链接。

#### 3.2.5.4. 差错检测和恢复差错检测和恢复差错检测和恢复差错检测和恢复

#### 当 检 测 到 差 错时， 应试 图使 用下列 恢 复 规则。 本章中 的 定义支配块 处 理 规则(见

#### 3.2.5.3)。

#### 下列差错应被PCD 检测到：

a）传输差错(帧差错或EDC 差错)或FWT 超时
PCD 应试图通过以下顺序示出的技术进行差错恢复：
——块的重新传输（可选），
——S(DESELECT)请求的使用，
——忽视PICC 。
b）协议差错（违反了PCB 编码或违反了协议规则）
PCD 应试图通过以下顺序示出的技术进行差错恢复：
——S(DESELECT)请求的使用，
——忽视PICC 。
下列差错应被PICC 检测到：
a）传输差错（帧差错或EDC 差错），
b）协议差错（违反了协议规则）。
PICC 应尽量没有差错恢复。当传输差错或协议差错发生时，PICC 始终应返回接收模
式．在任何时候它都应接收S(DESELECT)请求。

```
注：R(NAK)块不由PICC 发送。
```
**3.3.** 类型类型类型类型 **A PICC** 的协议停活的协议停活的协议停活的协议停活

```
PCD 和PICC 间的交易完成之后，PICC 应被置为HALT 状态。
PICC 的停活通过使用DESELECT 命令来完成。
```

#### DESELECT 命令象协议的S-块那样编码，并由PCD 发送的S(DESELECT)请求块和

#### PICC 作为确认发送的S(DESELECT)响应组成。

### 3.3.1. 停活帧等待时间...................................................................................................................

#### 停活帧等待时间给PICC 定义了接收到来自PCD 的S(DESELECT)请求帧的末端后开

始发送其S(DESELECT)响应的最短时间，其值为65536/fc(~4833us)。

```
注：在任何方向上帧之间的最短时间在第 2 章中定义。
```
### 3.3.2. 差错检测和恢复...................................................................................................................

#### 当PCD 发送了S(DESELECT)请求并接收到了S(DESELECT)响应，则PICC 已被成功

#### 地置为了HALT 状态并且分配给它的CID 也被释放。

#### 当PCD 没有接收到S(DESELECT)响应，则PCD 可以重新进行停活序列。


## 4. FMCOS 文件结构文件结构文件结构文件结构 ...............................................................................................

**4.1.** 文件结构文件结构文件结构文件结构

FMCOS IC 卡的基本文件系统是由主文件MF （Master File）、目录文件DF （Directory
File）和基本文件EF（Element File）组成。主文件MF 在IC 卡中唯一存在，在MF 下可以
有多个目录文件DF 和基本文件EF ，每一个MF 目录下的DF 可以存放多个基本文件EF
和多个下级目录文件DF ，在这里我们称包含下级目录的目录文件为DDF ，不含下级目录
的目录文件为ADF。

FMCOS 描述了符合<< 中国金融集成电路（IC ）卡规范>> 的应用文件结构，这些应用
被定义为支付系统应用。IC 卡中支付系统应用可以通过明确选择支付系统环境来激活，一
个成功的支付系统环境选择能够对目录结构进行访问。

从终端角度来看，与支付系统应用相关的支付系统环境文件呈一种可通过目录结构访
问的树形结构。树的每一分支是一个应用数据文件ADF 。一个ADF 是一个或多个应用基
本文件EF 的入口点。一个ADF 及其相关数据文件处于树的同一分支上。

下图给出了一个卡片内部结构示例，该卡片支持电子存折、电子钱包、磁条卡功能应
用（Easy entry）以及一个没有定义的发卡方应用。

```
EF
```
```
（
包
含
```
```
磁
条
卡
功
能
数
据
）
```
```
EF
```
```
（
在
DF
```
```
的
21
文
件
控
制
信
息
```
```
中
```
```
包
括
的
数
据
）
```
```
EF
```
```
（
包
含
```
```
22
持
卡
人
信
息
）
```
```
EF
```
```
（
交
```
```
易
24
记
录
文
件
）
```
```
存
折
文
件
钱
包
文
件
DF
```
```
发
卡
```
```
者
子
应
用
ADF
EF
```
```
（
包
含
发
卡
```
```
者
应
用
1 数
```
```
据
```
```
）
```
### 4.1.1. MF 文件................................................................................................................................

#### 在FMCOS 卡中，MF 文件唯一存在，是卡片文件系统的根。它相当于DOS 的根目录。

#### IC 卡复位后，卡片自动选择MF 文件为当前文件。FMCOS 卡支持用于支付系统环境应用

#### 列表的目录结构，支付系统环境由发卡方通过目录选择。目录结构包括一个必备的支付系

#### 统目录文件和一些可选的由DDF 引用的附加记录。 目录文件DF 的个数仅受EEPROM 空

#### 间的限制。

### 4.1.2. DF 文件.................................................................................................................................

#### 目录文件DF 相当于DOS 的目录，每个DDF 下可建立一个目录文件，但不是强制的。

#### 任何一个DF 在物理上和逻辑上都保持独立，都有自己的安全机制和应用数据，可以通过

#### 应用选择实现对其逻辑结构的访问。可以将单个DF 文件以及其中一个或多个EF 文件当作


#### 一个应用，也可以将多个DF 以及其中多个EF 文件当作一个应用，在使用IC卡时，用户

#### 可以根据不同的应用环境自行定义。

### 4.1.3. EF 文件.................................................................................................................................

#### 基本文件EF 用于存放用户数据或密钥，存放用户数据的文件称为工作基本文件，在

#### 满足一定的安全条件下用户可对文件进行相应的操作。存放密钥的文件称为内部基本文件，

#### 不可由外界读出，但当获得许可的权限时可在卡内进行相应的密码运算，在满足写的权限

#### 时可以修改密钥。

#### KEY 文件为内部基本文件。

#### KEY 文件必须在MF/DF 下最先被建立，且一个目录只能有一个KEY 文件，KEY 文

#### 件可存多个口令密钥、外部认证密钥、DES 运算密钥，每个密钥为一条TLV 格式的记录。

####  二进制文件：二进制文件为一个数据单元序列，数据以二进制为单位进行读写，其中

#### 的数据结构由应用者解释。

####  定长记录文件：定长记录文件每条记录长度都相同，数据以记录为单位进行存储，记

#### 录长度最大为 248 个字节。

####  循环文件：循环文件为具有固定长度记录的环行文件，每条记录都只有一个数据域，

#### 记录长度最大为 248 个字节。应用时只能顺序增加记录，当写记录时，当前写入的为

#### 第一条记录，则上一次写入的记录为第二条，依此类推，滚动写入。记录只能在文件

#### 头中所规定的范围内滚动写入，当写完最后一条记录时将覆盖最先写入的记录。

####  钱包文件：钱包文件内部采用专用的结构，由COS 维护，保存电子钱包、存折的余额、

#### 透支限额等信息。

####  变长记录文件： 变长记录文件的每条记录长度在写记录时是可变的，数据以记录为单

#### 位进行存储。更新记录时，新的记录长度必须与卡中的原有记录长度相同，否则本次

#### 更新无效。 记录最大长度不能超过 248 字节。变长记录格式TLV 如下：

```
TAG ：标识 Length ：数据长度 Val：L字节数据
```
**4.2.** 文件空间结构文件空间结构文件空间结构文件空间结构

```
每个文件在EEPROM 中存放的格式如下：
```
#### 每个基本文件所占的EEPROM 空间=文件头 11 字节+文件主体空间。

#### 定长和循环文件的主体空间=记录个数×(记录长度+1)。

#### 电子钱包和电子存折文件主体空间=22 字节。

#### 每个DF 所占的EEPROM 空间=DF 头 11 字节+DF 下所有文件的空间和+DF 名称长度。

#### MF 的空间=MF 头 11 字节+MF 下所有文件空间之和+ MF 名称长度（若不使用默认名

#### 称）。

#### MF 空间不能超过卡EEPROM 空间容量，若建MF 空间小于EEPROM 空间，则剩余

#### 空间不可用。

#### 11 字节文件头

#### （文件类型，文件标识符，文件主体空间大小，权限，校验等）

#### 文件主体


**4.3.** 文件访问方式文件访问方式文件访问方式文件访问方式

 主文件MF ：复位后自动被选择，在任何一级子目录下可通过文件标识3F 00 或MF
名称来选择MF 。创建时默认名称为1PAY.SYS.DDF01。

 目录文件DF：通过文件标识符或目录名称选择目录文件DF。

 二进制文件：在满足读条件时可使用READ BINARY 读取，在满足写条件时UPDATE
BINARY 更改二进制文件内容。

 定长记录文件：在满足读条件时可使用READ RECORD 读指定记录，在满足写条件
时 使 用 UPDATE RECORD 更改指定 记 录。 在 满 足追加 条 件 时 可 使 用 APPEND
RECORD 在文件末尾追加一条记录。

 循环文件：在满足读条件时可使用READ RECORD 读指定记录，在满足追加条件时
可使用APPEND RECORD 在文件开头追加一条记录，当记录写满后自动覆盖最早写
的记录，最后一次写入的记录，其记录号总是 1 ，上次写入的记录号是 2 ，依次类推。

 钱包文件：在满足使用条件时可用GET BALANCE 读余额或在规定的密钥控制下完成
圈存、圈提、消费、取现、修改透支限额。

 变长记录文件：在满足读条件时可使用READ RECORD 读出指定记录，在满足写条
件时可以使用UPDATE RECORD 写一条新记录或更改已存在的记录，或用APPEND
RECORD 在文件末尾追加一条新记录。变长记录文件的格式为TLV 格式，Tag 为 1
字节记录标识，L为一字节记录数据域长度。V为L字节数据值。在执行UPDATE
RECORD 更改已存在的记录时，新写的整条记录长度必须和原来的整个记录长度相
等，否则该命令不能成功执行。

 KEY 文件及其文件中的密钥：每个DF 或MF 下只能有一个KEY 文件，且必须最先
被建立，在任何情况下密钥数据均无法读出。当进入DF 或MF 时，若该目录下无KEY
文件和其它文件，则在该目录下可任意建立文件和读写文件而不受文件访问权限的限
制。一旦离开该目录再进入此目录时，将遵循文件的访问权限。

 在KEY 文件中可以存放多个密钥，每个密钥为一条可变长的记录，记录的长度为密
钥数据长度加 8 。如Triple DES 密钥记录的长度为 24 字节，Single DES 密钥记录的长
度为 16 字节。

 在满足KEY 文件增加密钥的权限时可用WRITE KEY 增加一条密钥记录，在满足某
个密钥规定的更改权限时可使用WRITE KEY 更改密钥数据，在满足使用权限时才可
使用相应的密钥进行认证或密码运算。

 密钥具有独立性，用于一种特定功能的加密/解密密钥不能被任何其它功能所使用，包
括保存在IC 卡中的密钥和用来产生、派生、传输这些密钥的密钥。

 口 令 密 钥： 在 满 足 口 令 密 钥 的 使 用 权 限时 ， 可 用 VERIFY 核 对口 令， 或 PIN
CHANGE/UNBLOCK 更改并解锁口令.在核对口令通过之后，设置安全状态寄存器的
值为该口令密钥规定的后续状态值。口令密钥中提供错误次数计数器，每次核对口令
失败时错误次数计数器自动减一，当错误次数达到 0 时，口令密钥被自动锁住。

 解锁口令密钥：在满足使用权限时，可通过UNBLOCK 核对解锁口令而达到解锁因连
续核对口令错误被封锁的口令密钥，同时修改新的口令。解锁口令锁死后无法再被解
锁。

 外部认证密钥：在满足使用权限时可执行EXTERNAL AUTHENTICATE 命令进行外部


#### 认证，在满足更改权限时可使用WRITE KEY 更改密钥。外部认证密钥锁死后无法被

#### 解锁。

**4.4.** 文件类型及命令集文件类型及命令集文件类型及命令集文件类型及命令集

下表为FMCOS 命令适用的文件类型及命令集，水平方向表示FMCOS 的文件类型， 垂
直方向表示FMCOS 命令集：

#### 文件类型

#### 命令

#### MF38 DF38

#### 二

#### 进

#### 制

#### 二

#### 进

#### 制

#### 二

#### 进

#### 制

#### 二

#### 进

#### 制

#### 28

#### 定

#### 长

#### 记

#### 录

#### 定

#### 长

#### 记

#### 录

#### 定

#### 长

#### 记

#### 录

#### 定

#### 长

#### 记

#### 录

#### 2A

#### 循

#### 环

#### 循

#### 环

#### 循

#### 环

#### 循

#### 环

#### 2E

#### 钱

#### 包

#### 钱

#### 包

#### 钱

#### 包

#### 钱

#### 包

#### 2F

#### 变

#### 长

#### 记

#### 录

#### 变

#### 长

#### 记

#### 录

#### 变

#### 长

#### 记

#### 录

#### 变

#### 长

#### 记

#### 录

#### 2C

#### KEY

#### 文

#### 件

#### 文

#### 件

#### 文

#### 件

#### 文

#### 件

#### 3F

#### CREATE V V V V V V V V

#### SELECT V V V V V V V V

#### READ BINARY V

#### UPDATE BINARY V

#### READ RECORD V V V

#### UPDATE RECORD V V V

#### PULL V

#### CHARGE V

#### WRITE KEY V

#### ERASE DF V V

#### CREDIT FOR LOAD V

#### DEBIT FOR PURCHASE/ CASE WITHDRAW V

#### DEBIT FOR UNLOAD V

#### GET BALANCE V

#### GET TRANSCATION PROVE V

#### INITIALIZE FOR CASE WITHDRAW V

#### INITIALIZE FOR LOAD V

#### INITIALIZE FOR PURCHASE V

#### INITIALIZE FOR UNLOAD V

#### INITIALIZE FOR UPDATE V

#### UPDATE OVERDRAW LIMIT V

#### 说明：

#### 表 格中V表 示命 令 可 用 于对应 的 文 件 类 型，如 第三 行第三 列为V 表 示用READ

#### BINARY 命令可读二进制文件，第三行第四列无V标识，表示定长记录文件不可用READ

#### BINARY 命令读取。

#### 文件类型表示文件内部结构组织形式，用一个字节来表示，如某个文件类型为28H 则

#### 表示该文件为二进制文件。文件类型在建立文件时规定。


**4.5.** 文件标识符与文件名称文件标识符与文件名称文件标识符与文件名称文件标识符与文件名称

文件标识符是文件的标识代码，用 2 个字节来表示，在选择文件时只要指出该文件的
标识代码，FMCOS 就可以找到相应文件，同一目录下的文件标识符必须是唯一的。MF 的
文件标识符是3F00，默认文件名为1PAY.SYS.DDF01。

所有文件都可以通过文件标识符用SELECT 命令进行选择，目录文件DF 还可以通过
目录名称进行选择。

短文件标识符选择可以通过READ BINARY 、UPDATE BINARY 命令的参数P1 来实
现文件的选择：若参数P1 的高三位为 100 ，则低 5 位为短的文件标识符。eg. 若P1 为81H
即 10000001 ，其中高三位为 100 ，则所选的文件标识符为 0001 。

短文 件 标识符 选 择还可 以 通 过 READ RECORD 、UPDATE RECORD 、APPEND
RECORD 、DECREASE 、INCREASE 命令的参数P2 来实现文件的选择：若P2 的高五位不
全为 0 ，低三位为 100 ，则高五位为短的文件标识符。eg. 若P2 为0CH 即 00001100 ，其中
低三位为 100 ，所选的文件标识符为 0001 。

短文件标识符选择只能用五位来决定文件标识符，所以可选择的最大文件标识符为
31 。若文 件 需 要 用短文 件 标识符 进 行 选 择，则建 立 文 件 时就需 将 文 件 标识符 取 在1-31
（00001-11111 ）之间。

选择文件后，只要文件存在，该文件就被置为当前文件，以后可以不用选择而直接对
该当前文件进行操作。


## 5. FMCOS 独特的安全体系独特的安全体系独特的安全体系独特的安全体系 ...................................................................................

#### FMCOS 的安全体系从概念上可以分为安全状态、安全属性、安全机制和密码算法。

**5.1.** 安全状态安全状态安全状态安全状态

安全状态是指卡在当前所处的一种安全级别。FMCOS 的根目录和应用目录分别具有
16 种不同的安全状态。FMCOS 在卡内部用安全状态寄存器来表示安全级别；寄存器的值
可以是 0 至F之间的某一值。

当前目录的安全状态寄存器的值在复位后或选择目录文件命令成功地被执行时被置为
0 ，如选择下级子目录时被置为 0 ，在当前目录下的口令核对或外部认证通过后该状态寄存
器值发生变化。

**5.2.** 安全属性安全属性安全属性安全属性

安全属性是指对某个文件进行某种操作时所必须满足的条件，也就是在进行某种操作
时要求安全状态寄存器的值是什么。

安全属性又称访问权限，一种访问权限在建立该文件时用一个字节指定。FMCOS 的
访问权限有别于其它任何操作系统的访问权限，它用一个区间来严格限制其他非法访问者。

访问权限为0Y 时表示要求MF 的安全状态寄存器的值大于等于Y。如某文件读的权
限为 05 表示在对该文件进行读之前必须使MF 的安全状态寄存器的值大于等于 5 。

访问权限为XY 时（X不为 0 ）表示要求当前目录的安全状态寄存器的值大于等于Y
且小于等于X。若X=Y 表示要求当前目录的安全状态寄存器的值等于X，若X<Y 表示不
允许该操作。 如某文件写的权限为 53 表示对该文件进行写之前必须使当前目录的安全状
态寄存器的值为 3 、 4 或 5 。

例：某文件读的权限为F0，写的权限为F1，代表可任意读取，写时必须满足当前目
录的安全状态寄存器的值大于等于 1 。

**5.3.** 安全机制安全机制安全机制安全机制

安全机制是指某种安全状态转移为另一种安全状态所采用的方法和手段。FMCOS 通
过核对口令和外部认证来改变安全状态寄存器的值。当在MF 下时，认证通过之后同时改
变MF 和当前目录的安全状态寄存器的值，若不在MF 下则认证通过之后只改变当前目录
的安全状态寄存器值。

当建立口令或外部认证密钥时，参数的后续状态表示该口令核对成功或外部认证成功
后，置当前目录的安全状态寄存器的值为后续状态。如某口令密钥的后续状态为 01 表示对
口令核对成功后，当前目录的安全状态寄存器的值为 1 。当上电复位后或从父目录进入子
目录或退回上级目录时，当前目录的安全状态寄存器的值均自动被置为 0 。

为更好的理解FMCOS 的安全机制，下面举一例说明：
设卡中某目录下有一个二进制文件，定义读二进制文件的权限为F1,写二进制文件权
限为F2。该目录下有一个口令密钥，口令核对通过之后的后续状态为 1 ，卡中有一外部认
证密钥，使用权限为 11 ，外部认证通过之后后续状态为 2 。


#### 请看下面的操作及当前目录的状态寄存器的变化情况：

**5.4.** 密码算法密码算法密码算法密码算法

FMCOS 支持Single DES 、Triple DES。
在建立DES 密钥时，若密钥长度为 8 字节则运算时使用Single DES 算法，若密钥长
度为 16 字节则运算时使用Triple DES 算法（MAC 只能用Single DES 算法）。

运算时使用加密还是解密算法完全由密钥类型决定，如：用于加密的密钥不可用于解
密或MAC 运算，用于外部认证的密钥也不可用于内部认证。

FMCOS 在使用DES 算法时，若数据长度大于 8 字节时使用ECB 模式，若数据长度不
是 8 的倍数时在计算过程中自动在数据后补80 00...00 使其长度为 8 的倍数。如果数据为 12
23 34 56 78 89 90 A1 B1，由于数据长度不是 8 的倍数，所以在计算过程中自动将数据改写
为 12 23 34 56 78 89 90 A1 B1 80 00 00 00 00 00 00 后再进行计算。

```
用DES 算法作外部认证的过程如下：
```

## 6. 命令与应答命令与应答命令与应答命令与应答 ...........................................................................................................

**6.1.** 命令与应答结构命令与应答结构命令与应答结构命令与应答结构

```
情形一：
命令： CLA INS P1 P2 00
应答： SW1 SW2
情形二：
命令： CLA INS P1 P2 Le
应答： Le 字节DATA SW1^ SW2^
情形三：
命令： CLA INS P1 P2 Lc DATA
应答： SW1^ SW2^
情形四：
命令： CLA INS P1 P2 Lc DATA Le
应答： Le 字节DATA SW1^ SW2^
```
CLA ：指令类别

INS ：指令类型的指令码，见1.FMCOS 简介

P1 P2：命令参数

Lc：数据域DATA 长度，该长度不可超过 239 字节

DATA ：数据域或应答数据域

Le：要求返回数据长度，Le 为 00 表示返回卡中最大数据长度，该长度不可超过 239 字节

SW1 SW2 ：卡执行命令的返回代码（状态字）

**6.2.** 状态字状态字状态字状态字 **SW1** 、、、、 **SW2** 的意义的意义的意义的意义

任意一条命令的应答至少由一个状态字（ 2 个字节）组成。状态字说明了命令处理的
情况，即命令是否被正确执行，如果未被正确执行，原因是什么。

```
SW1 SW2 意意意 意 义义义义
90 00 正确执行
62 81 回送的数据可能错误
62 83 选择文件无效，文件或密钥校验错误
63 CX X表示还可再试次数
64 00 状态标志未改变
65 81 写EEPROM 不成功
67 00 错误的长度
69 00 CLA 与线路保护要求不匹配
69 01 无效的状态
```

#### SW1 SW2 意意意 意 义义义义

#### 69 81 命令与文件结构不相容

#### 69 82 不满足安全状态

#### 69 83 密钥被锁死

#### 69 85 使用条件不满足

#### 69 87 无安全报文

#### 69 88 安全报文数据项不正确

#### 6A 80 数据域参数错误

#### 6A 81 功能不支持或卡中无MF 或卡片已锁定

#### 6A 82 文件未找到

#### 6A 83 记录未找到

#### 6A 84 文件无足够空间

#### 6A 86 参数P1 P2 错误

#### 6A 88 密钥未找到

```
6B 00 在达到Le/Lc 字节之前文件结束，偏移量错误
6C xx Le 错误
6E 00 无效的CLA
6F 00 数据无效
93 02 MAC 错误
93 03 应用已被锁定
94 01 金额不足
94 03 密钥未找到
94 06 所需的MAC 不可用
```
注意：

当SW1 的高半字节为’9’，且低半字节不为’0’时，其含义依赖于相关应用。

当SW1 的高半字节为’6’，且低半字节不为’0’时，其含义与应用无关。


## 7. FMCOS 命令命令命令命令 ........................................................................................................

**7.1.** 外部认证外部认证外部认证外部认证 **EXTERNAL AUTHENTICATE**

### 7.1.1. 定义和范围...........................................................................................................................

#### EXTERNAL AUTHENTICION 命令要求IC 卡中存在用于外部认证的密钥。

#### 在满足该密钥的使用条件且该密钥未被锁死时才能执行此命令。

#### 将命令中的数据用指定外部认证密钥解密，然后与先前产生的随机数进行比较，若一

#### 致则表示认证通过，置安全状态寄存器为该密钥规定的后续状态值，错误计数器恢复成初

#### 始值；若比较不一致则认证失败，可再试错误数减一，且不改变安全状态寄存器的值。

### 7.1.2. 命令报文...............................................................................................................................

#### EXTERNAL AUTHENTICATE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00

#### INS 82

#### P1 00

#### P2 外部认证密钥标识号

```
Lc 08
Data 8 字节加密后的随机数
Le 不存在
```
### 7.1.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域中包括 8 字节加密后的随机数。

### 7.1.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域不存在。

### 7.1.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 意意意意 义义义义

#### 62 83 密钥校验错误

#### 65 81 写EEPROM 不成功

#### 67 00 错误的长度

#### 69 81 不是外部认证密钥

#### 69 82 密钥使用条件不满足

#### 69 83 认证方法（外部认证密钥）锁死

#### 6A 82 KEY 文件未找到


#### SW1 SW2 意意意意 义义义义

#### 6A 88 密钥未找到

#### 63 CX 认证失败，可再试X次

#### 93 02 安全信息不正确

#### [例]：密钥标识号为 01 的外部认证密钥，使用权F0，更改权EF ，错误计数器 33 ，后续状

#### 态 11 ， 8 字节的密钥为01 02 03 04 05 06 07 08 ，则外部认证的过程如下：

####  卡终端从FMCOS 卡取随机数，则命令为：

#### 00 84 00 00 04

#### 由卡片返回的响应数据为：

#### BB 83 BF F3 9000

####  说明：BB 83 BF F3 为卡片返回的 4 字节的随机数。

#### 卡终端用与外部认证密钥相同的密钥01 02 03 04 05 06 07 08 对 8 字节随机数（ 4 字节

#### 的随机数+4 字节 00 ） 进行加密，加密后的结果为：

#### 74 B0 04 7D D6 81 D9 6C

####  卡终端将加密后的随机数送到卡中作外部认证，如果成功则置安全状态寄存器值为该

#### 外部认证密钥的后续状态 11 ，命令为：

#### 00 82 00 01 08 74 B0 04 7D D6 81 D9 6C


**7.2.** 取随机数取随机数取随机数取随机数 **GET CHALLENGE**

### 7.2.1. 定义和范围...........................................................................................................................

#### GET CHALLENGE 命令请求一个用于线路保护过程的随机数。

#### 除非掉电、选择了其它应用或又发出一个GET CHALLENGE 命令，该随机数仅在下

#### 一条指令时有效。

由卡产生Le 字节随机数送给终端，若下条指令为外部认证，则外部认证数据用指定
的外部认证密钥解密后与该随机数进行比较。

### 7.2.2. 命令报文...............................................................................................................................

#### GET CHALLENGE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00

#### INS 84

#### P1 00

#### P2 00

```
Lc 不存在
Data 不存在
Le 04/08
```
### 7.2.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域不存在

### 7.2.4. 响应报文数据域...................................................................................................................

```
响应报文数据域包括随机数，长度为Le 个字节。
```
### 7.2.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含含含含 义义义义

#### 6A 81 不支持此功能（无MF 或卡片已锁定）

#### 67 00 长度错误


**7.3.** 内部认证内部认证内部认证内部认证 **INTERNAL AUTHENTICATE**

### 7.3.1. 定义和范围...........................................................................................................................

#### 在满足该密钥的使用条件时才能执行此命令。

#### INTERNAL AUTHENTICATION 命令提供了利用接口设备发来的随机数和自身存储

#### 的相关密钥进行数据认证的功能。

### 7.3.2. 命令报文...............................................................................................................................

#### INTERNAL AUTHENTICATE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00

#### INS 88

#### 00 ：加密计算

#### P1 01 ：解密计算

#### 02 ：MAC 计算

#### P2 DES 密钥标识号

Lc 认证数据的长度
Data 认证数据
Le 不存在
DES 密钥标识：FMCOS 用密钥本身规定的算法进行相应的DES 运算。例如密钥类型
为 30 （或 31 或 32 ）则FMCOS 用密钥文件中的密钥对数据进行加密（或解密或生成MAC ）。

### 7.3.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域的内容是应用专用的认证数据。

### 7.3.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域的内容是相关认证数据，即DES 或MAC 运算的结果。

### 7.3.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 意意意意 义义义义

#### 62 83 密钥校验错误

#### 67 00 错误的长度

#### 69 81 密钥与运算方法不匹配

#### 69 82 不满足安全状态

#### 69 85 不满足使用条件

#### 6A 82 KEY 文件不存在

#### 6A 88 密钥未找到

#### [说明]：如果KEY 文件中没有相应类型的密钥，卡片将返回’6A 88’即密钥未找到。


#### [例1]：密钥标识号为 01 的DES 加密密钥，使用权F0，更改权EF ，算法标识 98 ，密钥版

#### 本号 05 ， 8 字节的密钥为11 22 33 44 55 66 77 88，则内部认证即DES 加密过程如下：

#### 对数据01 02 03 04 05 06 07 08 进行DES 加密，则命令为：

#### 00 88 00 01 08 01 02 03 04 05 06 07 08

#### 由卡片返回的响应数据为：

#### 17 8F 59 F8 57 8E 0D 3F 9000

#### 说明：17 8F 59 F8 57 8E 0D 3F 为内部认证即DES 加密的结果。

#### [例2]：密钥标识号为 02 的DES 解密密钥，使用权F0，更改权EF ，算法标识 98 ，密钥版

#### 本号 05 ， 8 字节的密钥为11 22 33 44 55 66 77 88，则内部认证即DES 解密过程如下：

#### 对数据17 8F 59 F8 57 8E 0D 3F 进行DES 解密，则命令为：

#### 00 88 01 02 08 17 8F 59 F8 57 8E 0D 3F

#### 由卡片返回的响应数据为：

#### 01 02 03 04 05 06 07 08 9000

#### 说明：01 02 03 04 05 06 07 08 为内部认证即DES 解密的结果。由此可以看出，相同密钥的

#### DES 加密过程和DES 解密过程互为逆过程。

#### [例3]：密钥标识号为 03 的DES MAC 密钥，使用权F0，更改权EF ，算法标识 98 ，密钥

#### 版本号 05 ， 8 字节的密钥为11 22 33 44 55 66 77 88，则内部认证即生成MAC 过程如下：

#### 对数据01 02 03 04 05 06 07 08 进行加密生成MAC ，则命令为：

#### 00 88 02 03 08 01 02 03 04 05 06 07 08

#### 由卡片返回的响应数据为：

#### A8 2A 8C EB 9000

#### 说明：A8 2A 8C EB 为通过内部认证生成的 4 字节的MAC 码。

#### [注]：内部认证实际上就是DES 运算，无论内部认证成功与否均不能改变安全状态寄存器

#### 的值。


**7.4.** 选择文件选择文件选择文件选择文件 **SELECT**

### 7.4.1. 定义和范围...........................................................................................................................

#### SELECT 命令通过文件名、文件标识符或选择下一个应用来选择IC 卡中MF 、DDF 或

#### ADF 。

#### 从IC 卡的响应报文应由回送文件控制信息FCI 组成。

### 7.4.2. 命令报文...............................................................................................................................

#### SELECT 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00

#### INS A4

#### 00 ：按文件标识符选择，选择当前目

#### 录下基本文件或子目录文件。

#### P1 04 ：用目录名称选择，选择与当前目

#### 录平级的目录、当前目录的下级子目

#### 录。

#### P2 00

Lc XX
Data 空或文件标识符或DF 名称
Le 00
P1=00：按文件标识符选择，选择当前目录下基本文件或子目录文件。
P1=04 ：用目录名称选择，选择MF ，或当前目录本身，或与当前目录平级的目录,或
当前目录的下级子目录。

```
在任何情况下均可通过标识符3F 00 或目录名称选择MF 。
```
### 7.4.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域可为空或包含文件标识符或DF 名称。

### 7.4.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域应包括所选择的DDF 或ADF 的文件控制信息（FCI）。见下表：

#### 表7.1 定义了成功选择了DDF 后回送的文件控制信息FCI：

#### 表表表表 7.1 成功选择了成功选择了成功选择了成功选择了 DDF 后回送的文件控制信息后回送的文件控制信息后回送的文件控制信息后回送的文件控制信息 FCI

#### 标志标志标志标志 值值值值 存在方式存在方式存在方式存在方式

#### 6F 文件控制信息模板 必备

#### 84 DF 名 必备

#### A5 文件控制信息专用数据 必备

#### 88 目录基本文件的短文件标识符 必备

#### 表7.2 定义了成功选择了ADF 后回送的文件控制信息FCI：

#### 表表表表 7.2 成功选择了成功选择了成功选择了成功选择了 ADF 后回送的文件控制信息后回送的文件控制信息后回送的文件控制信息后回送的文件控制信息 FCI


#### 标志标志标志标志 值值值值 存在方式存在方式存在方式存在方式

#### 6F 文件控制信息模板 必备

(^84) DF 名 必备
A5 文件控制信息专用数据 必备
9F0C 发卡方自定数据的文件控制信息 可选

### 7.4.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码为’9000’。

#### IC 卡可能回送的警告状态码如下所示：

#### SW1 SW2 含含含含 义义义义

#### 62 83 选择的文件无效

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含含含含 义义义义

#### 67 00 错误的长度

#### 6A 81 不支持此功能（无MF 或卡片已锁定）

#### 6A 82 未找到文件

#### 6A 86 参数 P1 P2 不正确

#### 范例：

#### 符合银行标准的应用目录的选择

#### 建立MF 时指定MF 下指示目录结构的基本文件（DIR ）的短文件标识符为 01 ，对主文件

#### MF 进行选择即对DDF 进行选择，则命令为：

#### 00 A4 00 00 02 3F 00

#### 由卡片返回的响应数据为：

#### 6F 15 84 0E 31 50 41 59 2E 53 59 53 2E 44 44 46 30 31 A5 03 88 01 01 9000

#### 说明：返回的信息为嵌套的TLV 格式的变长记录。’6F’为文件控制信息模板的记录标

识，’15’为文件控制信息模板的记录数据长度（不包括Tag、Length），84 0E 31 50 41 59 2E
53 59 2E 44 44 46 30 31 A5 03 88 01 01 为 21 字节的记录数据。’84’为DF 名称的记录标
识，’0E’为DF 名称的记录数据长度（不包括Tag 、Length ），31 50 41 59 2E 53 59 53 2E 44
44 46 30 31 为 14 字节的记录数据，即MF 的名称1PAY.SYS.DDF01。’A5’为文件控制信息
专用 模板的 记 录 标识，’03’ 为文 件 控 制 信息 专用 模板的 记 录 数 据 长 度（ 不 包 括 Tag 、
Length ），88 01 01 为 3 字节的记录数据。’88’为DIR 短文件标识符的记录标识，’01’为DIR
短文件标识符的记录数据长度（不包括Tag 、Length ），’01’为 1 字节的记录数据，即目录
基本文件（DIR ）的短文件标识符。

 DIR 为变长记录文件，读目录基本文件（DIR ）的第一条记录，则命令为：
00 B2 01 0C 00
由卡片返回的响应数据为：
61 11 4F 09 A0 00 00 00 03 86 98 07 01 50 04 50 42 4F 43 9000

说明：返回的信息为嵌套的TLV 格式的变长记录。’4F’为银行应用目录文件ADF 名
称的记录标识，’09’为银行应用目录文件ADF 名称的记录数据长度（不包括Tag、Length ），’
A0 00 00 00 03 86 98 07 01’为 9 字节的记录数据，即银行应用目录文件ADF 的名称。

 建立银行应用目录文件ADF 时指定ADF 下发卡方专用数据文件的短文件标识符为


#### 95 ，ADF 的名称为‘A0 00 00 00 03 86 98 07 01’，对ADF 进行选择，则命令为：

#### 00 A4 04 00 09 A0 00 00 00 03 86 98 07 01

#### 由卡片返回的响应数据为：

#### 6F 2E 84 09 A0 00 00 00 03 86 98 07 01 A5 21 9F 0C 1E 11 11 22 22 33 33 00 06 03 01 00 06

#### 19 98 08 17 00 00 00 30 19 98 08 15 19 98 12 15 55 66 90 00

#### 说明：返回的信息为嵌套的TLV 格式的变长记录。’6F’为文件控制信息模板的记录标

识，’2E’为文件控制信息模板的记录数据长度（不包括Tag 、Length ），其后为2E （HEX ）
字节的记录数据。’84’为DF 名称的记录标识，’09’为DF 名称的记录数据长度（不包括Tag、
Length ），A0 00 00 00 03 86 98 07 01 为 9 字节的记录数据，即ADF 的名称。’A5’为文件控
制信息专用数据的记录标识，’21’ 为文件控制信息专用数据的记录数据长度（不包括Tag、
Length ），其后为 21 （HEX ）字节的记录数据．’9F0C’为发卡方定义的基本数据文件的文
件控制信息的记录标识，’1E’ 为发卡方定义的文件控制信息专用数据的记录数据长度（不
包括Tag、Length ），即标识符为 0015 的二进制文件的内容（见附录中的应用举例）。’55 66’
为 2 字节的发卡方自定义FCI 数据。

 在任何目录下选择主文件MF

CLA INS P1 P2 Lc DATA
00 A4 00 00 02 3F 00
MF 将成为当前目录，且当前目录安全状态寄存器的值自动等于MF 的安全状态寄存
器的值。当然，也可用SELECT 命令对文件’1PAY.SYS.DDF01’直接选择。

 按文件标识符选择当前目录下的文件或下级子目录

CLA INS P1 P2 Lc DATA
00 A4 00 00 02 文件标识符
若选择的文件为子目录时，该目录成为当前目录，且当前目录安全状态寄存器的值变
为 0 。

```
若选择的文件为EF 时，该文件成为当前文件。
```
 通过目录名称选择DF

```
CLA INS P1 P2 Lc DATA
00 A4 04 00 XX DF 文件名
Lc 定义了DF 文件名的长度。
当前目录安全状态寄存器的值变为 0 。
```

**7.5.** 读二进制文件读二进制文件读二进制文件读二进制文件 **READ BINARY**

### 7.5.1. 定义和范围...........................................................................................................................

#### READ BINARY 命令用于读取二进制文件的内容（或部分内容）。

### 7.5.2. 命令报文...............................................................................................................................

#### READ BINARY 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00

#### INS B0

#### P1 XX

#### P2 XX

Lc 不存在；（CLA=04 时除外）
Data 不存在；（CLA=04 时，应包括MAC ）
Le XX
若P1 的高三位为 100 ，则低 5 位为短的文件标识符，P2 为读的偏移量。
若P1 的最高位不为 1 ，则P1 P2 为欲读文件的偏移量(P1 为偏移量高字节，P2 为低字
节)，所读的文件为当前文件。

### 7.5.3. 命令报文数据域...................................................................................................................

#### 一般情况下，命令报文数据域不存在。当使用安全报文时，命令报文数据域中应包含

#### MAC 。

### 7.5.4. 响应报文数据域...................................................................................................................

#### 该文件被置成线路保护时，若CLA 置为 00 时响应报文不含MAC ，CLA 置为 04 时响

#### 应报文包含MAC 。

### 7.5.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 意意意意 义义义义

#### 62 81 部分回送的数据可能有错

#### 67 00 错误的长度

#### 69 81 不是二进制文件

#### 69 82 读的条件不满足

#### 6A 81 不支持此功能（无MF 或MF 已锁定）

#### 6A 82 未找到文件

#### 6B 00 参数错误（偏移地址超出了EF ）


#### [ 注注注注 ] ：：：：若文件校验不正确，卡将送出所读的数据，并给出警告状态 SW1 SW2=6281。若下

#### 次重写该文件，卡将重新计算校验。读一个未曾写过数据的二进制文件也将返回’6281’。

#### [ 例例例例 1] ：：：：文件标识符为 0005 的二进制文件，文件主体空间的大小为 8 个字节，建立时不采

#### 用线路保护。

#### 读出自偏移量 01 开始到文件结束的所有数据，不进行线路保护，则命令为：

#### 00 B0 85 01 00

#### 由卡片返回的响应数据为：

#### 11 22 33 44 55 66 77 9000

#### [例例例例 2] ：：：：文件标识符为 0001 的二进制文件，文件主体空间的大小为 8 个字节，建立时采用

#### 线路保护。

#### 读出自偏移量 00 开始到文件结束的所有数据，使用线路保护密钥进行线路保护，则命

#### 令为：

#### 04 B0 00 00 04 82 26 99 9B

#### 说明：由于P1 的最高位不为 1 ，则欲写文件的偏移量为00 00 ，所读的文件为当前文件，

#### 82 26 99 9B 为使用线路保护密钥生成的 4 字节MAC 码。

#### 由卡片返回的响应数据为：

#### 01 02 03 04 05 FF FF FF 38 F4 EA 15 9000

#### [ 例例例例 3] ：：：：文件标识符为 0005 的二进制文件，文件主体空间的大小为 8 个字节，建立时采用

#### 线路加密保护。

#### 读出自偏移量 02 开始 10 字节数据，使用线路保护密钥进行线路加密保护，1C BD 1F

#### 23 F5 4F 8C 9A 为 10 80 00 00 00 00 00 00 的加密数据,则命令为：

#### 04 B0 85 02 0C 1C BD 1F 23 F5 4F 8C 9A DC 8B 2D 0F

#### 由卡片返回的响应数据为：

#### 6E 68 85 9B 17 04 7E D9 8A 75 BA 0B 9000

#### 说明：6E 68 85 9B 17 04 7E D9 为使用线路保护密钥对数据66 77 88 FF FF FF 加密后的结

#### 果，8A 75 BA 0B 为使用线路保护密钥生成的 4 字节MAC 码。

#### [ 注注注注 ] ：：：：此处使用到的线路保护密钥为文件线路保护密钥（ 36 密钥）。


**7.6.** 读记录文件读记录文件读记录文件读记录文件 **READ RECORD**

### 7.6.1. 定义和范围...........................................................................................................................

#### READ RECORD 命令用于读取定长记录文件、循环文件、钱包文件和变长记录文件

#### 的内容。IC 卡的响应由回送记录组成。

### 7.6.2. 命令报文...............................................................................................................................

#### READ RECORD 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00/04

#### INS B2

#### P1 见表7.3

#### P2 见表7.4

```
Lc 不存在（CLA=04 时除外）
Data 不存在（CLA=04 时除外）
```
```
Le
```
#### 00 ：表示读取整条记录

#### XX ：表示要读取的字节数

#### 表表表表 7.3 READ RECORD 命令中命令中命令中命令中 P1 的含义的含义的含义的含义

#### 类型类型类型类型 P1 的含义的含义的含义的含义

#### 定长记录文件 记录号，若该文件有N条记录，则记录号可以是1~N。

#### 变长记录文件

#### 记录号，若该文件有N条记录，则记录号可以是1~N。（参数P2 含义如下）

#### 记录标识，如按记录标识来读，则P2 的低 3 位必须为’000’。

#### 循环文件 记录号，最新写入的记录号为 01 ，上 1 条记录的记录号为02, 依次类推...

#### 表表表表 7.4 READ RECORD 命令中命令中命令中命令中 P2 的含义的含义的含义的含义

```
b8 b7 b6 b5 b4 b3 b2 b1 P2 的含义的含义的含义的含义
X X X X X 1 0 0 b4-b8 为短文件标识符
0 0 0 0 0 1 0 0 当前文件
```
### 7.6.3. 命令报文数据域...................................................................................................................

#### 当无安全报文使用时，命令报文数据域不存在。使用安全报文时，命令报文的数据域

#### 中应包含MAC 。

### 7.6.4. 响应报文数据域...................................................................................................................

#### 所有执行成功的READ RECORD 命令的响应报文数据域由读取的记录组成。

#### 若该记录文件为线路保护文件且CLA 为 04 则回送的数据还包括 4 字节的MAC 。

### 7.6.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。


#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 意意意意 义义义义

#### 62 81 回送的数据可能有错

#### 67 00 错误的长度

#### 69 81 命令与文件结构不相容

#### 69 82 读的条件不满足

#### 6A 81 不支持此功能（无MF 或MF 已锁定）

#### 6A 82 未找到文件

#### 6A 83 未找到记录

#### 6C XX 记录实际长度为XX 字节

#### [ 例例例例 1] ：：：：文件标识符为 0001 的定长记录文件，它有 3 条记录，每条记录长度为 12 个字节。

#### 读出定长记录文件中记录号为 02 的记录，不进行线路保护，则命令为：

#### 00 B2 02 0C 00，由卡片返回的响应数据为：

#### 01 02 03 04 05 06 07 08 09 0A 0B 0C 9000

#### 说明：01 02 03 04 05 06 07 08 09 0A 0B 0C 为读出的记录号为 02 的记录的内容。

#### [ 例例例例 2] ：：：：文件标识符为 0003 的循环文件，它有 3 条记录，每条记录长度为 12 个字节。

#### 读出循环文件中记录号为 01 的记录，即最新写入的记录，不进行线路保护，则命令为：

#### 00 B2 01 1C 00

#### 由卡片返回的响应数据为：

#### 11 22 33 44 55 66 77 88 99 AA BB CC 9000

#### 说明：11 22 33 44 55 66 77 88 99 AA BB CC 为读出的记录号为 01 的记录的内容。

#### [ 例例例例 3] ：：：：文件标识符为 0007 的变长记录文件。

####  按记录标识来读，读出变长记录文件中记录标识为AA 的记录，不进行线路保护，则

#### 命令为：

#### 00 B2 AA 38 00

#### 说明：由于按记录标识来读，则P2 的低 3 位必须为’000’。

#### 由卡片返回的响应数据为：

#### AA 01 11 9000

#### 说明：读出的是TLV 格式的记录，AA 为记录标识， 01 表示记录数据的长度， 11 为 1

#### 个字节的记录数据。

####  按记录号来读，读出变长记录文件中的第 1 条记录，不进行线路保护，则命令为：

#### 00 B2 01 3C 00

#### 说明：由于按记录号来读，则P2 的低 3 位必须为’100’。

#### 由卡片返回的响应数据为：

#### AA 01 11 9000

#### 说明：读出的是TLV 格式的记录，AA 为记录标识， 01 表示记录数据的长度， 11 为 1

#### 个字节的记录数据。

#### [ 注注注注 ] ：：：：READ RECORD 命令使用文件线路保护密钥进行线路保护。


**7.7.** 写二进制文件写二进制文件写二进制文件写二进制文件 **UPDATE BINARY**

### 7.7.1. 定义和范围...........................................................................................................................

#### UPDATE BINARY 命令用于写二进制文件、FAC 秘密钥文件、FAC 公开钥文件。

### 7.7.2. 命令报文...............................................................................................................................

#### UPDATE BINARY 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00/04

#### INS D6/D0

#### P1 XX

#### P2 XX

```
Lc XX
Data 写入文件的数据
Le 不存在
若P1 的高三位为 100 ，则低 5 位为短的二进制文件标识符，P2 为欲写文件的偏移量。
若P1 的最高位不为 1 ，则P1 P2 为欲写文件的偏移量，所写的文件为当前文件。
Lc 表示要写入的字节数。
```
 若为线路保护，Lc 为写入数据的长度+4 字节MAC 。

 若为加密线路保护，Lc 为加密后数据的长度+4 字节MAC 。

### 7.7.3. 命令报文数据域...................................................................................................................

#### 报文数据包括要写入的新数据。

#### 若为线路保护文件数据域应包含 4 字节MAC 码

#### 若为线路加密保护文件数据域应包含加密后的数据及 4 字节MAC 码

### 7.7.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域不存在。

### 7.7.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 可能回送的错误如下所示：

#### SW1 SW2 意意意意 义义义义

#### 65 81 写EEPROM 失败

```
67 00 长度错误（Lc 域为空）
69 81 不是二进制或FAC 密钥文件不可写
69 82 写的条件不满足
69 87 无安全报文
6A 81 不支持此功能（无MF 或MF 已锁定）
```

#### SW1 SW2 意意意意 义义义义

#### 6A 82 未找到文件

#### 6B 00 参数错误（偏移地址超出了EF ）

#### [ 例例例例 1] ：：：：文件标识符为 0001 的二进制文件，文件主体空间的大小为 8 个字节，建立时不采

#### 用线路保护。

####  选择二进制文件，则命令为：

#### 00 A4 00 00 02 00 01

####  写二进制文件，不进行线路保护，则命令为：

#### 00 D6 00 00 02 01 02

#### 说明：由于P1 的最高位不为 1 ，则欲写文件的偏移量为00 00 ，所写的文件为当前文

#### 件。

#### [ 例例例例 2] ：：：：文件标识符为 0005 的二进制文件，文件主体空间的大小为 8 个字节，建立时采用

#### 线路保护。

#### 写二进制文件，必须使用线路保护密钥进行线路保护，则命令为：

#### 04 D6 85 01 06 11 22 16 0A C8 C5

#### 说明：由于P1 的最 3 位为 100 ，则低 5 位表示短文件标识符 05 ，欲写文件的偏移量

#### P2 为 01 ，16 0A C8 C5 为使用线路保护密钥生成的 4 字节MAC 码。

#### [ 例例例例 3] ：：：：文件标识符为 0005 的二进制文件，文件主体空间的大小为 8 个字节，建立时采用

#### 线路加密保护。

#### 写二进制文件，必须使用线路保护密钥进行线路加密保护，则命令为：

#### 04 D6 85 00 0C 19 47 93 07 DF 79 1D 7F 24 1E D0 03

#### 说明：19 47 93 07 DF 79 1D 7F 为使用线路保护密钥对数据01 02 03 04 05 06 07 加密

#### 后的结果，24 1E D0 03 为使用线路保护密钥生成的 4 字节MAC 码。

#### [ 注注注注 ] ：：：：此处使用到的线路保护密钥为文件线路保护密钥（ 36 密钥）。


**7.8.** 写记录文件写记录文件写记录文件写记录文件 **UPDATE RECORD**

### 7.8.1. 定义和范围...........................................................................................................................

#### UPDATE RECORD 命令用于更新定长、变长或循环记录文件。

### 7.8.2. 命令报文...............................................................................................................................

#### UPDATE RECORD 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00/04

#### INS DC

#### P1 P1＝‘ 00 ’指明当前记录

#### P≠‘ 00 ’是所规定记录的号

#### P2 见表7.5

```
Lc XX
Data 写入的数据
Le 不存在
```
**[** 注注注注 **]** ：：：：P1 为记录号，若该文件有N条记录，则记录号可以是1-N。

Lc 表示要写入的字节数，若为线路保护，Lc 为写入数据的长度+4 字节MAC ；若为加
密线路保护，Lc 为加密后数据的长度+4 字节MAC 。

#### 表表表表 7.5 UPDATE RECORD 命令中命令中命令中命令中 P2 的含义的含义的含义的含义^

```
b8 b7 b6 b5 b4 b3 b2 b1 含含含含 义义义义
X X X X X - - - b4-b8 为短文件标识符
0 0 0 0 0 - - - 当前文件
1 1 1 1 1 - - - 保留
```
- - - - - 1 0 0 使用P1 中的记录号
- - - - - 0 0 0 P1 指定标示的第一个记录
- - - - - 0 0 1 P1 指定标示的最后一个记录
- - - - - 0 1 0 P1 指定标示的下一个记录
- - - - - 0 1 1 P1 指定标示的上一个记录

**[** 注注注注 **]** ：：：：循环记录文件只能用P1=’00’，P2=’03’来添加。

### 7.8.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域由写入的记录数据组成。如果更新的文件为变长记录文件，则数据域

#### 需要按照TLV格式填写

#### 若为线路保护则由写入的记录数据附上 4 字节MAC 组成。

#### 若为线路加密保护则由被加过密的记录数据附上 4 字节MAC 码组成。

### 7.8.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域不存在。


### 7.8.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 可能回送的错误如下所示：

#### SW1 SW2 意意意意 义义义义

#### 62 83 选择文件无效

#### 65 81 写EEPROM 失败

#### 67 00 长度错误

#### 69 81 当前文件不是定长或变长记录文件

#### 69 82 写的条件不满足

#### 6A 81 不支持此功能（无MF 或MF 已锁定）

#### 6A 82 未找到文件

#### 6A 83 未找到记录

#### 6A 84 文件无足够空间

#### [ 例例例例 1] ：：：：文件标识符为 0002 的定长记录文件，它有 3 条记录，每条记录长度为 12 个字节，

#### 建立时不采用线路保护。

#### 写定长记录文件，不进行线路保护，则命令为：

#### 00 DC 01 14 0C 01 02 03 04 05 06 07 08 09 0A 0B 0C

#### 说明：01 02 03 04 05 06 07 08 09 0A 0B 0C 为写入的数据。

#### [ 例例例例 2] ：：：：文件标识符为 0001 的定长记录文件，它有 3 条记录，每条记录长度为 12 个字节，

#### 且建立时采用了线路保护。

#### 写定长记录文件，必须使用线路保护密钥进行线路保护，则命令为：

#### 04 DC 01 0C 10 01 02 03 04 05 06 07 08 09 0A 0B 0C 15 BD 23 3C

#### 说明：01 02 03 04 05 06 07 08 0A 0B 0C 为写入的数据，15 BD 23 3C 为使用线路保护

#### 密钥生成的 4 字节MAC 。

#### [ 例例例例 3] ：：：：文件标识符为 0001 的定长记录文件，它有 3 条记录，每条记录长度为 12 个字节，

#### 且建立时采用了加密线路保护。

#### 写定长记录文件，必须使用线路保护密钥进行线路加密保护，则命令为：04 DC 01 0C

#### 14 A5 DF E4 94 0B 63 DC 35 47 1E D8 A8 CD 09 88 43 C9 52 13 A6

#### 说明：A5 DF E4 94 0B 63 DC 35 47 1E D8 A8 CD 09 88 43 为使用线路保护密钥对数据

#### 01 02 03 04 05 06 07 08 09 0A 0B 0C 加密后的结果，C9 52 13 A6 为使用线路保护密钥生成

#### 的 4 字节MAC 。

#### [ 例例例例 4] ：：：：文件标识符为 0001 的变长记录文件，建立时不采用线路保护。

#### 在变长记录文件中建立 1 条记录标识为AA 的新记录，不进行线路保护，则命令为：

#### 00 DC 00 0A 04 AA 02 11 22

#### 修改记录标识为AA 的记录，同时将记录标识改为CC ，不进行线路保护，则命令为：


#### 00 DC AA 08 04 CC 02 33 44

#### [ 例例例例 5] ：：：：文件标识符为 0003 的循环文件，它有 2 条记录，每条记录长度为 12 个字节，建立

#### 时不采用线路保护。

#### 往循环文件中追加 1 条记录，不进行线路保护，则命令为：

#### 00 DC 01 1A 0C 11 22 33 44 55 66 77 88 99 AA BB CC

#### [ 注注注注 ] ：：：：UPDATE RECORD 命令使用文件线路保护密钥进行线路保护


**7.9.** 添加记录文件添加记录文件添加记录文件添加记录文件 **APPEND RECORD**

### 7.9.1. 定义和范围...........................................................................................................................

#### APPEND RECORD 命令用于在定长、变长或循环记录文件结尾添加记录。

#### 命令在成功执行后，设置记录指针到所更新记录。

### 7.9.2. 命令报文...............................................................................................................................

#### APPEND RECORD 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00/04

#### INS E2

#### P1 00

#### P2 见表7.6

```
Lc XX
Data 写入的数据
Le 不存在
```
#### 表表表表 7.6 APPEND RECORD 命令中命令中命令中命令中 P2 的含义的含义的含义的含义

```
b8 b7 b6 b5 b4 b3 b2 b1 含含含含 义义义义
X X X X X 1 0 0 b4-b8 为短文件标识符
0 0 0 0 0 1 0 0 当前文件
```
### 7.9.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域由写入的记录数据组成。如果更新的文件为变长记录文件，则数据域

#### 需要按照TLV 格式填写

#### 若为线路保护则由写入的记录数据附上 4 字节MAC 组成。

#### 若为线路加密保护则由被加过密的记录数据附上 4 字节MAC 码组成。

### 7.9.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域不存在。

### 7.9.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC可能回送的错误如下所示：

#### SW1 SW2 意意意意 义义义义

#### 62 83 选择文件无效

#### 65 81 写EEPROM 失败

#### 67 00 长度错误

#### 69 81 当前文件不是定长或变长记录文件

#### 69 82 写的条件不满足


#### 6A 81 不支持此功能（无MF 或MF 已锁定）

#### 6A 82 未找到文件

#### 6A 84 文件无足够空间


**7.10.** 验证口令验证口令验证口令验证口令 **VERIFY PIN**

### 7.10.1. 定义和范围.........................................................................................................................

#### VERIFY PIN 命令用于校验命令数据域的口令密钥的正确性。

### 7.10.2. 命令报文.............................................................................................................................

#### VERIFY PIN 命令的编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00

#### INS 20

#### P1 00

#### P2 口令密钥标识符

Lc 02-06
Data 外部输入的口令密钥
Le 不存在
在满足该口令密钥文件使用权限时才可执行该命令。
若口令验证成功，则安全状态寄存器的值被置成该密钥的后续状态，同时口令错误计
数器被置成初始值。

若验证错误，则口令可试次数减一，若口令已被锁死，则不能再执行该命令，可以用
PBOC_IC 命令对其进行解锁，重装等操作，并可能成功地返回 9000 。

[说明]：若PIN 值的后面字节为连续的FF ，校验时可以忽略该段字节，但若PIN 值为全
FF，则最少应输入一个FF 值。

### 7.10.3. 命令报文数据域.................................................................................................................

#### 命令报文数据域由持卡者输入的口令密钥组成。若为线路保护则由口令密钥附上 4 字

#### 节MAC 码组成。若为线路加密保护则由被加过密的口令密钥附上 4 字节MAC 码组成。

### 7.10.4. 响应报文数据域.................................................................................................................

#### 响应报文数据域不存在。

### 7.10.5. 响应报文状态码.................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### 当前的应用选择中，命令数据域中外部输入的口令密钥与卡中存放的口令密钥校验失

#### 败时，IC 卡将回送SW2=CX ，X表示个人密码允许重试的次数：当卡回送C0 时，表示不

#### 能重试口令密钥。此时再使用VERIFY PIN 命令时，将回送失败状态码 SW1 SW2= ‘6983’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 意意意意 义义义义

#### 62 83 口令密钥校验错误

#### 65 81 写EEPROM 错误

#### 67 00 错误的长度


#### 69 81 不是口令密钥

#### 69 82 密钥使用条件不满足

#### 69 83 认证方法（口令密钥）锁死

#### 6A 82 KEY 文件未找到

#### 63 CX 校验失败，X表示允许重试的次数

#### 93 02 密钥线路保护错误

#### 94 03 密钥未找到

**[** 例例例例 **1]** ：：：：如密钥标识号为 00 的 5 位字节口令密钥，值为 12345 ，则Verify PIN 的命令
为：

```
00 20 00 00 03 12 34 5F31 32 33 34 35 36
```

**7.11.** 擦除目录文件擦除目录文件擦除目录文件擦除目录文件 **ERASE DF**

### 7.11.1. 定义和范围.........................................................................................................................

#### ERASE DF 命令用于在满足目录擦除条件的情况下，擦除当前DF 下所有文件（不包

#### 括目录本身）。

### 7.11.2. 命令报文.............................................................................................................................

#### ERASE DF 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 0E

#### P1 00

#### P2 00

```
Lc 00
Data 不存在
Le 不存在
```
### 7.11.3. 命令报文数据域.................................................................................................................

#### 命令报文数据域不存在。

### 7.11.4. 响应报文数据域.................................................................................................................

#### 响应报文数据域不存在。

### 7.11.5. 响应报文状态码.................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含含含含 义义义义

#### 65 81 写EEPROM 不成功

#### 69 82 擦除权限不满足

#### 说明：擦除当前DF 下所有文件，擦除DF 后即可任意在该DF 下建立文件而不受建立

#### 权限的控制，当建立KEY 文件后下次再进入DF 将受权限控制，因此建议DF 的擦除权限

#### 应设计为最高，若不允许擦除设为EF 即可。擦除DF 成功后，DF 下所有基本文件EF 及

#### 下级目录文件DF 都将丢失，成为一个空的DF ，但DF 本身及其DF 的各权限及空间大小

#### 均不变。

#### 若当前目录为MF ，则除MF 外卡上所有基本文件EF 和目录文件DF 均被删除。


**7.12.** 增加或修改密钥增加或修改密钥增加或修改密钥增加或修改密钥 **WRITE KEY**

### 7.12.1. 定义和范围.........................................................................................................................

#### WRITE KEY 命令用于在密钥文件中增加或修改密钥

### 7.12.2. 命令报文.............................................................................................................................

#### WRITE KEY 命令报文如下

#### 代码代码代码代码 值值值值

#### CLA 80/84

#### INS D4

#### 01 ：表示此条WRITE KEY 命令

#### P1 用来添加密钥^

#### XX ：表示此条WRITE KEY 命令

#### 用来更新P1 中指定类型的密钥

#### P2 密钥标识

```
Lc
Data
```
#### 见命令报文数据域

```
Le 不存在
```
### 7.12.3. 命令报文数据域.................................................................................................................

####  CASE1：增加DES 加密、DES 解密、DESMAC 、内部密钥、消费、圈提、圈存、修

#### 改透支限额

**CLA INS P1 P2 Lc DATA**

```
80 D4 01 密钥标识 0D/15
```
#### 30/31/32/34/35/3

#### C/3D/3E/3F

#### 使用权 更改权

#### 密钥版

#### 本号

#### 算法

#### 标识

#### 8 或 10 字节密

#### 钥

####  CASE2：增加外部认证密钥

**CLA INS P1 P2 Lc DATA**
80 D4 01 密钥标识 0D/15 39 使用权 更改权 后续状态 错误计数器 8 或 10 字节密钥

####  CASE3：增加口令密钥

**CLA INS P1 P2 Lc DATA**
80 D4 01 密钥标识 07-0D 3A 使用权 EF 后续状态 错误计数器 02-08 字节口令

```
 CASE4：增加解锁口令密钥
```
**CLA INS P1 P2 Lc DATA**

```
80 D4 01 密钥标识 0D/15 37 使用权 更改权 FF 错误计数器 8 或 10 字节密钥
```
####  CASE5：增加文件线路保护、重装口令密钥的密钥


**CLA INS P1 P2 Lc DATA**
80 D4 01 密钥标识 0D/15 36/38 使用权 更改权 FF 错误计数器 8 或 10 字节密钥

#### 密钥类型密钥类型密钥类型密钥类型^ 意义意义意义意义^

#### 34 ： 内部密钥

#### 36 ： 文件线路保护密钥

#### 37 ： 解锁口令密钥

#### 38 ： 重装口令密钥的密钥

#### 39 ： 外部认证密钥

#### 3A ： 口令密钥

#### 3C ： 修改透支限额

#### 3D ： 圈提密钥

#### 3E ： 消费密钥

#### 3F ： 圈存密钥

#### 增加密钥命令编码如下：

#### 说明：

####  密钥标识不可为 FF ；

####  口令密钥的长度可变（为2-8个字节）。

####  内部密钥是用于产生内部临时密钥的密钥。

####  添加新密钥时只支持明文和明文MAC 两种方式，不支持密文加密方式

####  对于密钥也可以使用线路保护。如需进行线路保护，只需在安装密钥时将密钥类型次

#### 高位置 1 即可。如PIN 类型由3A 变为7A。

####  对于密钥也可以使用线路加密保护。如需进行线路加密保护，只需在安装密钥时将密

#### 钥类型最高位置及次高位置均置 1 即可。如内部密钥类型由 30 变为F0。

#### [注]：在一个应用下只能有一个文件线路保护密钥，一个密钥线路保护密钥，一个重装口

#### 令密钥的密钥。

#### 如果该目录下某类型密钥只有一个,则其密钥标识原则上应为’00’，否则，应从’01’顺序开

#### 始。

####  使用权限：指该密钥在使用时如核对、认证、运算时所需满足的条件。

#### 例如：使用权为 41 表示在使用该密钥时当前目录安全状态寄存器值必须大于等于 1

#### 且小于等于 4 。

####  更改权限：指用WRITE KEY 更改密钥内容的权限,在满足该条件时可使用WRITE

#### KEY 更改密钥内容，但不能改变错误计数器的值。

####  错误计数器：高半字节指出密钥可以连续错误的最多次数，低半字节指出还可以再试

#### 的次数。如果连续错误错超过规定的次数，密钥自动被锁死。

#### 例如：错误计数器的值为 33 ，表示该密钥最多可以连续错误 3 次，若输错一次则其值

#### 变为 32 ，再错一次之后变为 31 ，若下次核对或认证正确则该值变为 33 。

#### 使用解锁口令时，解锁口令正确后错误次数低半字节被设置成高半字节值，同时口令

#### 被修改。解锁口令若错误，解锁口令允许再试次数减一，解锁口令和外部认证密钥锁

#### 死后无法被解锁。

####  后续状态：当口令核对成功或外部认证成功后，置安全状态寄存器值为后续状态的低


#### 半字节。

#### 修改密钥命令编码如下：

#### 在修改时密钥时，密钥头和密钥值等数据的长度必须和原有密钥相同。

#### 并使用如下参数

#### P1 P2

#### 密钥类型 密钥标识

#### 数据域参数和添加密钥时相同数据域参数和添加密钥时相同数据域参数和添加密钥时相同数据域参数和添加密钥时相同。。。。

### 7.12.4. 响应报文数据域.................................................................................................................

#### 响应报文数据域不存在。

### 7.12.5. 响应报文状态码.................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 意意意意 义义义义

#### 65 81 写EEPROM 不成功

#### 67 00 密钥长度错误

#### 69 82 增加或修改权限不满足

#### 69 83 密钥被锁死

#### 6A 82 KEY 文件未找到

#### 6A 88 密钥未找到

#### 6A 84 KEY 文件空间已满

#### 93 02 修改密钥时线路保护错误

#### [ 例例例例 1] ：：：：在密钥文件中明文写入密钥标识为 00 的 39 密钥（主控密钥）和标识为 00 的 36

#### 密钥（文件线路保护密钥），并且今后都使用明文更新这两条密钥。

#### 写入 39 密钥的命令报文为：

#### 80 D4 01 00 15 39 F0 FA AA 88 39 FF 39 FF 39 FF 39 FF 39 FF 39 FF 39 01 39 01

#### 卡片返回相应数据为：90 00

#### 写入 36 密钥的命令报文为：

#### 80 D4 01 00 0D 36 F0 FA FF 33 36 FF 36 FF 36 FF 36 01

#### 命令中 39 密钥的使用权限为任意权限，修改权限为A到F，外部认证后续状态为A，

#### 密钥重试次数为 8 次，密钥值为“39 FF 39 FF 39 FF 39 FF 39 FF 39 FF 39 01 39 01”。

#### 命令中 36 密钥的使用权限为任意权限，修改权限为A到F，密钥重试次数为 3 次，

#### 密钥值为“FF FF FF FF FF FF FF FF”。

#### [ 例例例例 2] ：：：：修改上例密钥文件中的 00 的 39 密钥（主控密钥）和标识为 00 的 36

#### 修改 39 密钥的命令为：

#### 80 D4 39 00 15 39 F0 FA AA 88 39 FF 39 FF 39 FF 39 FF 39 FF 39 FF 39 02 39 02

#### 修改 36 密钥的命令为：


#### 80 D4 36 00 0D 36 F0 F0 FF 66 36 FF 36 FF 36 FF 36 02

#### 命令将 39 密钥的值修改为“39 FF 39 FF 39 FF 39 FF 39 FF 39 FF 39 02 39 02 ”

#### 命令将 36 密钥的值修改为“36 FF 36 FF 36 FF 36 02”，同时将 36 密钥的错误重试次

#### 数设定在了 6 次。

#### [ 例例例例 3] ：：：：密文带MAC 更新上例中的 39 密钥和 36 密钥。

#### 首先将 39 密钥的密钥类型的高两位置 1 ，命令为：

#### 80 D4 39 00 15 F9 F0 FA AA 88 39 FF 39 FF 39 FF 39 FF 39 FF 39 FF 39 02 39 02

#### 由于高两位置 1 ，明文修改将报错，此时需使用密文带MAC 方式修改密钥，命令为：

#### 84 D4 39 00 1C XX XX XX XX XX XX XX XX XX XX XX XX XX XX.....

#### （密文数据由以下数据加密而成15 F9 F0 FA AA 88 39 FF 39 FF 39 FF 39 FF 39 FF 39 FF 39

#### 03 39 03 80 00，使用原39 00 密钥“39 FF 39 FF 39 FF 39 FF 39 FF 39 FF 39 02 39 02”，再

#### 使用同样密钥计算MAC ）

#### 36 密钥按照 39 密钥同样方法更新，命令为：

#### 80 D4 36 00 0D F6 F0 F0 FF 66 36 FF 36 FF 36 FF 36 02

#### 80 D4 36 00 14 XX XX XX XX XX XX.......

#### （密文数据由以下数据加密而成0D F6 F0 F0 FF 66 36 FF 36 FF 36 FF 36 03 80 00，使用原

#### 39 00 密钥“39 FF 39 FF 39 FF 39 FF 39 FF 39 FF 39 02 39 02 ”，再使用同样密钥计算MAC ）


**7.13.** 建立文件建立文件建立文件建立文件 **CREATE FILE**

### 7.13.1. 定义和范围.........................................................................................................................

#### CREATE FILE 命令用于建立文件系统，包括MF 、DF 和EF 。

### 7.13.2. 命令报文.............................................................................................................................

#### CREATE FILE 命令的报文如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS E0

#### P1

#### P2

```
文件标示 (File ID)
```
```
Lc XX
Data 文件控制信息和DF 名称
```
### 7.13.3. 命令报文数据域.................................................................................................................

#### 命令报文数据域包括文件控制信息，如果建立的文件为DF ，则还可能包括DF 的名称。

#### DF 的名称长度为2~16 字节。各种文件的控制信息列表如下：

####  目录文件DF（包括MF ）

文件类型文件类型文件类型文件类型 文件空间文件空间文件空间文件空间 建立权限建立权限建立权限建立权限 (^) 擦除权限擦除权限擦除权限擦除权限 应用文件应用文件应用文件应用文件 **ID** 保留字保留字保留字保留字 **DF** 名称名称名称名称
38 2 字节 1 字节 1 字节 XX FF FF 5~16 字节
说明：建立MF 时，P1 P2 参数固定为3F 00，文件空间为FF FF 。保留字和DF 名称
域为卡片的传输代码，该传输代码事先约定，默认值为 8 字节FF 。
应用文件ID ：如在Select File 时需要返回的文件为 0015 ，则此字节为 95 。
目录文件（除MF 外）建立后不能被自动选择。
 基本文件EF （包括密钥文件）
文件类型文件类型文件类型文件类型 命令报文数据域命令报文数据域命令报文数据域命令报文数据域
文件类型文件类型文件类型文件类型 **BYTE1 BYTE2~3 BYTE4 BYTE5 BYTE6 BYTE7**
二进制文件 28 文件空间 读权限 写权限 FF 见说明
定长记录文件 2A 文件空间 读权限 写权限 FF 见说明
循环文件 2E 文件空间 读权限 写权限 FF 见说明
PBOC ED/EP 2F 02 08 使用权限 保留（ 00 ） FF 交易记录^
短标识
变长记录文件 2C 文件空间 读权限 写权限 FF 见说明
密钥文件 3F 文件空间

#### DF 文件

#### 短标识符

#### 增加权限 FF FF

####  如果希望使用明文MAC 写BYTE1 最高位需置 1 （“ 28 ”变为“A8”）

#### 如果希望使用加密写，则BYTE1 次高位需置 1 （“ 28 ”变为“ 68 ”）

####  基本文件EF（密钥文件、PBOC ED/EP 文件除外）的保留字的最后一个字节定义如下：

```
（设该字节的为定义为b8～b1）：
```

```
b8 b7 b6 b5 b4 b3 b2 b1 含含含 含 义义义义
1 - - - - - - - 文件不支持带线路保护读
0 - - - - - - - 文件必须使用带线路保护读
```
- 1 1 1 - - - - 保留为 1
- - - - 1 1 - - 标识为 00 的密钥
- - - - 1 0 - - 标识为 01 的密钥
- - - - 0 1 - - 标识为 02 的密钥
- - - - 0 0 - -

#### 读操作时使用

#### 的密钥标识

#### 标识为 03 的密钥

#### - - - - - - 1 1 标识为 00 的密钥

#### - - - - - - 1 0 标识为 01 的密钥

#### - - - - - - 0 1 标识为 02 的密钥

#### - - - - - - 0 0

#### 写操作时使用

#### 的密钥标识

#### 标识为 03 的密钥

####  对于记录文件（包括定长记录文件、循环文件、钱包文件），文件空间第一个字节为记

#### 录总个数，第二个字节为记录长度；物理空间总数为（个数*(记录长度+1) +8）。

####  对于密钥文件中所谓DF 文件短标识符、说明如下：当高三位为 000 时，为DDF 当高

#### 三位为 100 时为ADF 的短文件标示符号。

####  对于PBOC ED/EP 中所谓的TAC 密钥标识是指该ED/EP 在计算TAC 时使用到的密钥

#### 类型为‘ 34 ’密钥的标识；所谓交易明细文件是指ED/EP 在记录交易明细时用到的短

#### 文件标识符。

####  所有文件建立后不能自动被选择。

### 7.13.4. 响应报文数据域.................................................................................................................

#### 响应报文数据域不存在。

### 7.13.5. 响应报文状态码.................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 意意意意 义义义义

#### 67 00 错误的长度

#### 69 82 建立权限不满足

#### 6A 80 记录个数小于 2 或目录级数大于三级

#### 6A 84 文件没有足够空间

#### 6A 86 文件已存在


## 8. 中国金融中国金融中国金融中国金融 IC 卡专用卡专用卡专用卡专用命令命令命令命令 ....................................................................................

**8.1.** 卡片锁定卡片锁定卡片锁定卡片锁定 **CARD BLOCK**

### 8.1.1. 定义和范围...........................................................................................................................

#### CARD BLOCK 命令使卡中所有应用永久失效。

#### 当CARD BLOCK 命令成功地完成后，所有后续的命令都将回送状态码“不支持此功

#### 能”（SW1 SW2=‘6A81’），且不执行任何其它操作。

### 8.1.2. 命令报文...............................................................................................................................

#### CARD BLOCK 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 84

#### INS 16

#### P1 00

#### P2 00

```
Lc 04
Data MAC （由线路保护密钥生成）
Le 不存在
```
### 8.1.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域包括报文鉴别代码（MAC ）数据元。

### 8.1.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域不存在。

### 8.1.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含含含含 义义义义

#### 64 00 状态标志未改变

#### 65 81 写EEPROM 不成功

#### 69 87 安全报文数据项丢失

#### 69 88 安全报文数据项不正确


**8.2.** 应用解锁应用解锁应用解锁应用解锁 **APPLICATION UNBLOCK**

### 8.2.1. 定义和范围...........................................................................................................................

#### APPLICATION UNBLOCK 命令用于恢复当前的应用。

#### 当APPLICATION UNBLOCK 命令成功地完成后，用APPLICATION BLOCK 命令产

#### 生的对应用命令响应的限制将被取消。

#### 如果对某应用连续三次解锁失败，则IC 卡将永久锁定此应用。

### 8.2.2. 命令报文...............................................................................................................................

#### APPLICATION UNBLOCK 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 84

#### INS 18

#### P1 00

#### P2 00

```
Lc 04
Data MAC （由文件线路保护密钥生成）
Le 不存在
```
### 8.2.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域包括报文鉴别代码（MAC ）数据元。

### 8.2.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域不存在。

### 8.2.5. 响应报文状态码...................................................................................................................

#### 无论应用是否已经失效，此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含含含含 义义义义

#### 65 81 写EEPROM 不成功

#### 69 82 不满足安全状态

#### 69 83 认证方式锁定

#### 69 88 安全报文数据项不正确

#### 93 03 应用永久锁定

#### [ 注注注注 ] ：：：：此命令的执行并不改变电子存折或电子钱包联机交易序号的值。


**8.3.** 应用锁定应用锁定应用锁定应用锁定 **APPLICATION BLOCK**

### 8.3.1. 定义和范围...........................................................................................................................

#### APPLICATION BLOCK 命令使当前选择的应用失效。

#### 当APPLICATION BLOCK 命令成功地完成后，用SELECT 命令选择已失效的应用，

#### 将回送状态码“选择文件无效”（SW1 SW2=‘6A81’）。

#### 对其它命令的影响跟据不同应用而定。

### 8.3.2. 命令报文...............................................................................................................................

#### APPLICATION BLOCK 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 84

#### INS 1E

#### P1 00

#### 00 ：临时锁定

#### P2

#### 01 ：永久锁定

Lc 04
Data MAC （由文件线路保护密钥生成）
Le 不存在
P2=00 ：此命令执行成功后可锁定应用，但该应用可以用 APPLICATION UNBLOCK
命令解锁，可由SELECT 命令选择进入该目录，但对文件操作时返回6A81 。

P2=01：此命令执行成功后将永久锁定应用，IC 卡将设置一个内部标志以表明不允许
执行APPLICATION UNBLOCK 命令，可由SELECT 命令选择进入该目录，但对文件操作
时返回6A81。

### 8.3.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域包括报文鉴别代码（MAC ）数据元。

### 8.3.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域不存在。

### 8.3.5. 响应报文状态码...................................................................................................................

#### 无论应用是否已经失效，此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含含含含 义义义义

#### 64 00 状态标志未改变

#### 65 81 写EEPROM 不成功

#### 69 82 不满足安全状态

#### 6A 86 参数 P1 P2 不正确

#### 69 88 安全报文数据项不正确


#### [ 例例例例 1] ：：：：文件标识符为3F01 的目录文件，目录名称为A00000000386980701，进行应用暂时

#### 性锁定及解锁。

####  选择该目录文件，则命令为：

#### 00 A4 04 00 09 A0 00 00 00 03 86 98 07 01

#### 返回的数据为：

#### 6F 2E 84 09 A0 00 00 00 03 86 98 07 01 A5 21 9F 0C 1E 11 11 22 22 33 33 00 06 03 01 00

#### 06 19 98 08 17 00 00 00 30 19 98 08 15 19 99 12 31 55 66 9000

####  暂时性锁定该应用，则命令为：

#### 84 1E 00 00 04 3D E8 17 09

#### 返回的状态为：

#### 9000

####  卡片复位后再次选择该目录文件，则命令为：

#### 00 A4 00 00 02 3F 01

#### 返回的状态为：

#### 6A81

#### 说明：状态码6A81 表明命令不支持。

####  对该应用进行解锁，则命令为：

#### 84 18 00 00 04 A3 2F 38 1D

#### 返回的状态为：

#### 9000

#### [ 例例例例 2] ：：：：文件标识符为3F01 的目录文件，目录名称为A00000000386980701，进行应用永久

#### 性锁定。

#### 首先也必须对目录进行选择，然后用APPLICATION BLOCK 命令永久性锁定该目录，

#### 则命令为：

#### 84 1E 00 01 04 84 7D BB AE

#### 返回的数据为：

#### 9000

#### 说明：卡片永久性锁定后将不能被解锁，复位后再次选择该目录文件将返回6A81。

#### [ 注注注注 ] ：：：：此命令的执行并不改变电子存折或电子钱包联机交易序号的值。


**8.4.** 口令密钥解锁口令密钥解锁口令密钥解锁口令密钥解锁 **PIN UNBLOCK**

### 8.4.1. 定义和范围...........................................................................................................................

#### PIN UNBLOCK 命令发卡方提供了解锁口令密钥的功能。

#### 当 PIN UNBLOCK 命令成功完成后，卡片将重置个人密码错误计数器的值。

#### 命令中口令密钥的传递采用加密方式。

### 8.4.2. 命令报文...............................................................................................................................

#### PIN UNBLOCK 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 84

#### INS 24

#### P1 口令密钥标识符

#### P2 00

```
Lc 0C 或 14
加密的口令密钥 08 或 10 字节
Data
MAC 4 字节
Le 不存在
```
### 8.4.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域由口令密钥数据元（如果存在）和其后的报文鉴别代码（MAC ）数据

#### 元组成。

**[** 注注注注 **]** ：：：：此处的Data 为密钥线路保护密钥对原口令值进行加密和计算MAC.

### 8.4.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域不存在。

### 8.4.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 意意意意 义义义义

#### 65 81 写EEPROM 失败

#### 69 82 不满足安全状态

#### 6A 82 KEY 文件未找到

#### 6A 86 参数 P1 P2 不正确

#### 69 88 安全报文数据项不正确

#### 93 03 应用永久锁定

#### 94 03 密钥未找到

#### [ 例例例例 1] ：：：：密钥标识符为 00 的口令密钥被锁死，对该口令密钥进行解锁，必须使用密钥线路


#### 保护密钥进行线路保护，则命令为：

#### 84 24 00 01 0C F3 97 B1 FD 0C D1 74 7A 8E 0C B9 3B

#### 由卡片返回的响应数据为：

#### 9000

#### 说明：在解锁口令密钥命令报文中并不能指定口令密钥的密钥标识符，系统将自动对密钥

#### 文件中标识为 00 的口令密钥进行解锁。


**8.5.** 重装重装重装重装 **/** 修改口令密钥修改口令密钥修改口令密钥修改口令密钥 **RELOAD/CHANGE PIN**

### 8.5.1. 定义和范围...........................................................................................................................

#### RELOAD PIN 命令用于发卡方重新给持卡人产生一个新的PIN（可以与原PIN 不同）。

#### RELOAD PIN 只能在拥有或能访问到重装口令密钥的密钥的发卡方终端（例如发卡方

#### 银行终端）上执行。

#### 在成功执行RELOAD PIN 命令后，IC 卡必须完成以下操作：

####  密钥错误尝试计数器复位。

####  IC 卡的原密钥必须设置为新的值。

#### 命令中的密钥数据以明文传送。

### 8.5.2. 命令报文...............................................................................................................................

#### RELOAD PIN 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 5E

#### P1 00

#### P2 口令密钥标识符

```
Lc 06-0A
Data 重装的PIN 2~6字节^
报文鉴别代码MAC 4 字节
Le 不存在
```
### 8.5.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域由重装的PIN 和报文鉴别码（MAC ）组成。

#### [ 注注注注 ] ：：：：此处的MAC 是由重装口令密钥前后 8 字节异或后对2-6字节新口令值计算的MAC ，

#### 并非是使用线路保护密钥对整个命令报文作线路保护的结果。

### 8.5.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域不存在。

### 8.5.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 65 81 写EEPROM 不成功

#### 67 00 长度错误

#### 69 82 不满足安全状态

#### 69 83 认证方式锁定

#### 69 85 使用条件不满足


#### 93 02 MAC 错误

#### 93 03 应用永久锁定

#### 94 03 密钥未找到

#### [ 例例例例 ] ：：：：密钥文件中有一个密钥标识符为 00 ，长度为 6 字节的口令密钥，发卡方重新给持卡

#### 人产生一个新的口令密钥，不进行线路保护，则命令为：

#### 80 5E 00 00 0A 22 33 44 55 66 77 1C E6 AA 60

#### 说明：22 33 44 55 66 77 为重装的 6 字节新口令，1C E6 AA 60 为 4 字节的MAC 码，

#### 但应特别注意的是此处的MAC 并非是使用线路保护密钥作线路保护生成的，而是由重装

#### 口令密钥前后 8 字节相异或后对 6 字节新口令值计算的MAC 。

#### 由卡片返回的响应数据为： 9000

#### 说明：在重装口令密钥命令报文中并不能指定口令密钥的密钥标识符，系统将自动对

#### 密钥文件中标识为 00 的口令密钥进行重装。


**8.6.** 修改口令密钥命令修改口令密钥命令修改口令密钥命令修改口令密钥命令 **CHANGE PIN**

### 8.6.1. 修改口令密钥命令定义和范围...........................................................................................

#### CHANGE PIN 允许持卡人将当前长度为2~6字节的口令密钥修改为新的密钥，且新

#### 密钥的长度可以与原口令密钥的长度不同。

#### 当CHANGE PIN 命令成功完成后，卡片要进行以下操作：

####  密码尝试计数器复位至密码尝试次数的上限。

####  将原个人密码置为新的口令密钥。

#### 此命令中的口令密钥值以明文传送。

### 8.6.2. 命令报文...............................................................................................................................

#### CHANGE PIN 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 5E

#### P1 01

#### P2 口令密钥标识符

```
Lc 05~0D
Data 旧的口令密钥 || ‘FF’ || 新的口令密
钥
Le 不用
```
### 8.6.3. 命令报文数据域...................................................................................................................

#### 命令报文数据域由旧的口令密钥、填充的 1 字节的’FF’及新的口令密钥三部分组成 。

### 8.6.4. 响应报文数据域...................................................................................................................

#### 响应报文数据域不存在。

### 8.6.5. 响应报文状态码...................................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 63 CX X表示还可再试次数

#### 65 81 写EEPROM 不成功

#### 69 82 不满足安全状态

#### 69 83 认证方法锁定

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 82 文件未找到

#### 94 03 密钥未找到

#### [ 例例例例 ] ：：：：密钥文件中有一个密钥标识符为 00 ，长度为 2 字节的口令密钥，修改该口令密钥进


#### 行解锁，不进行线路保护，则命令为：

#### 84 5E 01 00 05 00 00 FF 31 32

#### 说明：00 00 为旧的口令密钥，31 32 为新的口令密钥。

#### 由卡片返回的响应数据为： 9000

#### 说明：在修改口令密钥命令报文中并不能指定口令密钥的密钥标识符，系统将自动对密钥

#### 文件中标识为 00 的口令密钥进行修改。


**8.7.** 圈存命令圈存命令圈存命令圈存命令

### 8.7.1. 圈存初始化INITIALIZE FOR LOAD

#### 8.7.1.1. 圈存初始化命令定义和范围圈存初始化命令定义和范围圈存初始化命令定义和范围圈存初始化命令定义和范围

#### INITIALIZE FOR LOAD 命令用于初始化圈存交易。

#### 8.7.1.2. 命令报文命令报文命令报文命令报文

#### INITIALIZE FOR LOAD 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 50

#### P1 00

#### P2^01 ：用于电子存折^

#### 02 ：用于电子钱包

```
Lc 0B
密钥标识符 1 字节
Data 交易金额 4 字节
终端机编号 6 字节
Le 10
```
**8.7.1.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

```
密钥标识符：IC 卡内的密钥标识符
交易金额：此次圈存交易待处理的金额
终端机编号： 6 字节终端机编号，由终端给出
```
**8.7.1.4.** 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

此命令执行不成功，则只在响应报文中回送SW1 和SW2。
此命令执行成功的响应报文数据域如下表：
表表表表 **8.3 INITIALIZE FOR LOAD** 命令执行成功的响应报文数据域命令执行成功的响应报文数据域命令执行成功的响应报文数据域命令执行成功的响应报文数据域
说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））
电子存折或电子钱包旧余额 4
电子存折或电子钱包联机交易序号 2
密钥版本号（DATA 中第一字节指定的圈存密钥） 1
算法标识（DATA 中第一字节指定的圈存密钥） 1
伪随机数（IC 卡） 4
MAC1 4
过程密钥由DATA 中第一字节即密钥标识符指定的圈存密钥对（ 4 字节随机数+2 字节
电子存折或电子钱包联机交易序号+8000）数据加密生成。

MAC1 由卡中过程密钥对（ 4 字节电子存折或电子钱包旧余额+4 字节交易金额+1 字节
交易类型标识+6 字节终端机编号）数据加密生成。


#### 交易类型标识：

#### 值值值值 含义含义含义含义

#### 01 电子存折圈存

#### 02 电子钱包圈存

#### 8.7.1.5. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 圈存初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 65 81 写EEPROM 不成功

#### 67 00 长度错误

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 86 参数P1 P2 错误

#### 94 03 密钥索引不支持

#### [ 注注注注 1] ：：：：要想进行圈存交易首先必须进行圈存初始化，IC 卡将INITIALIZE FOR LOAD 响

#### 应报文回送给终端处理。如果IC 卡回送的状态码不是’9000’，则交易中止。

#### [ 注注注注 2] ：：：：在银行的应用目录下，当符合中国金融IC 卡应用规范的专用钱包文件用作电子存

#### 折时，文件标识符固定为 0001 ；用作电子钱包时，文件标识符固定为 0002 。


### 8.7.2. 圈存命令CREDIT FOR LOAD

#### 8.7.2.1. 圈存命令定义和范围圈存命令定义和范围圈存命令定义和范围圈存命令定义和范围

#### CREDIT FOR LOAD 命令用于圈存交易。

#### 8.7.2.2. 命令报文命令报文命令报文命令报文

#### CREDIT FOR LOAD 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 52

#### P1 00

#### P2 00

```
Lc 0B
交易日期（主机） 4 字节
Data 交易时间（主机） 3 字节
MAC2 4 字节
Le 04
```
**8.7.2.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

过程密钥由与圈存初始化相同的内部密钥对（ 4 字节随机数+2 字节电子存折或电子钱
包联机交易序号+8000）数据加密生成。

MAC2 由卡中过程密钥对（ 4 字节交易金额+1 字节交易类型标识+6 字节终端机编号+4
字节主机交易日期+3 字节主机交易时间）数据加密生成。

```
交易类型标识见圈存初始化命令。
```
**8.7.2.4.** 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

此命令执行成功的响应报文数据域如下表：
表表表表 **8.5 CREDIT FOR LOAD** 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域
说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））
交易验证码TAC 4
TAC 用内部密钥DTK 左右 8 位字节异或运算的结果对（ 4 字节电子存折或电子钱包新
余额+2 字节电子存折或电子钱包联机交易序号（加 1 前）+4 字节交易金额+1 字节交易类
型标识+6 字节终端机编号+4 字节主机交易日期+3 字节主机交易时间）数据加密生成。

**8.7.2.5.** 响应报文状态码响应报文状态码响应报文状态码响应报文状态码

```
此命令执行成功的状态码是’9000’。
IC 卡可能回送的错误状态码如下所示：
SW1 SW2 含义含义含义含义
65 81 写EEPROM 不成功
67 00 长度错误
69 01 命令不接受（无效状态）
```

#### SW1 SW2 含义含义含义含义

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 93 02 MAC 无效

#### [ 注注注注 ] ：：：：完成圈存交易后，IC 卡把交易金额加在电子存折或电子钱包的余额上，将电子存折

#### 或电子钱包联机交易序号加 1 ，并用下表的数据组成一个记录，保存在电子存折或电子钱

#### 包所指定的记录长度为 23 个字节的交易明细文件中。

#### 表表表表 8.6 23 字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容

#### 说说说说 明明明明 长度长度长度长度（（（（字节字节字节字节））））

#### 电子存折、钱包联机交易序号

#### （加 1 前）

#### 2

#### 透支限额 3

#### 交易金额 4

#### 交易类型标识 1

#### 终端机编号 6

#### 主机交易日期 4

#### 主机交易时间 3


### 8.7.3. 圈存交易流程图...................................................................................................................


**8.8.** 消费交易消费交易消费交易消费交易（（（（存折或钱包存折或钱包存折或钱包存折或钱包））））

消费交易允许持卡人使用电子存折或电子钱包的余额进行购物或获取服务。此交易可
以在销售点终端（POS ）上脱机进行。使用电子存折进行的消费交易必须验证口令，使用
电子钱包则不需要。

### 8.8.1. 消费初始化INITIALIZE FOR PURCHASE

#### 8.8.1.1. 命令定义和命令定义和命令定义和命令定义和范围范围范围范围

#### INITIALIZE FOR PURCHASE 命令用于初始化消费交易。

#### 8.8.1.2. 命令报文命令报文命令报文命令报文

#### INITIALIZE FOR PURCHASE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 50

#### P1 01

#### 01 ：用于电子存折

#### P2

#### 02 ：用于电子钱包

```
Lc 0B
密钥标识符 1 字节
Data 交易金额 4 字节
终端机编号 6 字节
Le 0F
```
**8.8.1.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

```
密钥标识符：IC 卡内的密钥标识符
交易金额：此次消费交易待处理的金额
终端机编号： 6 字节终端机编号，由终端给出
```
**8.8.1.4.** 响应报文数响应报文数响应报文数响应报文数据域据域据域据域

```
此命令执行不成功，则只在响应报文中回送SW1 和SW2。
此命令执行成功的响应报文数据域如下表：
表表表表 8.8 INITIALIZE FOR PURCHASE 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域
说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））
电子存折或电子钱包旧余额 4
电子存折或电子钱包脱机交易序号 2
透支限额 3
密钥版本号（DATA 中第一字节指定的消费密钥） 1
算法标识（DATA 中第一字节指定的消费密钥） 1
伪随机数（IC 卡） 4
过程密钥由DATA 中第一字节即密钥标识符指定的消费密钥对（ 4 字节随机数+2 字节
```

#### 电子存折或电子钱包脱机交易序号+终端交易序号的最右两个字节）数据加密生成。

#### MAC1 由卡中过程密钥对（ 4 字节交易金额+1 字节交易类型标识+6 字节终端机编号+4

#### 字节终端交易日期+3 字节终端交易时间）数据加密生成。

#### 交易类型标识：

#### 值值值值 含义含义含义含义

#### 05 电子存折消费

#### 06 电子钱包消费

#### 8.8.1.5. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 消费初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 62 83 选择文件无效，文件或密钥校验错误

#### 65 81 写EEPROM 不成功

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 82 文件未找到

#### 94 01 金额不足

#### 94 03 密钥索引不支持

#### [ 注注注注 1] ：：：：要想进行消费交易首先必须进行消费初始化，IC 将INITIALIZE FOR PURCHASE

#### 响应报文回送给终端处理。如果IC 卡回送的状态码不是’9000’，则交易中止。

#### [ 注注注注 2] ：：：：在银行的应用目录下，当符合中国金融IC 卡应用规范的专用钱包文件用作电子存

#### 折时，文件标识符固定为 0001 ；用作电子钱包时，文件标识符固定为 0002 。


### 8.8.2. 消费命令DEBIT FOR CAPP PURCHASE..........................................................................

#### 8.8.2.1. 定义和范围定义和范围定义和范围定义和范围

#### DEBIT FOR PURCHASE 命令用于消费交易。

#### 8.8.2.2. 命令报文命令报文命令报文命令报文

#### DEBIT FOR PURCHASE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 54

#### P1 01

#### P2 00

```
Lc 0F
终端交易序号 4 字节
交易日期（终端） 4 字节
交易时间（终端） 3 字节
```
```
Data
```
```
MAC1 4 字节
Le 08
执行INITIALIZE FOR PURCHASE 后即选择了消费交易。
```
**8.8.2.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

过程密钥由与消费初始化相同的消费密钥对（ 4 字节随机数+2 字节电子存折或电子钱
包脱机交易序号+终端交易序号的最右两个字节）数据加密生成。

MAC1 由卡中过程密钥对（ 4 字节交易金额+1 字节交易类型标识+6 字节终端机编号+4
字节终端交易日期+3 字节终端交易时间）数据加密生成。

```
交易类型标识见消费初始化命令。
```
**8.8.2.4.** 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

此命令执行成功的响应报文数据域如下表：
表表表表 **8.11 INITIALIZE FOR PURCHASE** 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域
说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））
交易验证码TAC 4
MAC2 4
如果此命令执行不成功，则只在响应报文中回送SW1 和SW2。
MAC2 由卡中过程密钥对（ 4 字节交易金额）数据加密生成。
TAC 用内部密钥DTK 左右 8 位字节异或运算的结果对（ 4 字节交易金额+1 字节交易
类型标识+6 字节终端机编号+4 字节终端交易序号+4 字节终端交易日期+3 字节终端交易时
间）数据加密生成。

**8.8.2.5.** 响应报文状态码响应报文状态码响应报文状态码响应报文状态码

```
此命令执行成功的状态码是’9000’。
```

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 65 81 写EEPROM 不成功

#### 67 00 长度错误

#### 69 01 命令不接受（无效状态）

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 93 02 MAC 无效

#### 94 01 金额不足

#### [ 注注注注 ] ：：：：完成消费交易后，IC 卡从电子存折或电子钱包余额中扣减消费的金额，将电子存折

#### 或电子钱包脱机交易序号加 1 ，并用下表的数据组成一个记录，保存在电子存折所指定记

#### 录长度为 23 个字节的交易明细文件中。

#### 表表表表 8.12 23 字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容

#### 说明说明说明说明^ 长度长度长度长度（（（（字节字节字节字节））））^

#### 电子存折脱机交易序号（加 1 前） 2

#### 透支限额 3

#### 交易金额 4

#### 交易类型标识 1

#### 终端机编号 6

#### 终端交易日期 4

#### 终端交易时间 3


### 8.8.3. 消费交易流程图...................................................................................................................


**8.9.** 复合应用消费交易复合应用消费交易复合应用消费交易复合应用消费交易（（（钱包（钱包钱包钱包））））

复合应用消费交易允许持卡人使用电子钱包的余额进行购物或获取服务。此交易可以
在销售点终端（POS ）上脱机进行。此交易无需提交个人密码（PIN ）。

### 8.9.1. 消费初始化INITIALIZE FOR CAPP PURCHASE.............................................................

#### 8.9.1.1. 命令定义和范围命令定义和范围命令定义和范围命令定义和范围

#### INITIALIZE FOR CAPP PURCHASE 命令用于初始化消费交易。

#### 8.9.1.2. 命令报文命令报文命令报文命令报文

#### INITIALIZE FOR CAPP PURCHASE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 50

#### P1 03

#### P2 02

```
Lc 0B
密钥标识符 1 字节
Data 交易金额 4 字节
终端机编号 6 字节
Le 0F
```
**8.9.1.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

```
密钥标识符：IC 卡内的密钥标识符
交易金额：此次复合消费交易待处理的金额
终端机编号： 6 字节终端机编号，由终端给出
```
**8.9.1.4.** 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

此命令执行不成功，则只在响应报文中回送SW1 和SW2。
此命令执行成功的响应报文数据域如下表：
表表表表 **8.14 INITIALIZE FOR PURCHASE** 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域
说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））
电子存折或电子钱包旧余额 4
电子存折或电子钱包脱机交易序号 2
透支限额 3
密钥版本号（DATA 中第一字节指定的消费密钥） 1
算法标识（DATA 中第一字节指定的消费密钥） 1
伪随机数（IC 卡） 4
过程密钥由DATA 中第一字节即密钥标识符指定的消费密钥对（ 4 字节随机数+2 字节
电子存折或电子钱包脱机交易序号+终端交易序号的最右两个字节）数据加密生成。

```
MAC1 由卡中过程密钥对（ 4 字节交易金额+1 字节交易类型标识+6 字节终端机编号+4
```

#### 字节终端交易日期+3 字节终端交易时间）数据加密生成。

#### 复合消费交易的交易类型标识为 09 。

#### 8.9.1.5. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 消费初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 62 83 选择文件无效，文件或密钥校验错误

#### 65 81 写EEPROM 不成功

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 82 文件未找到

#### 94 01 金额不足

#### 94 03 密钥索引不支持

#### [ 注注注注 1] ：：：：要想进行消费交易首先必须进行消费初始化，IC 将INITIALIZE FOR PURCHASE

#### 响应报文回送给终端处理。如果IC 卡回送的状态码不是’9000’，则交易中止。

#### [ 注注注注 2] ：：：：在银行的应用目录下，当符合中国金融IC 卡应用规范的专用钱包文件用作电子存

#### 折时，文件标识符固定为 0001 ；用作电子钱包时，文件标识符固定为 0002 。


### 8.9.2. 更新复合应用数据缓存 UPDATE CAPP DATA CACHE.................................................

#### 8.9.2.1. 定义和范围定义和范围定义和范围定义和范围

#### UPDATE CAPP DATA CHACHE 命令用于复合应用消费交易中更新复合应用数据缓

#### 存，缓存数据将被DEBIT FOR CAPP PURCHASE 命令用于改写复合应用专用文件中相关

#### 记录。

#### 8.9.2.2. 命令报文命令报文命令报文命令报文

#### UPDATE CAPP DATA CACHE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS DC

#### 复合应用类型标识符

#### P1

#### 记录号

#### P2 见下表

```
Lc XX
Data 更新原有记录的新数据
Le 不存在
```
**[** 注注注注 **]** ：：：：Lc 表示要写入的字节数，若为线路保护，Lc 为写入数据的长度+4 字节MAC ；若为
加密线路保护，Lc 为加密后数据的长度+4 字节MAC 。

```
表表表表 8.9 UPDATE CAPP DATA CACHE 命令中命令中命令中命令中 P2 的含义的含义的含义的含义
b8 b7 b6 b5 b4 b3 b2 b1 含含含含 义义义义
X X X X X - - - b4-b8 为短文件标识符
0 0 0 0 0 - - - 当前文件
1 1 1 1 1 - - - 保留
```
- - - - - 0 0 0 第一个标识符出现的记录
- - - - - 1 0 0 P1 表示的为记录号
- - - - - X X X RFU

#### 8.9.2.3. 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

#### 此命令报文数据域由更新原有记录的新记录组成。

#### 8.9.2.4. 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

#### 响应报文数据域不存在。

#### 8.9.2.5. 响应报文状态码响应报文状态码响应报文状态码响应报文状态码

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 意意意意 义义义义

#### 62 83 选择文件无效


#### SW1 SW2 意意意意 义义义义

#### 65 81 写EEPROM 失败

#### 67 00 长度错误

#### 69 81 当前文件不是定长或变长记录文件

#### 69 82 写的条件不满足

#### 6A 81 不支持此功能（无MF 或MF 已锁定）

#### 6A 82 未找到文件

#### 6A 83 未找到记录

#### 6A 84 文件无足够空间


### 8.9.3. 复合应用消费命令DEBIT FOR CAPP PURCHASE

#### 8.9.3.1. 定义和范围定义和范围定义和范围定义和范围

#### DEBIT FOR CAPP PURCHASE 命令用于消费交易。

#### 8.9.3.2. 命令报文命令报文命令报文命令报文

#### DEBIT FOR CAPP PURCHASE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 54

#### P1 01

#### P2 00

```
Lc 0F
终端交易序号 4 字节
交易日期（终端） 4 字节
交易时间（终端） 3 字节
```
```
Data
```
```
MAC1 4 字节
Le 08
执行INITIALIZE FOR CAPP PURCHASE 后即选择了复合应用消费交易。
```
#### 8.9.3.3. 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

#### 过程密钥由与消费初始化相同的消费密钥对（ 4 字节随机数+2 字节电子存折或电子钱

#### 包脱机交易序号+终端交易序号的最右两个字节）数据加密生成。

#### MAC1 由卡中过程密钥对（ 4 字节交易金额+1 字节交易类型标识+6 字节终端机编号+4

#### 字节终端交易日期+3 字节终端交易时间）数据加密生成。

#### 交易类型标识见消费初始化命令。

#### 8.9.3.4. 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

#### 此命令执行成功的响应报文数据域如下表：

#### 表表表表 8.15 INITIALIZE FOR CAPP PURCHASE 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域

#### 说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））

#### 交易验证码TAC^4

#### MAC2 4

#### 如果此命令执行不成功，则只在响应报文中回送SW1 和SW2。

#### MAC2 由卡中过程密钥对（ 4 字节交易金额）数据加密生成。

#### TAC 用内部密钥DTK 左右 8 位字节异或运算的结果对（ 4 字节交易金额+1 字节交易

#### 类型标识+6 字节终端机编号+4 字节终端交易序号+4 字节终端交易日期+3 字节终端交易时

#### 间）数据加密生成。


#### 8.9.3.5. 响应报文状态码响应报文状态码响应报文状态码响应报文状态码

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 65 81 写EEPROM 不成功

#### 67 00 长度错误

#### 69 01 命令不接受（无效状态）

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 93 02 MAC 无效

#### 94 01 金额不足

#### [ 注注注注 ] ：：：：完成消费交易后，IC 卡从电子存折或电子钱包余额中扣减消费的金额，将电子存折

#### 或电子钱包脱机交易序号加 1 ，并用下表的数据组成一个记录，保存在电子存折所指定记

#### 录长度为 23 个字节的交易明细文件中。

#### 表表表表 8.16 23 字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容

#### 说明说明说明说明^ 长度长度长度长度（（（（字节字节字节字节））））^

#### 电子存折脱机交易序号（加 1 前） 2

#### 透支限额 3

#### 交易金额 4

#### 交易类型标识 1

#### 终端机编号 6

#### 终端交易日期 4

#### 终端交易时间 3


### 8.9.4. 复合应用消费交易流程图.................................................................................................

```
送应用序列号
```
```
取应用序列号SELECT
```
```
由应用序列号生成消费子密钥
80 FA 00 XX 08序列号
```
```
返回 9000
初始化消费交易INITIALIZE FOR PURCHASE
80 50 03 02 0B 密钥标识符金额终端号
旧余额脱机序号透支限额密钥版本号
算法标识随机数
```
```
消费交易DEBIT FOR PURCHASE
80 54 01 00 0F终端交易序号日期时间MAC1
```
```
由IC卡进行以下步骤：
1.从余额中扣减消费的金额
2.将电子存折或电子钱包脱机交易序号加 1
3.由交易金额生成MAC2
4.生成一条记录更新交易明细文件
5.用以下数据生成TAC
交易金额+交易类型标识+终端机编号+终端交易
序号+终端交易日期+终端交易时
```
```
4 字节TAC + 4字节MAC2 计算MAC2
```
```
送交易金额
```
```
送卡序号生成导出密钥
送“随机数+脱机交易序号+终端交易序
号最后两个字节”
生成过程密钥
```
```
送“交易金额+类型标识+终端号+终端日
期+终端时间”生成MAC1
回送MAC1
```
```
IC 卡 POS机 主机
```
```
更新复合应用数据缓存
DUPDATE CAPP DATA CACHE
80 DC XX XX Lc 需更新记录
处理UPDATE CAPP DATA CACHE 命令
并判断条件
```

**8.10.** 圈提交易圈提交易圈提交易圈提交易（（（（存折存折存折存折））））

通过圈提交易，持卡人可以把电子存折中的部分或全部资金划回到其在银行的相应帐
户上。这种交易必须在金融终端上联机进行并要求验证口令。只有电子存折应用支持圈提
交易。

### 8.10.1. 圈提初始化INITIALIZE FOR UNLOAD

#### 8.10.1.1. 命令定义和范围命令定义和范围命令定义和范围命令定义和范围

#### INITIALIZE FOR UNLOAD 命令用于初始化圈提交易。

#### 8.10.1.2. 命令报文命令报文命令报文命令报文

#### INITIALIZE FOR UNLOAD 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 50

#### P1 05

#### P2 01 ：用于电子存折

```
Lc 0B
密钥标识符 1 字节
Data 交易金额 4 字节
终端机编号 6 字节
Le 10
```
**8.10.1.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

```
密钥标识符：IC 卡内的密钥标识符
交易金额：此次圈提交易待处理的金额
终端机编号： 6 字节终端机编号，由终端给出
```
**8.10.1.4.** 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

```
此命令执行不成功，则只在响应报文中回送SW1 和SW2。
此命令执行成功的响应报文数据域如下表：
表表表表 8.18 INITIALIZE FOR UNLOAD 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域
```
说明说明说明说明 (^) 长度长度长度长度（（（（字节字节字节字节））））
电子存折旧余额 4
电子存折联机交易序号 2
密钥版本号（DATA 中第一字节指定的圈提密钥） 1
算法标识（DATA 中第一字节指定的圈提密钥） 1
伪随机数（IC 卡） 4
MAC1 4
过程密钥由DATA 中第一字节即密钥标识符指定的圈提密钥对（ 4 字节随机数+2 字节
电子存折联机交易序号+8000）数据加密生成。


#### MAC1 由卡中过程密钥对（ 4 字节电子存折旧余额+4 字节交易金额+1 字节交易类型标

#### 识+6 字节终端机编号）数据加密生成。

#### 圈提的交易类型标识为 03 。

#### 8.10.1.5. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 圈提初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 65 81 写EEPROM 不成功

#### 67 00 长度错误

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 86 参数P1 P2 错误

#### 94 01 金额不足

#### 94 03 密钥索引不支持

#### [ 注注注注 1] ：：：：要想进行圈提交易首先必须进行圈提初始化，IC 将INITIALIZE FOR UNLOAD 响

#### 应报文回送给终端处理。如果IC 卡回送的状态码不是’9000’，则交易中止。

#### [ 注注注注 2] ：：：：在银行的应用目录下，当符合中国金融IC 卡应用规范的专用钱包文件用作电子存

#### 折时，文件标识符固定为 0001 。


### 8.10.2. 圈提命令圈提命令圈提命令圈提命令 CREDIT FOR UNLOAD

#### 8.10.2.1. 定义和范围定义和范围定义和范围定义和范围

#### CREDIT FOR UNLOAD 命令用于圈提交易。

#### 8.10.2.2. 命令报文命令报文命令报文命令报文

#### CREDIT FOR UNLOAD 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 54

#### P1 03

#### P2 00

```
Lc 0B
主机交易日期 4 字节
Data 主机交易时间 3 字节
MAC2 4 字节
Le 04
```
**8.10.2.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

过程密钥由与圈提初始化相同的圈提密钥对（ 4 字节随机数+2 字节电子存折联机交易
序号+8000）数据加密生成。

MAC2 由卡中过程密钥对（ 4 字节交易金额+1 字节交易类型标识+6 字节终端机编号+4
字节主机交易日期+3 字节主机交易时间）数据加密生成。

```
交易类型标识见圈提初始化命令。
```
**8.10.2.4.** 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

此命令执行成功的响应报文数据域如下表：
表表表表 **8.20 CREDIT FOR UNLOAD** 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域
说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））
MAC3 4
如果此命令执行不成功，则只在响应报文中回送SW1 和SW2。
MAC3 由卡中过程密钥对（ 4 字节电子存折新余额+2 字节电子存折联机交易序号（加
1 前）+4 字节交易金额+1 字节交易类型标识+6 字节终端机编号+4 字节主机交易日期+3 字
节主机交易时间）数据加密生成。

**8.10.2.5.** 响应报文状态码响应报文状态码响应报文状态码响应报文状态码

```
此命令执行成功的状态码是’9000’。
IC 卡可能回送的错误状态码如下所示：
SW1 SW2 含义含义含义含义
65 81 写EEPROM 不成功
67 00 长度错误
```

#### 69 01 命令不接受（无效状态）

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 93 02 MAC 无效

#### [ 注注注注 ] ：：：：完成消费交易后，IC 卡从电子存折或电子钱包余额中扣减消费的金额，将电子存折

#### 或电子钱包脱机交易序号加 1 ，并用下表的数据组成一个记录，保存在电子存折所指定记

#### 录长度为 23 个字节的交易明细文件中。

#### 表表表表 8.20 23 字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容

#### 说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））

#### 电子存折联机交易序号（加 1 前） 2

#### 透支限额 3

#### 交易金额 4

#### 交易类型标识 1

#### 终端机编号 6

#### 主机交易日期 4

#### 主机交易时间 3


### 8.10.3. 圈提交易流程图...............................................................................................................

```
送应用序列号
```
```
取应用序列号SELECT
```
```
由应用序列号生成圈提子密钥
80 FA 00 XX 08序列号
```
```
返回 9000
初始化圈提交易INITIALIZE FOR UNLOAD
80 50 05 01 0B 密钥标识符 金额 终端号
```
```
生成过程密钥：随机数+联机交易序号+8000
生成MAC1：旧余额+金额+类型标识+终端号
旧余额 联机序号 密钥版本号 算法标识
随机数 MAC1
```
```
圈提交易 DEBIT FOR UNLOAD
80 54 03 00 0B 交易日期 时间 MAC2
```
```
由IC 卡验证MAC2的由效性，如有效则进行以下
步骤：
1.将电子存折联机交易序号加 1
2.从电子存折余额中扣减交易金额
3.用以下数据生成MAC3
新余额+联机交易序号（加1前）+交易金额+交易
类型标识+终端机编号+主机交易日期+主机交易
时间
4.组成一条记录更新交易明细文件
5.发送 4 字节MAC3
```
```
旧余额联机序号版本号算法标识
随机数 MAC1
主机验证MAC1有效性，如有效则产生MAC2
生成MAC2的数据：金额+类型标识+终端号
+日期+时间
主机交易日期主机交易时间MAC2
```
IC 卡 POS机 主机

```
校验MAC3正确性
```

**8.11.** 取现交易取现交易取现交易取现交易（（（（存折存折存折存折））））

取现交易允许持卡人从电子存折中提取现金。此交易必须在金融终端上进行，但可以
脱机处理。只有电子存折应用支持此交易，且必须验证口令。

### 8.11.1. 取现初始化INITIALIZE FOR CASH WITHDRAW.......................................................

#### 8.11.1.1. 命令定义和范围命令定义和范围命令定义和范围命令定义和范围

#### INITIALIZE FOR CASH WITHDRAW 命令用于初始化取现交易。

#### 8.11.1.2. 命令报文命令报文命令报文命令报文

#### INITIALIZE FOR CASH WITHDRAW 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 50

#### P1 02

#### P2 01 ：用于电子存折

```
Lc 0B
密钥标识符 1 字节
Data 交易金额 4 字节
终端机编号 6 字节
Le 0F
```
**8.11.1.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

```
密钥标识符：IC 卡内的密钥标识符
交易金额：此次取现交易待处理的金额
终端机编号： 6 字节终端机编号，由终端给出
```
**8.11.1.4.** 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

此命令执行不成功，则只在响应报文中回送SW1 和SW2。
此命令执行成功的响应报文数据域如下表：
表表表表 **8.22 INITIALIZE FOR CASH WITHDRAW** 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域
说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））
电子存折旧余额 4
电子存折脱机交易序号 2
透支限额 3
密钥版本号（DATA 中第一字节指定的消费密钥） 1
算法标识（DATA 中第一字节指定的消费密钥） 1
伪随机数（IC 卡） 4
过程密钥由DATA 中第一字节即密钥标识符指定的消费密钥对（ 4 字节随机数+2 字节
电子存折脱机交易序号+2 字节终端交易序号的最右两个字节）数据加密生成。

```
MAC1 由卡中过程密钥对（ 4 字节交易金额+1 字节交易类型标识+6 字节终端机编号+4
```

#### 字节终端交易日期+3 字节终端交易时间）数据加密生成。

#### 取现的交易类型标识为 04 。

#### 8.11.1.5. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 取现初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 62 83 选择文件无效，文件或密钥校验错误

#### 65 81 写EEPROM 不成功

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 82 文件未找到

#### 94 01 金额不足

#### 94 03 密钥索引不支持

#### [ 注注注注 1] ：：：：要想进 行 取 现 交 易首 先必须进 行 取 现初 始 化，IC 将 INITIALIZE FOR CASH

#### WITHDRAW 响应报文回送给终端处理。如果IC 卡回送的状态码不是’9000’，则交易中止。

#### [ 注注注注 2] ：：：：在银行的应用目录下，当符合中国金融IC 卡应用规范的专用钱包文件用作电子存

#### 折时，文件标识符固定为 0001 ；用作电子钱包时，文件标识符固定为 0002 。


### 8.11.2. 取现命令DEBIT FOR CASH WITHDRAW....................................................................

#### 8.11.2.1. 定义和范围定义和范围定义和范围定义和范围

#### DEBIT FOR CASH WITHDRAW 命令用于取现交易。

#### 8.11.2.2. 命令报文命令报文命令报文命令报文

#### DEBIT FOR CASH WITHDRAW 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 54

#### P1 01

#### P2 00

```
Lc 0F
终端交易序号 4 字节
终端交易日期 4 字节
终端交易时间 3 字节
```
```
Data
```
```
MAC1 4 字节
Le 08
执行INITIALIZE FOR CASH WITHDRAW 后即选择了取现交易。
```
**8.11.2.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

过程密钥由与取现初始化相同的消费密钥对（ 4 字节随机数+2 字节电子存折脱机交易
序号+终端交易序号的最右两个字节）数据加密生成。

MAC1 由卡中过程密钥对（ 4 字节交易金额+1 字节交易类型标识+6 字节终端机编号+4
字节终端交易日期+3 字节终端交易时间）数据加密生成。

```
交易类型标识见取现初始化命令。
```
**8.11.2.4.** 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

此命令执行成功的响应报文数据域如下表：
表表表表 **8.24 DEBIT FOR CASH WITHDRAW** 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域
说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））
交易验证码TAC 4
MAC2 4
如果此命令执行不成功，则只在响应报文中回送SW1 和SW2。
MAC2 由卡中过程密钥对（ 4 字节交易金额）数据加密生成。
TAC 用内部密钥DTK 左右 8 位字节异或运算的结果对（ 4 字节交易金额+1 字节交易
类型标识+6 字节终端机编号+4 字节终端交易序号+4 字节终端交易日期+3 字节终端交易时
间）数据加密生成。

**8.11.2.5.** 响应报文状态码响应报文状态码响应报文状态码响应报文状态码

```
此命令执行成功的状态码是’9000’。
```

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 65 81 写EEPROM 不成功

#### 69 01 命令不接受（无效状态）

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 93 02 MAC 无效

#### 94 01 金额不足

#### [ 注注注注 ] ：：：：完成取现交易后，IC 卡从电子存折余额中扣减取现交易的金额，将电子存折脱机交

#### 易序号加 1 ，并用下表的数据组成一个记录，保存在电子存折所指定记录长度为 23 个字节

#### 的交易明细文件中。

#### 表表表表 8.25 23 字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容

#### 说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））

#### 电子存折脱机交易序号（加 1 前） 2

#### 透支限额 3

#### 交易金额 4

#### 交易类型标识 1

#### 终端机编号 6

#### 终端交易日期 4

#### 终端交易时间 3


### 8.11.3. 取现交易流程图...............................................................................................................


**8.12.** 修改透支限额交易修改透支限额交易修改透支限额交易修改透支限额交易（（（存折（存折存折存折））））

当电子存折中的实际金额不足时，“透支功能”为持卡人提供了一种在发卡方所允许的
透支额度内继续进行交易的方便性。修改透支限额交易必须在金融终端上联机进行，且必
须验证口令。

### 8.12.1. 初始化修改透支限额命令INITIALIZE FOR UPDATE

#### 8.12.1.1. 定义和范围定义和范围定义和范围定义和范围

#### INITIALIZE FOR UPDATE 命令用于初始化修改透支限额交易。

#### 8.12.1.2. 命令报文命令报文命令报文命令报文

#### INITIALIZE FOR UPDATE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 50

#### P1 04

#### P2 01 ：仅用于电子存折

```
Lc 07
Data 密钥标识符^1 字节^
终端机编号 6 字节
Le 13
```
**8.12.1.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

```
密钥标识符：IC 卡内的密钥标识符
终端机编号： 6 字节终端机编号，由终端给出
```
**8.12.1.4.** 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

此命令执行不成功，则只在响应报文中回送SW1 和SW2。
此命令执行成功的响应报文数据域如下表：
表表表表 **8.27 INITIALIZE FOR UPDATE** 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域
说明说明说明说明 长度长度长度长度（（（字节（字节字节字节））））
电子存折旧余额 4
电子存折联机交易序号 2
旧透支限额 3
密钥版本号（DATA 中第一字节指定的修改透支密钥） 1
算法标识（DATA 中第一字节指定的修改透支密钥） 1
伪随机数（IC 卡） 4
MAC1 4
过程密钥由DATA 中第一字节指定的修改透支限额密钥对（ 4 字节随机数+2 字节电子
存折联机交易序号+8000）数据加密生成。

```
MAC1 由卡中过程密钥对（ 4 字节电子存折余额+3 字节旧透支限额+1 字节交易类型标
```

#### 识+6 字节终端机编号）数据加密生成。

#### 修改透支限额交易类型标识为 07 。

#### 8.12.1.5. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 取现初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 62 83 选择文件无效，文件或密钥校验错误

#### 65 81 写EEPROM 不成功

#### 67 00 长度错误

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 82 文件未找到

#### 6A 86 参数P1 P2 错误

#### 94 03 密钥标识不支持

#### [ 注注注注 1] ：：：：要想进行修改透支限额交易首先必须进行修改透支限额初始化，IC 将INITIALIZE

#### FOR UPDATE 响应报文回送给终端处理。如果IC 卡回送的状态码不是’9000’，则交易中止。

#### [ 注注注注 2] ：：：：在银行的应用目录下，当符合中国金融IC 卡应用规范的专用钱包文件用作电子存

#### 折时，文件标识符固定为 0001 ；用作电子钱包时，文件标识符固定为 0002 。


### 8.12.2. 修改透支限额命令修改透支限额命令修改透支限额命令修改透支限额命令 UPDATE OVERDRAW LIMIT

#### 8.12.2.1. 定义和范围定义和范围定义和范围定义和范围

#### UPDATE OVERDRAW LIMIT 命令用于修改透支限额交易。

#### 8.12.2.2. 命令报文命令报文命令报文命令报文

#### UNDATE OVERDRAW LIMIT 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 58

#### P1 00

#### P2 00

```
Lc 0E
新透支限额 3 字节
发卡方交易日期 4 字节
发卡方交易时间 3 字节
```
```
Data
```
```
MAC2 4 字节
Le 04
```
**8.12.2.3.** 命令报文数据域命令报文数据域命令报文数据域命令报文数据域

过程密钥由与修改透支限额初始化相同的修改透支限额密钥对（ 4 字节随机数+2 字节
电子存折联机交易序号+8000）数据加密生成。

MAC2 由卡中过程密钥对（ 3 字节新透支限额+1 字节交易类型标识+6 字节终端机编号
+4 字节主机交易日期+3字节主机交易时间）数据加密生成。

```
交易类型标识见修改透支限额初始化。
```
**8.12.2.4.** 响应报文数据域响应报文数据域响应报文数据域响应报文数据域

此命令执行成功的响应报文数据域如下表：
表表表表 **8.29 UPDATE FOR UPDATE** 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域
说明 长度（字节）
交易验证码TAC 4
如果此命令执行不成功，则只在响应报文中回送SW1 和SW2。
TAC 用内部密钥DTK 直接对（ 4 字节电子存折新余额+2 字节电子存折联机交易序号
（加 1 前）+3 字节电子存折新透支限额+1 字节交易类型标识+6 字节终端机编号+4 字节主
机交易日期+3 字节主机交易时间）数据加密生成。

**8.12.2.5.** 响应报文状态码响应报文状态码响应报文状态码响应报文状态码

```
此命令执行成功的状态码是’9000’。
IC 卡可能回送的错误状态码如下所示：
SW1 SW2 含义含义含义含义
65 81 写EEPROM 不成功
```

#### SW1 SW2 含义含义含义含义

#### 69 01 命令不接受（无效状态）

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 93 02 MAC 无效

#### 94 01 金额不足

#### [ 注注注注 ] ：：：：完成修改透支限额交易后，IC 卡将当前电子存折余额置为新的电子存折余额，更新

#### 透支限额，使电子存折联机交易序号加 1 ，并用下表的数据组成一个记录，保存在电子存

#### 折所指定记录长度为 23 个字节的交易明细文件中。

#### 表表表表 8.30 23 字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容字节交易明细文件内容

#### 说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））

#### 电子存折脱机交易序号（加 1 前） 2

#### 新透支限额 3

#### 交易金额 4

#### 交易类型标识 1

#### 终端机编号 6

#### 终端交易日期 4

#### 终端交易时间 3


### 8.12.3. 修改透支限额交易流程图...............................................................................................


**8.13.** 取交易认证取交易认证取交易认证取交易认证 **GET TRANSACTION PROVE**

### 8.13.1. 定义和范围.......................................................................................................................

#### GET TRANSACTION PROVE 命令提供了一种在交易处理过程中拔出并重插卡后卡

#### 片的恢复机制。

### 8.13.2. 命令报文...........................................................................................................................

#### GET TRANSACTION PROVE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 5A

#### P1 00

#### P2 待取认证码的交易类型标识

```
Lc 02
Data 待取认证码的交易序号
Le 08
各交易交易类型标识符见下表：
值值值值 含义含义含义含义
```
### 01 电子存折圈存

(^02) 电子钱包圈存

### 03 圈提

### 04 电子存折取款

### 05 电子存折消费

#### 06 电子钱包消费

#### 07 电子存折修改透支限额

#### 09 复合消费

### 8.13.3. 响应报文数据域...............................................................................................................

#### 如果命令中指定的交易类型标识和电子存折、电子钱包联机或脱机交易序号对应的报

#### 文鉴别代码MAC 或交易验证码TAC 可用，则响应报文数据域如下表：

#### 表表表表 8.32 GET TRANSCTION PROVE 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域^

#### 说明 长度（字节）

#### 报文鉴别代码MAC 4

#### 交易验证码TAC 4

### 8.13.4. 响应报文状态码...............................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：


#### SW1 SW2 含义含义含义含义

#### 65 81 写EEPROM 不成功

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 82 文件未找到

#### 93 02 MAC 无效

#### 94 06 所需MAC 不可用

### 8.13.5. 防拔功能...........................................................................................................................

#### 此功能保证卡片在交易处理中的任何情况下，甚至是在更新EEPROM 过程中掉电的

#### 情况下，仍能保持数据的完整性。

#### 在终端发给IC 卡一个命令以更新电子存折或电子钱包余额时，卡片总会回送一个报文

#### 鉴别代码（MAC ）或交易验证码（TAC ），以证明更新已经发生。一旦余额更新成功，可

#### 以通过GET TRANSCATION PROVE 命令获得此MAC 或TAC 。

#### 如果在命令已执行结束，而终端还未收到响应之前，卡片突然拔出，终端将会处于不

#### 知卡片是否更新的不定状态。在这种情况下，终端可以用GET TRANSACTION PROVE 命

#### 令取回MAC 或TAC ，如果返回’9000’则表示卡片更新成功，交易完成。如果不返回’9000’

#### 则表示卡片更新失败，要想完成该交易必须从交易初始化开始重新进行。


**8.14.** 读余额读余额读余额读余额 **GET BALANCE**

### 8.14.1. 定义和范围.......................................................................................................................

#### GET BALANCE 命令用于读取电子钱包或电子存折余额，实现查询余额交易。

#### 读取电子存折余额需验证口令密钥（PIN ）。

### 8.14.2. 命令报文...........................................................................................................................

#### GET BALANCE 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 80

#### INS 5C

#### P1 00

#### 01 ：用于电子存折

#### P2

#### 02 ：用于电子钱包

```
Lc 不存在
Data 不存在
Le 04
```
### 8.14.3. 响应报文数据域...............................................................................................................

#### 命令执行成功的响应报文数据域如下所示：

#### 表表表表 8.33 GET BALANCE 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域

#### 说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））

#### 电子存折或电子钱包余额 4

#### 如果命令执行不成功，则在响应报文中回送SW1 和SW2。

### 8.14.4. 响应报文状态码...............................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 69 82 不满足安全状态

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 82 文件未找到


## 9. 加油卡交易命令加油卡交易命令加油卡交易命令加油卡交易命令 .................................................................................................

#### 加油卡命令用于加油卡灰锁、解扣等命令

#### FMCOS21、FMCOS-ROM 支持此部分命令

**9.1.** 灰锁初始化灰锁初始化灰锁初始化灰锁初始化 **INITIALIZE FOR GREY LOCK**

### 9.1.1. 灰锁初始化命令定义和范围.............................................................................................

#### INITIALIZE FOR GREY LOCK 命令用于初始化灰锁命令。

### 9.1.2. 命令报文.............................................................................................................................

#### INITIALIZE FOR GREY LOCK 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA E0

#### INS 7A

#### P1 08

#### 01 ：用于电子存折

#### P2

#### 02 ：用于电子钱包

```
Lc 07
密钥标识符 1 字节
Data
终端机编号 6 字节
Le 0F
```
### 9.1.3. 命令报文数据域.................................................................................................................

#### 密钥标识符：IC 卡内的密钥标识符

#### 终端机编号： 6 字节终端机编号，由终端给出

### 9.1.4. 响应报文数据域.................................................................................................................

#### 此命令执行不成功，则只在响应报文中回送SW1 和SW2。

#### 此命令执行成功的响应报文数据域如下表：

#### 表表表表 9.1 INITIALIZE FOR GREY LOCK 命令执行成功的响应报文数据域命令执行成功的响应报文数据域命令执行成功的响应报文数据域命令执行成功的响应报文数据域

#### 说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））

#### 电子存折或电子钱包旧余额 4

#### 电子存折或电子钱包联机交易序号 2

#### 透支限额 3

#### 密钥版本号（DATA 中第一字节指定的圈存密钥） 1

#### 算法标识（DATA 中第一字节指定的圈存密钥） 1

#### 伪随机数（IC 卡） 4


#### 9.1.4.1. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 圈存初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 6E 00 CLA 参数错误

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 86 参数P1 P2 错误

#### 94 03 密钥索引不支持


**9.2.** 灰锁命令灰锁命令灰锁命令灰锁命令 **GREY LOCK**

### 9.2.1. 灰锁命令定义和范围.........................................................................................................

#### GREY LOCK 用于灰锁指定的ED 或EP 。该命令只有在成功执行INITIALIZE FOR

#### GREY LOCK 之后才能执行。

### 9.2.2. 命令报文.............................................................................................................................

#### GREY LOCK 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA E0

#### INS 7C

#### P1 08

#### P2 00

```
Lc 0B
终端交易序号 4 字节
终端随机数 4 字节
交易日期 4 字节
交易时间 3 字节
```
```
Data
```
#### MAC1 4 字节

```
Le 10
```
### 9.2.3. 命令报文数据域.................................................................................................................

#### 首先使用灰锁密钥对（ 4 字节随机数+2 字节脱机交易序号+终端交易序号最右两字节）

#### 数据加密生成临时密钥。

#### 使用临时密钥对（ 4 字节终端随机数+80000000）加密生成过程密钥。

#### MAC1 由过程密钥对（交易类型（ 91 ：电子存折、 92 ：电子钱包）+6 字节终端机编号

#### +4 字节交易日期+3 字节交易时间）数据加密生成。

#### 灰锁命令交易类型标识为：

#### 值值值值 含义含义含义含义

#### 91 电子存折灰锁

#### 92 电子钱包灰锁

### 9.2.4. 响应报文数据域.................................................................................................................

#### 此命令执行不成功，则只在响应报文中回送SW1 和SW2。

#### 此命令执行成功的响应报文数据域如下表：

#### 表表表表 9.2 GREY LOCK 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域

#### 说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））

#### GTAC 4

#### MAC2 4

#### 如果此命令执行不成功，则只在响应报文中回送SW1 和SW2。


#### MAC2 由卡中过程密钥对（ 4 字节电子钱包余额+1 字节脱机交易序号）数据加密生成。

#### TAC 用内部密钥DTK 左右 8 位字节异或运算的结果对（ 4 字节交易金额+1 字节交易

#### 类型标识+6 字节终端机编号+4 字节终端交易序号+4 字节终端交易日期+3 字节终端交易时

#### 间）数据加密生成。

#### 9.2.4.1. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 圈提初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 65 81 写EEPROM 不成功

#### 67 00 长度错误

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 86 参数P1 P2 错误

#### 94 01 金额不足

#### 94 03 密钥索引不支持


**9.3.** 解扣命令解扣命令解扣命令解扣命令 **DEBIT FOR UNLOCK**

### 9.3.1. 灰锁命令定义和范围.........................................................................................................

#### DEBIT FOR UNLOCK 用于灰锁指定的ED 或EP 。该命令只有在ED/EP 处于灰锁状态

#### 下才能成功执行。

### 9.3.2. 命令报文.............................................................................................................................

#### DEBIT FOR UNLOCK 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA E0

#### INS 7E

#### P1 08

#### 01 ：用于电子存折

#### P2

#### 02 ：用于电子钱包

```
Lc 1B
交易金额 4 字节
ED/EP 脱机交易序号 2 字节
终端机编号 6 字节
终端交易序号 4 字节
交易日期 4 字节
交易时间 3 字节
```
```
Data
```
#### GMAC 4 字节

Le 04
DEBIT FOR UNLOCK 命令前允许终端对IC 卡下电，COS 会自动记录过程密钥。重
新上电进行交易预处理后可以继续执行DEBIT FOR UNLOCK 不受影响。

### 9.3.3. 命令报文数据域.................................................................................................................

#### GMAC 是使用灰锁命令相同的过程密钥对（ 4 字交易金额）按PBOC MAC 方式计算

#### 生成的。

### 9.3.4. 响应报文数据域.................................................................................................................

#### 此命令执行不成功，则只在响应报文中回送SW1 和SW2。

#### 此命令执行成功的响应报文数据域如下表：

#### 表表表表 9.2 INITIALIZE FOR UNLOAD 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域

#### 说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））

#### TAC 4

#### 如果此命令执行不成功，则只在响应报文中回送SW1 和SW2。

#### TAC 用内部密钥DTK 左右 8 位字节异或运算的结果对（ 4 字节交易金额+1 字节交易

#### 类型标识+6 字节终端机编号+4 字节终端交易序号+4 字节终端交易日期+3 字节终端交易时

#### 间）数据加密生成。


#### 解扣命令交易类型标识为：

#### 值值值值 含义含义含义含义

#### 93 电子存折解扣

#### 94 电子钱包解扣

#### 9.3.4.1. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 圈提初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 65 81 写EEPROM 不成功

#### 67 00 长度错误

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 86 参数P1 P2 错误

#### 94 01 金额不足

#### 94 06 脱机交易金额不符

#### 93 02 GMAC 错误


**9.4.** 灰锁初始化灰锁初始化灰锁初始化灰锁初始化 **INITIALIZE FOR GREY UNLOCK**

### 9.4.1. 灰锁初始化命令定义和范围.............................................................................................

#### INITIALIZE FOR GREY UNLOCK 命令用于初始化灰锁命令。

### 9.4.2. 命令报文.............................................................................................................................

#### INITIALIZE FOR GREY UNLOCK 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA E0

#### INS 7A

#### P1 09

#### 01 ：用于电子存折

#### P2

#### 02 ：用于电子钱包

```
Lc 07
密钥标识符 1 字节
Data
终端机编号 6 字节
Le 12
```
### 9.4.3. 命令报文数据域.................................................................................................................

#### 密钥标识符：IC 卡内的密钥标识符

#### 终端机编号： 6 字节终端机编号，由终端给出

### 9.4.4. 响应报文数据域.................................................................................................................

#### 此命令执行不成功，则只在响应报文中回送SW1 和SW2。

#### 此命令执行成功的响应报文数据域如下表：

#### 表表表表 9.1 INITIALIZE FOR GREY UNLOCK 命令执行成功的响应报文数据域命令执行成功的响应报文数据域命令执行成功的响应报文数据域命令执行成功的响应报文数据域

#### 说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））

#### ED/EP 余额 4

#### 脱机交易序号 2

#### 联机交易序号 2

#### 密钥版本号 1

#### 密钥算法标识 1

#### 伪随机数（ICC ） 4

#### MAC1 4

#### 过程密钥由DATA 中第一字节即密钥标识符指定的圈提密钥对（ 4 字节随机数+2 字节

#### 电子存折联机交易序号+8000）数据加密生成。

#### MAC1 由卡中过程密钥对（ 4 字节电子存折旧余额+4 字节交易金额+1 字节交易类型标

#### 识+6 字节终端机编号）数据加密生成。

#### 联机解扣交易类型标识为：

#### 值值值值 含义含义含义含义


#### 95 电子存折联机解扣

#### 96 电子钱包联机解扣

#### 9.4.4.1. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 圈存初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 6E 00 CLA 参数错误

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 86 参数P1 P2 错误

#### 94 03 密钥索引不支持


**9.5.** 灰锁命令灰锁命令灰锁命令灰锁命令 **GREY UNLOCK**

### 9.5.1. 灰锁命令定义和范围.........................................................................................................

#### GREY LOCK 用于灰锁指定的ED 或EP 。该命令只有在成功执行INITIALIZE FOR

#### GREY LOCK 之后才能执行。

### 9.5.2. 命令报文.............................................................................................................................

#### GREY LOCK 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA E0

#### INS 7C

#### P1 09

#### P2 00

```
Lc 0F
交易金额 4 字节
交易日期 4 字节
交易时间 3 字节
Data
```
```
MAC2 4 字节
Le 04
```
### 9.5.3. 命令报文数据域.................................................................................................................

#### 首先使用灰锁密钥对（ 4 字节随机数+2 字节脱机交易序号+终端交易序号最右两字节）

#### 数据加密生成临时密钥。

#### 使用临时密钥对（ 4 字节终端随机数+80000000）加密生成过程密钥。

#### MAC2 由过程密钥对（交易类型（ 91 ：电子存折、 92 ：电子钱包）+6 字节终端机编号

#### +4 字节交易日期+3 字节交易时间）数据加密生成。

### 9.5.4. 响应报文数据域.................................................................................................................

#### 此命令执行不成功，则只在响应报文中回送SW1 和SW2。

#### 此命令执行成功的响应报文数据域如下表：

#### 表表表表 9.2 GREY LOCK 命令响应报文数据域命令响应报文数据域命令响应报文数据域命令响应报文数据域

#### 说明说明说明说明 长度长度长度长度（（（（字节字节字节字节））））

#### GTAC 4

#### MAC2 4

#### 如果此命令执行不成功，则只在响应报文中回送SW1 和SW2。

#### MAC2 由卡中过程密钥对（ 4 字节电子钱包余额+1 字节脱机交易序号）数据加密生成。

#### TAC 用内部密钥DTK 左右 8 位字节异或运算的结果对（ 4 字节交易金额+1 字节交易

#### 类型标识+6 字节终端机编号+4 字节终端交易序号+4 字节终端交易日期+3 字节终端交易时

#### 间）数据加密生成。


#### 9.5.4.1. 响应报文的状态码响应报文的状态码响应报文的状态码响应报文的状态码

#### 圈提初始化命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含义含义含义含义

#### 65 81 写EEPROM 不成功

#### 67 00 长度错误

#### 69 85 使用条件不满足

#### 6A 81 功能不支持（无MF 或卡片已锁死）

#### 6A 86 参数P1 P2 错误

#### 94 01 金额不足

#### 94 03 密钥索引不支持


## 10. FMCOS 内部测试命令内部测试命令内部测试命令内部测试命令 ...................................................................................

#### FMCOS 内部测试命令是用于卡片测试和卡片初始化的专用指令，在卡片正式发行后

#### 全部无法使用。

**10.1.** 计算程序计算程序计算程序计算程序 **ROM CRC** 命令命令命令命令 **CALCULATE ROM CRC**

### 10.1.1. 定义和范围.......................................................................................................................

#### CALCULATE ROM CRC 命令计算程序ROM 中全部或部分数据的CRC 校验，命令在

#### 卡片初始化且MF 建立后无效。

### 10.1.2. 命令报文...........................................................................................................................

#### INITIAL EEPROM 命令报文编码如下：

#### 代码代码代码代码 值值值值

#### CLA 00

#### INS 0A

#### P1 XX

#### P2 XX

```
Lc 02
Data XX
Le 不存在 或 02
P1 P2 为欲计算程序CRC 的起始地址。
```
### 10.1.3. 命令报文数据域...............................................................................................................

#### 命令报文数据域表示欲计算程序CRC 的终止地址

### 10.1.4. 响应报文数据域...............................................................................................................

#### 响应报文数据域为卡片计算出的 2 字节CRC 。

### 10.1.5. 响应报文状态码...............................................................................................................

#### 此命令执行成功的状态码是’9000’。

#### IC 卡可能回送的错误状态码如下所示：

#### SW1 SW2 含含含含 义义义义

#### 6D 00 指令代码（INS ）不被支持或无

#### 效

#### [例1]：希望计算地址从 0000 开始到1FFF 中8K 程序ROM 的CRC 校验，则命令为：

#### 00 0A 00 00 02 20 00

#### 说明：20 00 为1F FF 加 1 。


## 11. 安全报文传送安全报文传送安全报文传送安全报文传送 ...................................................................................................

**11.1.** 安全报文传送安全报文传送安全报文传送安全报文传送

卡与外界进行数据传输（卡接收命令，发送应答）时，若以明文方式传输，攻击者通
过劫获这些数据，可以分析出卡的结构，掌握卡中的数据。同时，也可以对传输的数据进
行篡改。

如何避免这个问题呢？方法就是采用安全报文传送。
安全报文传送的目的是保证数据的可靠性、完整性和对发送方的认证。安全报文传送
有三种情况：

 线路保护：对传输的数据附加 4 字节MAC 码，接收方收到后首先进行校验，只有校
验正确的数据才予以接受，这样就防止了对传输数据的篡改。
数据完整性和对发送方的认证通过使用MAC 来实现。

 线路加密：对传输的数据进行DES 加密，这样传输的就是密文，攻击者即使获得的数
据没有意义，分析后也只能得到错误的结果。
数据的可靠性通过对数据域的加密来得到保证。

 线路加密保护：对传输的数据进行DES 加密后再附加 4 字节MAC 码。

[注]：至于采取哪种方法进行安全报文传送由用户根据实际情况来决定。应该指出，高安
全性是以降低速度，增加实现难度来换取的，所以并不是安全性越高越好，而一定要根据
具体的要求来确定。

**11.2.** 如何实现安全报文传送如何实现安全报文传送如何实现安全报文传送如何实现安全报文传送

二进制文件、定长记录文件、变长记录文件、循环文件、钱包文件都可以采用安全报
文传送。如对上述文件进行安全报文传送，只需在建立文件时改变文件类型字节高两位即
可：

最高位置 1 表示数据域附加 4 字节MAC ，次高位置 1 表示对数据加密。
对于密钥也可以采用安全报文传送。如进行安全报文传送，只需在安装密钥时改变密
钥类型字节高两位即可：

```
最高位置 1 表示数据域附加 4 字节MAC ，次高位置 1 表示对数据加密。
```
例：建立文件时若需进行线路保护则将文件类型最高位置 1 ，如二进制类型由 28 变为A8。
若需对密钥进行线路加密保护则将密钥类型的最高位及次高位均置 1 ，如PIN 类型由3A
变为FA 。

[注]：在对文件进行读写，或使用密钥（如核对、解锁、认证或更改密钥）时，若需采用
安全报文传送，必须置CLA 的后半字节为十六进制’4’。

**11.3. MAC** 的计算的计算的计算的计算

MAC 是使用命令的所有元素（包括命令头）产生的。MAC 是命令数据域中最后一个
数据元，它的长度为 4 个字节。

```
MAC 的计算步骤如下：
```

####  终端向IC 卡发出一个GET CHALLENGE 命令，从IC 卡取回 4 字节随机数。

####  将IC 卡回送的 4 字节随机数后缀以’00 00 00 00’，所得到的结果作为初始值。

####  按照顺序将以下数据连接在一起形成数据块：

```
CLA ，INS ，P1，P2 ，Lc+4，DATA
必须置CLA 的后半字节为十六进制’ 4 ’。
在命令的数据域中（如果存在）包含明文或加密的数据。
（例: 如果要进行线路加密保护，加密后的数据块放在命令数据域中传输）
```
 将该数据块分成 8 字节为单位的数据块，标号为D1，D2，D3 等。最后的数据块有可
能是1-8个字节。

 如果最后的数据块长度是 8 字节的话，也必须在其后加上 16 进制数字’80 00 00 00 00
00 00 00’，转到第六步。
如果最后的数据块长度不足 8 字节，则在其后加上 16 进制数字’ 80 ’，如果达到 8 字
节长度，则转入第六步；否则在其后加上 16 进制数字’ 00 ’直到长度达到 8 字节为止。

 对这些数据块使用相应密钥进行加密。（密钥由FMCOS 命令或中国金融IC 卡专用命
令所指定）
如果该密钥长度为 8 字节，则依照图 1 的方式来产生MAC （根据在第三步中产生的
数据块长度的不同，有可能在计算中会多于或少于三步）。
如果该密钥长度为 16 字节，则依照图 2 的方式来产生MAC （根据在第三步中产生的
数据块长度的不同，有可能在计算中会多于或少于三步）。

 最终得到是从计算结果左侧取得的 4 字节长度的MAC 。

#### 图图图图 9-1 用长度为用长度为用长度为用长度为 8 字节的密钥产生字节的密钥产生字节的密钥产生字节的密钥产生 MAC 的算法的算法的算法的算法


#### 图图图图 9-2 用长度为用长度为用长度为用长度为 16 字节的密钥产生字节的密钥产生字节的密钥产生字节的密钥产生 MAC 的算法的算法的算法的算法

**11.4.** 数据加密数据加密数据加密数据加密 **/** 解密的计算解密的计算解密的计算解密的计算

### 11.4.1. 数据加密计算...................................................................................................................

#### 数据加密计算步骤如下：

####  用LD 表示明文数据的长度，在明文数据前加上LD 产生新的数据块。

####  将第一步中生成的数据块分解成 8 字节数据块，标号为D1，D2，D3，D4 等等。最后

#### 一个数据块长度有可能不足 8 位。

####  如果最后（或唯一）的数据块长度等于 8 字节，转入第四步；如果不足 8 字节，在右

#### 边添加 16 进制数字’80’。如果长度已达 8 字节，转入第四步；否则，在其右边添加 16

#### 进制数字’00’直到长度达到 8 字节。

####  对每一个数据块使用相应密钥进行加密。（密钥由FMCOS 命令或中国金融IC 卡专用

#### 命令所指定）

#### 如果该密钥长度为 8 字节，则依照图9-1的方式来加密数据块；

#### 如果该密钥长度为 16 字节，则依照图9-2的方式来加密数据块。

####  计算结束后，所有加密后的数据块依照原顺序连接在一起（加密后的D1，加密后的

#### D2，等等）。并将结果数据块插入到命令数据域。


#### 图图图图 9-3 用长度为用长度为用长度为用长度为 8 字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法

#### 图图图图 9-4 用长度为用长度为用长度为用长度为 16 字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法

### 11.4.2. 数据解密计算...................................................................................................................

#### 数据解密计算步骤如下：

####  将命令数据域块分解成 8 字节长的数据块，标号为D1，D2，D3，D4 等等。

####  对每一个数据块使用与数据加密相同的密钥进行解密。（密钥由FMCOS 命令或中国

#### 金融IC 卡专用命令所指定）

#### 如果该密钥长度为 8 字节，则依照图 3 的方式来解密数据块。

#### 如果该密钥长度为 16 字节，则依照图 4 的方式来解密数据块。

####  计算结束后，所有解密后的数据块依照顺序（解密后的D1，解密后的D2，等等）链

#### 接在一起。数据块由LD 、明文数据、填充字符组成。

####  因为LD 表示明文数据长度，因此，它被用来恢复明文数据。

#### 图图图图 9-5 用长度为用长度为用长度为用长度为 8 字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法


#### 图图图图 9-6 用长度为用长度为用长度为用长度为 16 字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法字节的密钥进行数据加密的算法

**11.5.** 安全报文传安全报文传安全报文传安全报文传送的命令情况送的命令情况送的命令情况送的命令情况

 CASE1：这种情况时，没有数据送到卡（Lc）中，也没有数据从卡中返回（Le）。

没有安全报文传送要求的命令情况如下：
CLA INS P1 P2
有安全报文传送要求的命令情况如下：
CLA INS P1 P2 Lc MAC
CLA 的低半字节是’4’表明支持第二种情况的安全报文传送技术。Lc 为MAC 的长度。
 CASE2：这种情况时，命令中没有数据送到卡中，但有数据从卡中返回。

```
没有安全报文传送要求的命令情况如下：
CLA INS P1 P2 Le
有安全报文传送要求的命令情况如下：
CLA INS P1 P2 Lc MAC Le
CLA 的低半字节是’4’表明支持第二种情况的安全报文传送技术。Lc 为MAC 的长度。
```
 CASE3: 这种情况时，命令中有数据传送到卡中，但没有数据从卡中返回。

```
没有安全报文传送要求的命令情况如下：
CLA INS P1 P2 Lc 命令数据
有安全报文传送要求的命令情况如下：
CLA INS P1 P2 Lc 命令数据 MAC
CLA 的低半字节是’4’表明支持第二种情况的安全报文传送技术。Lc 为MAC 的长度。
```
 CASE4: 这种情况时，在命令中有数据送到卡中，也有数据从卡中返回。

```
没有安全报文传送要求的命令情况如下：
CLA INS P1 P2 Lc 命令数据 Le
有安全报文传送要求的命令情况如下：
CLA INS P1 P2 Lc 命令数据 MAC Le
CLA 的低半字节是’4’表明支持第二种情况的安全报文传送技术。Lc 为MAC 的长度。
```

## 附录附录附录附录 A. 电子存折电子存折电子存折电子存折 / 电子钱包应用的基本数据文件电子钱包应用的基本数据文件电子钱包应用的基本数据文件电子钱包应用的基本数据文件 ..............................................

#### 表表表表 A-1 电子存折和电子钱包应用的公电子存折和电子钱包应用的公电子存折和电子钱包应用的公电子存折和电子钱包应用的公共应用基本数据文件共应用基本数据文件共应用基本数据文件共应用基本数据文件

#### 文件标识符文件标识符文件标识符文件标识符 ‘ 0015 ’

#### 文件类型文件类型文件类型文件类型 ‘A8’（线路保护的二进制文件）

#### 文件主体空间文件主体空间文件主体空间文件主体空间 ‘1E ’

#### 读权限读权限读权限读权限 ‘F0’（自由读取）

#### 写权限写权限写权限写权限

#### ‘F0’（写二进制时必须使用DAMK 进行线路保护，如连续三次

#### 执行此命令失败，IC 卡回送‘ 9303 ’即应用永久锁定）

#### 字节字节字节字节 数据元数据元数据元数据元 长度长度长度长度

#### 1-8 发卡方标识 8

#### 9 应用类型标识 1

#### 10 应用版本 1

#### 11-20 应用序列号 10

#### 21-24 应用启动日期 4

#### 25-28 应用有效日期 4

#### 29-30 发卡方自定义文件控制信息数据 2

#### 表表表表 A-2 电子存折和电子钱包应用的持卡人基本数据文件电子存折和电子钱包应用的持卡人基本数据文件电子存折和电子钱包应用的持卡人基本数据文件电子存折和电子钱包应用的持卡人基本数据文件

#### 文件标识符文件标识符文件标识符文件标识符 ‘ 0016 ’

#### 文件类型文件类型文件类型文件类型 ‘A8’（线路保护的二进制文件）

#### 文件主体空间文件主体空间文件主体空间文件主体空间 ‘ 27 ’

#### 读权限读权限读权限读权限 ‘F0’（自由读取）

#### 写权限写权限写权限写权限

#### ‘F0’（写二进制时必须使用DAMK 进行线路保护，如连续三次

#### 执行此命令失败，IC 卡回送‘ 9303 ’即应用永久锁定）

#### 字节字节字节字节 数据元数据元数据元数据元 长度长度长度长度

#### 1 卡类型标识 1

#### 2 本行职工标识 1

#### 3-22 持卡人姓名 20

#### 23-38 持卡人证件号码 16

#### 39 持卡人证件类型 1


#### 表表表表 A-3 电子存折和电子存折和电子存折和电子存折和电子钱包应用的交易明细文件电子钱包应用的交易明细文件电子钱包应用的交易明细文件电子钱包应用的交易明细文件

#### 文件标识符 ‘ 0018 ’

#### 文件类型 ‘2E ’（循环文件）

#### 记录个数 ‘0A ’（该循环文件必须能够容纳至少十条消费、

#### 取现、圈存、圈提交易 记录）

#### 记录长度 ‘ 17 ’

#### 读权限 ‘F1’（必须先验证口令）

#### 写权限 ‘EF ’（交易明细由IC 卡维护，不允许外部对其修改）

#### 字节 数据元 长度

#### 1-2 电子存折/电子钱包联机或脱机交易序号 2

#### 3-5 透支限额 3

#### 6-9 交易金额 4

#### 10 交易类型标识 1

#### 11-16 终端机编号 6

#### 17-20 交易日期 4

#### 21-23 交易时间 3


## 附录附录附录附录 B. 术语和定义术语和定义术语和定义术语和定义 ...............................................................................................

 终端 Terminal
为完成卡片操作而安装的设备，用于同IC 卡的连接。它包括接口设备，也可包括其它
部件和接口，例如与主机通讯的接口。
 命令 Command
终端向IC 卡发出的一条信息，该信息启动一个操作或请求一个应答。
 触点 Contact
在集成电路卡和外部接口设备之间保持电流连续性的导电元件。
 响应 Response
IC 卡处理完成收到的命令报文后，返回给终端的报文。
 集成电路 Integrated Circuit（IC ）
设计用于完成处理和/或存储功能的电子器件。
 集成电路（IC 卡）Integrated Circuit（s） Card
内部封装一个或多个集成电路的ID - 1 型卡。
 报文 Message
由终端向卡或卡向终端发出的，不含传输控制字符的字节串。
 报文鉴别代码 Message Authentiction Code
对交易数据及其相关参数进行运算后产生的代码。主要用于验证报文的完整性。
 半字节 Nibble
一个字节的高四位或低四位。
 明文 Plaintext
没有加密的信息。
 密文 Ciphertext
通过密码系统产生的不可理解的文字或信号。
密钥 Key
控制加密转换操作的符号序列。
 加密算法 Cryptographic Algorithm
为了隐藏或揭露信息内容而变换数据的算法。
 安全状态及安全状态寄存器
安全状态是指卡在当前所处的一种安全级别。FMCOS 的根目录和应用目录分别具有
16 种不同的安全状态。FMCOS 在卡内部用两个 4 位寄存器来表示安全状态：一个寄
存器称为MF 的安全状态寄存器，它表示整个卡所处的安全级别；另一个寄存器为当
前目录的安全状态寄存器，每个寄存器的值可以是 0 至F之间的某一值。
 安全属性
安全属性是指对某个文件进行某种操作时所必须满足的条件，也就是在进行某种操作
时要求安全状态寄存器的值是什么。
 数据完整性 Data Integrity
数据不受未经许可的方法变更或破坏的属性。
 密钥文件 Key File
密钥文件必须在MF/DF 下最先被建立，且一个目录只能有一个密钥文件，密钥文件可
存多个口令密钥、外部认证密钥、DES 运算密钥，每个密钥为一条TLV 格式的记录。
 文件标识符 File Identifier
文件标识符是文件的标识代码，用 2 个字节来表示，在选择文件时只要指出该文件的


#### 标识代码，FMCOS 就可以找到相应文件，同一目录下的文件标识符必须是唯一的。

#### MF 的文件标识符是3F00，文件名为1PAY.SYS.DDF01。

 电子存折 Electronic Deposit
一种为持卡人进行消费、取现等交易而设计的使用口令密钥（PIN ）保护的金融IC 卡
应用。它支持圈存、圈提、消费、取现等交易。
 电子钱包 Electronic Purse
一种为方便持卡人小额消费而设计的金融IC 卡应用。它支持圈存、消费以及查询余额
交易。除圈存交易外，使用电子钱包进行的任何交易均不记录交易明细，且无需验证
口令（PIN ）。
 圈存 Load
持卡人将其在银行相应帐户上的资金划转到电子存折或电子钱包中。圈存交易必须在
金融终端上联机进行。
一般情况下，圈存到电子存折中的资金计付活期利息，圈存到电子钱包中的资金不计
付利息。但具体作法由发卡方自行决定。
 圈提 Unload
持卡人将电子存折中的部分或全部资金划回到其在银行的相应帐户上。圈提交易必须
在金融终端上联机进行。
 消费 Purchase
消费交易允许持卡人使用电子存折或电子钱包的余额进行购物或获取服务。此交易可
以在销售点终端（POS ）上脱机进行。使用电子存折进行的消费交易必须提交个人密
码（PIN ），使用电子钱包则不需要。
 取现 Cash Withdraw
取现交易允许持卡人从电子存折中提取现金。此交易必须在金融终端上进行，但可以
脱机处理。只有电子存折应用支持此交易，且必须提交个人密码PIN 。
 透支限额 Overdraw Limit
“透支功能”是一种基于电子存折应用的有限信用功能。当电子存折中的实际金额不
足时，它为持卡人提供了一种在发卡方所允许的透支额度内继续进行交易的方便性。
修改透支限额交易必须在金融终端上联机进行，且必须提交个人密码PIN 。


## 附录附录附录附录 C. 协议说明书协议说明书协议说明书协议说明书 ...............................................................................................

#### 本附录给出了一些无差错操作和差错处理的设定。

**C.1.** 记法记法记法记法

任何块 ＝＝＝＞ 正确接受到
任何块 ＝≠＝＞ 错误接受到
任何块 ＝ ＝＞ 没有接受到（FWT 超时）
分界线 ———— 最小协议操作的结束
I(1)x 带链接位设置和块号x的I-块
I(0)x 链接位未设置（链接中的最后块）的带块号x的I-块
R(ACK)x 指示正确的R-块
R(NAK)x 指示错误的R-块
S(...) S-块
对目标PICC ，设定中的块号都以PCD 的当前块号开始。为便于表述，PICC 激活序列
后设定才开始，因此当前块号对PCD 来说以 0 开始，对PICC 来说以 1 开始。

**C.2.** 无差错操作无差错操作无差错操作无差错操作

### C.2.1. 块的交换............................................................................................................................

### 设定设定设定设定 1. I- 块交换块交换块交换块交换

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D

#### 2 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10

#### 3 、 I(0) 1 ＝＝＝＞ 1 规则D

#### 4 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10

### C.2.2. 等待时间扩展请求............................................................................................................

### 设定设定设定设定 2. 等待时间扩展等待时间扩展等待时间扩展等待时间扩展

注释注释注释注释 (^) 块号块号块号块号（（（（ **0** ）））） **PCD PICC** 块号块号块号块号（（（（ **I** ）））） 注释注释注释注释
1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D
2 、 ＜＝＝＝ S(WTX)请求 规则 9
3 、 规则 3 S(WTX)响应 ＝＝＝＞ 1
4 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10
5 、 I(0) 1 ＝＝＝＞ 规则D
6 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10


### C.2.3. DESELECT

### 设定设定设定设定 3. DESELECT

注释注释注释注释 (^) 块号块号块号块号（（（（ **0** ）））） **PCD PICC** 块号块号块号块号（（（（ **I** ）））） 注释注释注释注释
1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D
2 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10
3 、 S(DESELECT)请求 ＝＝＝＞
4 、 ＜＝＝＝ S(DESELECT)响应 规则 3

### C.2.4. 链接....................................................................................................................................

### 设定设定设定设定 4. PCD 使用链接使用链接使用链接使用链接

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(1) 0 ＝＝＝＞ 0 规则D

#### 2 、 规则B 1 ＜＝＝＝ R(ACK) 0 规则 2

#### 3 、 规则 7 I(0) 1 ＝＝＝＞ 1 规则D

#### 4 、 规则B 0 ＜＝＝＝ I(0) 0 规则 10

#### 5 、 I(0) 0 ＝＝＝＞ 0 规则D

#### 6 、 规则B 1 ＜＝＝＝ I(0) 1 规则 10

### 设定设定设定设定 5. PICC 使用链接使用链接使用链接使用链接

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D

#### 2 、 规则B 1 ＜＝＝＝ I(1) 0 规则 10

#### 3 、 规则 2 R(ACK) 1 ＝＝＝＞ 1 规则E

#### 4 、 规则B 0 ＜＝＝＝ I(0) 1 规则 13

#### 5 、 I(0) 0 ＝＝＝＞ 0 规则D

#### 6 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10


**C.3.** 差错处理差错处理差错处理差错处理

### C.3.1. 块的交换............................................................................................................................

### 设定设定设定设定 6. 协议开始协议开始协议开始协议开始

注释注释注释注释 (^) 块号块号块号块号（（（（ **0** ）））） **PCD PICC** 块号块号块号块号（（（（ **I** ）））） 注释注释注释注释
1 、 规则 1 I(0) 0 ＝≠＝＞
2 、 超时 ＜＝ ＝ -
3 、 规则 4 R(NAK) 0 ＝＝＝＞
4 、 无变化 ＜＝＝＝ R(ACK) 1 规则 12
5 、 规则 6 I(0) 0 ＝＝＝＞ 0 规则D
6 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10
7 、 I(0) 1 ＝＝＝＞ 1 规则D
8 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10

### 设定设定设定设定 7. I- 块交换块交换块交换块交换

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D

#### 2 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10

#### 3 、 I(0) 1 ＝≠＝＞

#### 4 、 超时 ＜＝ ＝ -

#### 5 、 规则 4 R(NAK) 1 ＝＝＝＞

#### 6 、 无变化 ＜＝＝＝ R(ACK) 0 规则 12

#### 7 、 规则 6 I(0) 1 ＝＝＝＞ 1 规则D

#### 8 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10

#### 9 、 I(0) 0 ＝＝＝＞ 0 规则D

#### 10 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10

### 设定设定设定设定 8. I- 块交换块交换块交换块交换

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D

#### 2 、 ＜＝≠＝ I(0) 0 规则 10

#### 3 、 规则 4 R(NAK) 0 ＝＝＝＞

#### 4 、 规则B 1 ＜＝＝＝ I(0) 0 规则 11

#### 5 、 I(0) 1 ＝＝＝＞ 1 规则D

#### 6 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10


### 设定设定设定设定 9. I- 块交换块交换块交换块交换

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D

#### 2 、 ＜＝≠＝ I(0) 0 规则 10

#### 3 、 规则 4 R(NAK) 0 ＝≠＝＞

#### 4 、 超时 ＜＝ ＝ -

#### 5 、 规则 4 R(NAK) 0 ＝＝＝＞

#### 6 、 规则B 1 ＜＝＝＝ I(0) 0 规则 11

#### 7 、 I(0) 1 ＝＝＝＞ 1 规则D

#### 8 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10

### C.3.2. 等待时间扩展请求............................................................................................................

### 设定设定设定设定 10. 等待时间扩展请求等待时间扩展请求等待时间扩展请求等待时间扩展请求

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D

#### 2 、 ＜＝≠＝ S(WTX)请求 规则 9

#### 3 、 规则 4 R(NAK) 0 ＝＝＝＞

#### 4 、 ＜＝＝＝ S(WTX)请求 规则 11

#### 5 、 规则 3 S(WTX)响应 ＝＝＝＞

#### 6 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10

#### 7 、 I(0) 1 ＝＝＝＞ 1 规则D

#### 8 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10

### 设定设定设定设定 11. 等待时间扩展请求等待时间扩展请求等待时间扩展请求等待时间扩展请求

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D

#### 2 、 ＜＝≠＝ S(WTX)请求 规则 9

#### 3 、 规则 4 R(NAK) 0 ＝≠＝＞

#### 4 、 超时 ＜＝ ＝ -

#### 5 、 规则 4 R(NAK) 0 ＝＝＝＞

#### 6 、 ＜＝＝＝ S(WTX)请求 规则 11

#### 7 、 规则 3 S(WTX)响应 ＝＝＝＞

#### 8 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10

#### 9 、 I(0) 1 ＝＝＝＞ 1 规则D

#### 10 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10


### 设定设定设定设定 12. 等待时间扩展请求等待时间扩展请求等待时间扩展请求等待时间扩展请求

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D

#### 2 、 ＜＝＝＝ S(WTX)请求 规则 9

#### 3 、 规则 3 S(WTX)响应 ＝≠＝＞

#### 4 、 超时 ＜＝ ＝ -

#### 5 、 规则 4 R(NAK) 0 ＝＝＝＞

#### 6 、 ＜＝＝＝ S(WTX)请求 规则 11

#### 7 、 规则 3 S(WTX)响应 ＝＝＝＞

#### 8 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10

#### 9 、 I(0) 1 ＝＝＝＞ 1 规则D

#### 10 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10

### 设定设定设定设定 13. 等待时间扩展请求等待时间扩展请求等待时间扩展请求等待时间扩展请求

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D

#### 2 、 ＜＝＝＝ S(WTX)请求 规则 9

#### 3 、 规则 3 S(WTX)响应 ＝＝＝＞

#### 4 、 ＜＝≠＝ I(0) 0 规则 10

#### 5 、 规则 4 R(NAK) 0 ＝＝＝＞

#### 6 、 规则B 1 ＜＝＝＝ I(0) 0 规则 11

#### 7 、 I(0) 1 ＝＝＝＞ 1 规则D

#### 8 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10

### 设定设定设定设定 14. 等待时间扩展请求等待时间扩展请求等待时间扩展请求等待时间扩展请求

注释注释注释注释 (^) 块号块号块号块号（（（（ **0** ）））） **PCD PICC** 块号块号块号块号（（（（ **I** ）））） 注释注释注释注释
1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D
2 、 ＜＝＝＝ S(WTX)请求 规则 9
3 、 规则 3 S(WTX)响应 ＝＝＝＞
4 、 ＜＝≠＝ I(0) 0 规则 10
5 、 规则 4 R(NAK) 0 ＝≠＝＞
6 、 超时 ＜＝ ＝ -
7 、 规则 4 R(NAK) 0 ＝＝＝＞
8 、 规则B 1 ＜＝＝＝ I(0) 0 规则 11
9 、 I(0) 1 ＝＝＝＞ 1 规则D
10 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10


### C.3.3. DESELECT

### 设定设定设定设定 15. DESELECT

注释注释注释注释 (^) 块号块号块号块号（（（（ **0** ）））） **PCD PICC** 块号块号块号块号（（（（ **I** ）））） 注释注释注释注释
1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D
2 、 规则B ＜＝＝＝ I(0) 0 规则 10
3 、 S(DESELECT)请求 ＝≠＝＞
4 、 超时 ＜＝ ＝ -
5 、 规则 8 S(DESELECT)请求 ＝＝＝＞
6 、 ＜＝＝＝ S(DESELECT)响应 规则 3

### C.3.4. 链接....................................................................................................................................

### 设定设定设定设定 16. PCD 使用链接使用链接使用链接使用链接

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(0) 0 ＝＝＝＞ 0 规则D

#### 2 、 ＜＝≠＝ R(ACK) 0 规则 2

#### 3 、 规则 4 R(NAK) 0^ ＝＝＝＞

#### 4 、 规则B 1 ＜＝＝＝ R(ACK) 0 规则 11

#### 5 、 规则 7 I(1) 1 ＝＝＝＞ 1 规则D

#### 6 、 规则B 0 ＜＝＝＝ R(ACK) 1 规则 2

#### 7 、 规则 7 I(0) 0 ＝＝＝＞ 0 规则D

#### 8 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10

#### 9 、 I(0) 1 ＝＝＝＞ 1 规则D

#### 10 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10

### 设定设定设定设定 17. PCD 使用链接使用链接使用链接使用链接

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(1) 0 ＝＝＝＞ 0 规则D

#### 2 、 规则B 1 ＜＝＝＝ R(ACK) 0 规则 2

#### 3 、 规则 7 I(1) 1 ＝≠＝＞

#### 4 、 超时 ＜＝ ＝ -

#### 5 、 规则 4 R(NAK) 1 ＝＝＝＞

#### 6 、 无变化 ＜＝＝＝ R(ACK) 0 规则 12

#### 7 、 规则 6 I(1 1 ＝＝＝＞ 1 规则D

#### 8 、 规则B 0 ＜＝＝＝ R(ACK) 1 规则 2

#### 9 、 规则 7 I(0) 0 ＝＝＝＞ 0 规则D

#### 10 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10

#### 11 、 I(0) 1 ＝＝＝＞ 1 规则D

#### 12 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10


### 设定设定设定设定 18. PCD 使用链接使用链接使用链接使用链接

#### 注释注释注释注释 块号块号块号块号（（（（ 0 ）））） PCD PICC 块号块号块号块号（（（（ I ）））） 注释注释注释注释

#### 1 、 规则 1 I(1) 0 ＝＝＝＞ 0 规则D

#### 2 、 ＜＝≠＝ R(ACK) 0 规则 2

#### 3 、 规则 4 R(NAK) 0 ＝≠＝＞

#### 4 、 超时 ＜＝ ＝ -

#### 5 、 规则 4 R(NAK) 0 ＝＝＝＞

#### 6 、 规则B 1 ＜＝＝＝ R(ACK) 0 规则 11

#### 7 、 规则 7 I(1) 1 ＝＝＝＞ 1 规则D

#### 8 、 规则B 0 ＜＝＝＝ R(ACK) 1 规则 2

#### 9 、 规则 7 I(0) 0 ＝＝＝＞ 0 规则D

#### 10 、 规则B 1 ＜＝＝＝ I(0) 0 规则 10

#### 11 、 I(0) 1 ＝＝＝＞ 1 规则D

#### 12 、 规则B 0 ＜＝＝＝ I(0) 1 规则 10


